{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <!-- Основной контент -->
        <div class="order-form__layout">
            <div class="order-form__main">
                <!-- Информация о тарифе -->
                <section class="tariff-info">
                    <div class="tariff-info__content">
                        <div class="tariff-info__details">
                            <h3 class="tariff-info__title">{{ tariff.name }}</h3>
                            {% if tariff.description %}
                            <p class="tariff-info__description">{{ tariff.description|safe }}</p>
                            {% endif %}
                            <div class="tariff-info__included">
                                <h4 class="tariff-info__included-title">В тариф включено:</h4>
                                <div class="tariff-info__badges">
                                    {% if tariff.speed %}
                                        <span class="tariff-info__badge tariff-info__badge--speed">
                                            <i class="bi bi-wifi"></i>
                                            Скорость: {{ tariff.speed }} Мбит/с
                                        </span>
                                    {% endif %}
                                    {% if tariff.total_channels %}
                                        <span class="tariff-info__badge tariff-info__badge--tv">
                                            <i class="bi bi-tv"></i>
                                            {{ tariff.total_channels }} ТВ-каналов
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="tariff-info__price">
                            <div class="tariff-info__price-value">{{ tariff.get_actual_price }} ₽</div>
                            <small class="tariff-info__price-unit">
                                в месяц
                                {% if tariff.is_promo and tariff.promo_price and tariff.promo_months %}
                                    (акция на {{ tariff.promo_months }} мес.)
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </section>
                
                <!-- Пакеты ТВ-каналов -->
                {% if tv_packages.exists %}
                <div class="tab-pane fade show active" id="tv-packages" role="tabpanel">
                    <h3 class="tv-packages__title">Добавить пакеты каналов</h3>
                    <p class="tv-packages__description">Добавьте расширенные пакеты каналов к вашему телевидению.</p>
                    <div class="tv-packages__list">
                        {% for package in tv_packages %}
                            <article class="tv-package">
                                <div class="tv-package__content">
                                    <div class="tv-package__header">
                                        <!-- Левая часть: изображение и информация -->
                                        <div class="tv-package__content-left">
                                            <!-- Изображение -->
                                            <div class="tv-package__image-container">
                                                {% if package.image %}
                                                    <img src="{{ package.image.url }}" alt="Изображение пакета {{ package.name }}" class="tv-package__image">
                                                {% else %}
                                                    <div class="tv-package__image-placeholder" aria-hidden="true">
                                                        <span>Нет изображения</span>
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <!-- Текст: название и мета -->
                                            <div class="tv-package__info">
                                                <h5 class="tv-package__name">{{ package.name }}</h5>
                                                <div class="tv-package__meta">
                                                    <div class="tv-package__channels">
                                                        {{ package.total_channels }} каналов
                                                    </div>
                                                    <a href="#"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#channelsModal-package-{{ package.id }}"
                                                    class="tv-package__channels-link"
                                                    aria-label="Посмотреть каналы пакета {{ package.name }}">
                                                        Список каналов
                                                    </a>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Правая часть: свитчер -->
                                        <div class="tv-package__switch-container">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input" type="checkbox"
                                                    id="package-{{ package.id }}"
                                                    onclick="updateTVPackage('{{ package.id }}', {{ package.price }})">
                                                <label class="tv-package__label" for="package-{{ package.id }}"></label>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="tv-package__description">{{ package.description|safe }}</p>
                                </div>
                                <div class="tv-package__footer">
                                    <div class="tv-package__price">{{ package.price }} руб./мес.</div>
                                </div>
                            </article>
                            {% include 'core/partials/channels_modal.html' with object=package channels=package.channels.all modal_type="package" %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Оборудование -->
                {% if products.exists %}
                <section class="equipment">
                    <h3 class="equipment__title">Добавить оборудование</h3>
                    <p class="equipment__description">Оборудование приобретается при подключении и не входит в абонентскую плату.</p>
                    <div class="equipment__list">
                        {% for product in products %}
                            <article class="equipment__item" data-id="{{ product.id }}" data-price="{{ product.price }}">
                                <div class="equipment__content">
                                    <div class="equipment__header">
                                        <!-- Изображение -->
                                        <div class="equipment__image-container">
                                            {% if product.get_main_image %}
                                                <img src="{{ product.get_main_image.image.url }}" alt="{{ product.name }}" class="equipment__image">
                                            {% else %}
                                                <div class="equipment__image-placeholder" aria-hidden="true">
                                                    <svg class="equipment__image-icon" width="48" height="28" viewBox="0 0 48 28" fill="currentColor">
                                                        <rect x="2" y="2" width="44" height="24" rx="4" fill="#e5e7eb"/>
                                                        <path d="M8 10h8v8H8zm14 0h8v8h-8zm14 0h8v8h-8z" fill="#9ca3af"/>
                                                    </svg>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Информация -->
                                        <div class="equipment__info-group">
                                            {% if product.category %}
                                                <div class="equipment__category">{{ product.category.name }}</div>
                                            {% endif %}
                                            <h5 class="equipment__name">{{ product.name }}</h5>
                                        </div>

                                        <!-- Новый блок: нижняя панель (цена + свитчер) -->
                                        <div class="equipment__footer">
                                            <div class="equipment__price-block" onclick="openInstallmentModal('{{ product.id }}')">
                                                <div class="equipment__payment-label" id="label-{{ product.id }}">Покупка</div>
                                                <div class="equipment__price-value" id="price-{{ product.id }}">{{ product.price }} руб.</div>
                                            </div>
                                            <div class="equipment__switch-container">
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input"
                                                        type="checkbox"
                                                        id="equipment-{{ product.id }}"
                                                        onchange="toggleEquipmentSelection('{{ product.id }}', this.checked, {{ product.price }})">
                                                    <label class="form-check-label" for="equipment-{{ product.id }}"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <!-- Дополнительные услуги -->
                {% if services.exists %}
                <section class="services">
                    <h3 class="services__title">Дополнительные услуги</h3>
                    <p class="services__description">Выберите дополнительные услуги, которые будут подключены вместе с вашим тарифом.</p>
                    <div class="services__list">
                        {% for service in services %}
                            <article class="services__item">
                                <div class="services__content">
                                    <div class="services__header">
                                        <div class="services__switch">
                                            <input class="services__checkbox" type="checkbox" id="{{ service.slug }}"
                                                   onclick="updateService('{{ service.slug }}', {{ service.price }})">
                                            <label class="services__label" for="{{ service.slug }}">
                                                <h5 class="services__name">{{ service.name }}</h5>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="services__description">{{ service.description|safe }}</p>
                                    <div class="services__footer">
                                        <div class="services__price">{{ service.price }} руб./мес.</div>
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <!-- Место для вставки блока "Итоговая стоимость" на мобильных -->
                <div class="order-form__mobile-summary" id="mobileSummaryTarget"></div>

                <!-- Форма заявки -->
                <section class="order-form__section">
                    <h3 class="order-form__section-title">Оформление заявки</h3>
                    <noscript>
                        <div class="alert alert-danger">Для корректной работы формы требуется включённый JavaScript.</div>
                    </noscript>
                    <form class="order-form__form" id="orderForm" method="post" action="{% url 'orders:submit_order' locality_slug=locality.slug %}">
                        {% csrf_token %}
                        <!-- Скрытые поля -->
                        <input type="hidden" name="tariff_id" value="{{ tariff.id }}">
                        <input type="hidden" name="selected_equipment_ids" id="selected_equipment_ids" value="[]">
                        <input type="hidden" name="selected_service_slugs" id="selected_service_slugs" value="[]">
                        <input type="hidden" name="selected_tv_package_ids" id="selected_tv_package_ids" value="[]">
                        <input type="hidden" id="total_equipment_cost" value="0">
                        <input type="hidden" id="total_services_cost" value="0">
                        <input type="hidden" id="total_tv_packages_cost" value="0">
                        <input type="hidden" id="total_price" value="0">

                        <!-- Основные поля формы -->
                        <div class="order-form__fields">
                            <!-- Первый ряд: Имя, Номер телефона -->
                            <div class="order-form__field order-form__field--full-name">
                                <label for="name" class="order-form__label">Ваше имя</label>
                                <input type="text" name="full_name" class="order-form__input" id="name" required placeholder="Введите ваше имя">
                                <div id="error_full_name" class="order-form__validation-message"></div>
                            </div>
                            <div class="order-form__field order-form__field--phone">
                                <label for="phone" class="order-form__label">Номер телефона</label>
                                <input type="tel" name="phone" class="order-form__input" id="phone" required placeholder="+7 (___) ___-__-__">
                                <div id="error_phone" class="order-form__validation-message"></div>
                            </div>
                            <!-- Второй ряд: Улица, Дом, Квартира -->
                            <div class="order-form__row--address">
                                <div class="order-form__field order-form__field--street">
                                    <label for="street" class="order-form__label">Улица</label>
                                    <input type="text" name="street" class="order-form__input" id="street" placeholder="Введите улицу">
                                    <div id="error_street" class="order-form__validation-message"></div>
                                </div>
                                <div class="order-form__field order-form__field--house">
                                    <label for="house" class="order-form__label">Дом</label>
                                    <input type="text" name="house" class="order-form__input" id="house" placeholder="Введите номер дома">
                                    <div id="error_house" class="order-form__validation-message"></div>
                                </div>
                                <div class="order-form__field order-form__field--apartment">
                                    <label for="apartment" class="order-form__label">Квартира</label>
                                    <input type="text" name="apartment" class="order-form__input" id="apartment" placeholder="Введите номер квартиры">
                                    <div id="error_apartment" class="order-form__validation-message"></div>
                                </div>
                            </div>
                            <!-- Третий ряд: Комментарий -->
                            <div class="order-form__field order-form__field--comments">
                                <label for="comments" class="order-form__label">Комментарий (необязательно)</label>
                                <textarea name="comment" class="order-form__textarea" id="comments" rows="2" placeholder="Введите ваш комментарий"></textarea>
                                <div id="error_comment" class="order-form__validation-message"></div>
                            </div>
                            <!-- Четвёртый ряд: Чекбокс слева, Кнопка справа -->
                            <div class="order-form__field order-form__field--actions">
                                <div class="order-form__checkbox-wrapper">
                                    <input class="order-form__checkbox" type="checkbox" id="agree" required aria-label="Согласие с обработкой персональных данных">
                                    <label class="order-form__checkbox-label" for="agree">
                                        Я согласен с  
                                        <a 
                                            target="_blank" 
                                            class="order-form__link" 
                                            href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}"
                                            rel="noopener noreferrer"
                                        >
                                            Политикой конфиденциальности
                                        </a>
                                         и разрешаю обработку персональных данных
                                    </label>
                                </div>
                                <button type="submit" class="order-form__submit" aria-label="Отправить заявку на подключение">Отправить заявку</button>
                            </div>
                        </div>
                    </form>
                </section>
            </div>

            <!-- Итоговая стоимость -->
            <aside class="summary" id="summaryCardContainer">
                <div class="summary__content">
                    <h3 class="summary__title">Заявка на подключение</h3>
                    <div class="summary__section">
                        <h5 class="summary__section-title">Тариф</h5>
                        <div class="summary__item">
                            <span class="summary__item-name">{{ tariff.name }}</span>
                            <span class="summary__item-value">
                                {{ tariff.get_actual_price }} руб./мес.
                                {% if tariff.is_promo and tariff.promo_price and tariff.promo_months %}
                                    (акция на {{ tariff.promo_months }} мес.)
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% if products.exists %}
                    <div class="summary__section" id="equipmentSummary">
                        <h5 class="summary__section-title">Оборудование</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    {% endif %}
                    {% if services.exists %}
                    <div class="summary__section" id="servicesSummary">
                        <h5 class="summary__section-title">Дополнительные услуги</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    {% endif %}
                    {% if tv_packages.exists %}
                    <div class="summary__section" id="tvPackagesSummary">
                        <h5 class="summary__section-title">Пакеты ТВ</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    {% endif %}
                    <div class="summary__section">
                        <h5 class="summary__section-title">Подключение</h5>
                        <div class="summary__item">
                            <span class="summary__item-name">Разово</span>
                            <span class="summary__item-value" id="connectionPrice">{{ tariff.connection_price }} руб.</span>
                        </div>
                    </div>
                    <hr class="summary__divider">
                    <div class="summary__total">
                        <h5 class="summary__total-title">Итого к оплате:</h5>
                        <h5 class="summary__total-value" id="totalPrice">{{ tariff.get_actual_price|add:tariff.connection_price }} руб.</h5>
                    </div>
                    <div class="summary__breakdown">
                        <div class="summary__breakdown-item">
                            <span class="summary__breakdown-name">Из них:</span>
                        </div>
                        <div class="summary__breakdown-item">
                            <span class="summary__breakdown-name">Абонентская плата:</span>
                            <span class="summary__breakdown-value" id="monthlyPrice">{{ tariff.get_actual_price }} руб./мес.</span>
                        </div>
                        <div class="summary__breakdown-item">
                            <span class="summary__breakdown-name">При подключении:</span>
                            <span class="summary__breakdown-value" id="connectionTotalPrice">{{ tariff.connection_price }} руб.</span>
                        </div>
                    </div>
                    <div class="summary__info">
                        <small>Абонентская плата начнет взиматься с момента активации тарифа. Оборудование и подключение оплачиваются единоразово при подключении.</small>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script src="https://unpkg.com/imask@7/dist/imask.min.js"></script>
<script>
// Переменные для хранения выбранных значений
    let selectedEquipment = {};
    let selectedEquipmentPrice = 0;
    let selectedServices = {};
    let totalServicesPrice = 0;
    let selectedTVPackages = {};
    let totalTVPackagesPrice = 0;

    function saveSelections() {
        localStorage.setItem('selectedEquipment', JSON.stringify(selectedEquipment));
        localStorage.setItem('selectedServices', JSON.stringify(selectedServices));
        localStorage.setItem('selectedTVPackages', JSON.stringify(selectedTVPackages));
    }

    function loadSelections() {
        // Загрузка сохранённых данных
        selectedEquipment = JSON.parse(localStorage.getItem('selectedEquipment') || '{}');
        selectedServices = JSON.parse(localStorage.getItem('selectedServices') || '{}');
        selectedTVPackages = JSON.parse(localStorage.getItem('selectedTVPackages') || '{}');

        // Обновление чекбоксов и классов для оборудования
        Object.keys(selectedEquipment).forEach(id => {
            const checkbox = document.getElementById(`equipment-${id}`);
            const element = document.querySelector(`.equipment__item[data-id="${id}"]`);
            if (checkbox && element) {
                checkbox.checked = true;
                element.classList.add('selected');
            }
        });
        selectedEquipmentPrice = Object.values(selectedEquipment).reduce((sum, p) => sum + p.price, 0);

        // Обновление чекбоксов для услуг
        Object.keys(selectedServices).forEach(slug => {
            const checkbox = document.getElementById(slug);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        totalServicesPrice = Object.values(selectedServices).reduce((sum, s) => sum + s.price, 0);

        // Обновление чекбоксов для ТВ-пакетов
        Object.keys(selectedTVPackages).forEach(id => {
            const checkbox = document.getElementById(`package-${id}`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        totalTVPackagesPrice = Object.values(selectedTVPackages).reduce((sum, p) => sum + p.price, 0);

        // Обновление интерфейса
        updateEquipmentSummary();
        updateServicesSummary();
        updateTVPackageSummary();
        calculateTotal();
    }

    // Инициализация маски для телефона
    const phoneInput = document.querySelector('#orderForm [name="phone"]');
    let phoneMask = null;
    if (phoneInput) {
        phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false,
            placeholderChar: '_'
        });
    }

    // Функция для подготовки номера телефона
    function preparePhoneNumber(phoneValue) {
        const digits = phoneValue.replace(/\D/g, '');
        if (digits.length === 11 && (digits.startsWith('7') || digits.startsWith('8'))) {
            return '+7' + digits.substring(1);
        }
        return null;
    }

    // Валидация формы
    function validateOrderForm() {
        const fullNameValid = document.querySelector('#orderForm [name="full_name"]').value.trim().length >= 3;
        const phoneValid = phoneMask && preparePhoneNumber(phoneMask.unmaskedValue) !== null;
        const agreeChecked = document.querySelector('#agree').checked;
        document.querySelector('#orderForm .order-form__submit').disabled = !(fullNameValid && phoneValid && agreeChecked);
    }

    // Обработчики событий для валидации
    document.querySelectorAll('#orderForm [name="full_name"], #orderForm [name="phone"], #orderForm #agree').forEach(input => {
        input.addEventListener('input', validateOrderForm);
        if (input.type === 'checkbox') {
            input.addEventListener('change', validateOrderForm);
        }
    });

    // Инициализация валидации
    validateOrderForm();

    // Отправка формы
    document.getElementById('orderForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Предотвращаем стандартную отправку формы

        // Сброс ошибок
        document.querySelectorAll('#orderForm .order-form__input, #orderForm .order-form__textarea').forEach(el => {
            el.classList.remove('order-form__input--invalid');
        });
        document.querySelectorAll('#orderForm .order-form__validation-message').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });

        // Подготовка данных
        const equipmentIds = Object.keys(selectedEquipment);
        const serviceSlugs = Object.keys(selectedServices);
        const tvPackageIds = Object.keys(selectedTVPackages);
        document.getElementById('selected_equipment_ids').value = JSON.stringify(equipmentIds);
        document.getElementById('selected_service_slugs').value = JSON.stringify(serviceSlugs);
        document.getElementById('selected_tv_package_ids').value = JSON.stringify(tvPackageIds);

        const formData = new FormData(this);
        if (phoneMask) {
            const phone = preparePhoneNumber(phoneMask.unmaskedValue);
            if (!phone) {
                const phoneField = document.querySelector('#orderForm [name="phone"]');
                phoneField.classList.add('order-form__input--invalid');
                const errorElement = document.querySelector('#error_phone');
                errorElement.textContent = 'Пожалуйста, введите номер телефона в формате +7 (XXX) XXX-XX-XX или 8 (XXX) XXX-XX-XX';
                errorElement.style.display = 'block';
                return;
            }
            formData.set('phone', phone);
        }

        // Валидация перед отправкой
        let isFormValid = true;
        const fullNameField = document.querySelector('#orderForm [name="full_name"]');
        if (fullNameField.value.trim().length < 3) {
            fullNameField.classList.add('order-form__input--invalid');
            const errorElement = document.querySelector('#error_full_name');
            errorElement.textContent = 'Пожалуйста, введите полное имя (минимум 3 символа)';
            errorElement.style.display = 'block';
            isFormValid = false;
        }

        if (!isFormValid) return;

        const submitBtn = document.querySelector('#orderForm .order-form__submit');
        try {
            submitBtn.disabled = true;
            submitBtn.classList.add('order-form__submit--loading');
            submitBtn.innerHTML = 'Отправка...';

            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                this.reset();
                if (phoneMask) phoneMask.updateValue();
                // Очищаем localStorage после успешной отправки
                localStorage.removeItem('selectedEquipment');
                localStorage.removeItem('selectedServices');
                localStorage.removeItem('selectedTVPackages');
                window.location.href = `/${data.locality_slug}/order-success/${data.order_id}/`;
            } else {
                for (const [field, errors] of Object.entries(data.errors || {})) {
                    const errorElement = document.querySelector(`#error_${field}`);
                    if (errorElement) {
                        errorElement.textContent = errors.join(' ');
                        errorElement.style.display = 'block';
                        const inputField = document.querySelector(`#orderForm [name="${field}"]`);
                        if (inputField) inputField.classList.add('order-form__input--invalid');
                    }
                }
                if (data.non_field_errors) {
                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.innerHTML = `
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Ошибка</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${data.non_field_errors.join(' ')}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                }
            }
        } catch (error) {
            console.error('Ошибка при отправке формы:', error);
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ошибка</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Произошла ошибка при отправке заявки. Попробуйте снова.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        } finally {
            // Сбрасываем индикатор загрузки
            submitBtn.disabled = false;
            submitBtn.classList.remove('order-form__submit--loading');
            submitBtn.innerHTML = 'Отправить заявку';
        }
    });

    // Функции toggleEquipmentSelection, updateService, updateTVPackage
    function toggleEquipmentSelection(id, checked, price) {
        const element = document.querySelector(`.equipment__item[data-id="${id}"]`);
        const name = element.querySelector('.equipment__name').textContent.trim();
        if (checked) {
            element.classList.add('selected');
            selectedEquipment[id] = { name, price: parseInt(price) };
        } else {
            element.classList.remove('selected');
            delete selectedEquipment[id];
        }
        selectedEquipmentPrice = Object.values(selectedEquipment).reduce((sum, p) => sum + p.price, 0);
        updateEquipmentSummary();
        calculateTotal();
        saveSelections();
    }

    function updateService(serviceId, price) {
        const checkbox = document.getElementById(serviceId);
        const label = checkbox.nextElementSibling;
        const serviceName = label?.querySelector('.services__name').textContent.trim() || 'Неизвестная услуга';
        if (checkbox.checked) {
            selectedServices[serviceId] = { name: serviceName, price: parseInt(price) };
        } else {
            delete selectedServices[serviceId];
        }
        totalServicesPrice = Object.values(selectedServices).reduce((sum, s) => sum + s.price, 0);
        updateServicesSummary();
        calculateTotal();
        saveSelections();
    }

    function updateTVPackage(packageId, price) {
        const checkbox = document.getElementById(`package-${packageId}`);
        const tvPackage = checkbox.closest('.tv-package');
        const name = tvPackage.querySelector('.tv-package__name')?.textContent.trim() || 'Пакет каналов';
        if (checkbox.checked) {
            selectedTVPackages[packageId] = { name, price: parseInt(price) };
        } else {
            delete selectedTVPackages[packageId];
        }
        totalTVPackagesPrice = Object.values(selectedTVPackages).reduce((sum, p) => sum + p.price, 0);
        updateTVPackageSummary();
        calculateTotal();
        saveSelections();
    }

    // Обновление отображения
    function updateEquipmentSummary() {
        const container = document.getElementById('equipmentSummary');
        if (!container) return;
        if (Object.keys(selectedEquipment).length > 0) {
            let html = '<h5 class="summary__section-title">Оборудование</h5>';
            for (const [id, item] of Object.entries(selectedEquipment)) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${item.name}</span>
                        <span class="summary__item-value">${item.price.toLocaleString()} руб.</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Оборудование</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    function updateServicesSummary() {
        const container = document.getElementById('servicesSummary');
        if (!container) return;
        if (Object.keys(selectedServices).length > 0) {
            let html = '<h5 class="summary__section-title">Дополнительные услуги</h5>';
            for (const key in selectedServices) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${selectedServices[key].name}</span>
                        <span class="summary__item-value">${selectedServices[key].price.toLocaleString()} руб./мес.</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Дополнительные услуги</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    function updateTVPackageSummary() {
        const container = document.getElementById('tvPackagesSummary');
        if (!container) return;
        if (Object.keys(selectedTVPackages).length > 0) {
            let html = '<h5 class="summary__section-title">Пакеты ТВ</h5>';
            for (const key in selectedTVPackages) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${selectedTVPackages[key].name}</span>
                        <span class="summary__item-value">${selectedTVPackages[key].price.toLocaleString()} руб./мес.</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Пакеты ТВ</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    function calculateTotal() {
        const tariffPrice = parseInt('{{ tariff.get_actual_price }}') || 0; // Используем актуальную цену тарифа
        const connectionPrice = parseInt('{{ tariff.connection_price }}') || 0;

        // Абонентская плата: тариф + услуги + ТВ-пакеты
        const monthlyPrice = tariffPrice + totalServicesPrice + totalTVPackagesPrice;

        // При подключении: оборудование + стоимость подключения
        const connectionTotalPrice = selectedEquipmentPrice + connectionPrice;

        // Итоговая стоимость: абонентская плата + стоимость подключения
        const totalPrice = monthlyPrice + connectionTotalPrice;

        // Обновление отображения
        const totalPriceElement = document.getElementById('totalPrice');
        const monthlyPriceElement = document.getElementById('monthlyPrice');
        const connectionTotalPriceElement = document.getElementById('connectionTotalPrice');

        if (totalPriceElement) {
            totalPriceElement.textContent = `${totalPrice.toLocaleString()} руб.`;
        }
        if (monthlyPriceElement) {
            monthlyPriceElement.textContent = `${monthlyPrice.toLocaleString()} руб./мес.`;
        }
        if (connectionTotalPriceElement) {
            connectionTotalPriceElement.textContent = `${connectionTotalPrice.toLocaleString()} руб.`;
        }

        // Обновление скрытых полей
        document.getElementById('total_equipment_cost').value = selectedEquipmentPrice;
        document.getElementById('total_services_cost').value = totalServicesPrice;
        document.getElementById('total_tv_packages_cost').value = totalTVPackagesPrice;
        document.getElementById('total_price').value = totalPrice;
    }

    // Перемещение блока "Итоговая стоимость"
    function moveSummaryCard() {
        const isMobile = window.innerWidth < 992;
        const summary = document.querySelector('.summary');
        if (!summary) return;

        if (!isMobile && summary.closest('.order-form__mobile-summary')) {
            const originalContainer = document.getElementById('summaryCardContainer');
            originalContainer.appendChild(summary);
        } else if (isMobile && !summary.closest('.order-form__mobile-summary')) {
            const mobileTarget = document.getElementById('mobileSummaryTarget');
            if (mobileTarget) {
                mobileTarget.innerHTML = '';
                mobileTarget.appendChild(summary);
            }
        }
    }

    // Инициализация
    window.addEventListener('DOMContentLoaded', () => {
        moveSummaryCard();
        loadSelections();
    });
    window.addEventListener('resize', () => {
        setTimeout(moveSummaryCard, 100);
    });
</script>
{% endblock %}