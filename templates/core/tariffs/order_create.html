{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <!-- Основной контент -->
        <div class="order-form__layout">
            <div class="order-form__main">
                <!-- Информация о тарифе -->
                <section class="tariff-info">
                    <div class="tariff-info__content">
                        <div class="tariff-info__details">
                            <h3 class="tariff-info__title">{{ tariff.name }}</h3>
                            <div class="tariff-info__badges">
                                <span class="tariff-info__badge tariff-info__badge--speed">
                                    <svg class="tariff-info__badge-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 2a6 6 0 100 12A6 6 0 008 2zm0 10a4 4 0 110-8 4 4 0 010 8zm2-4a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    {{ tariff.speed }} Мбит/с
                                </span>
                                {% if tariff.free_router %}
                                    <span class="tariff-info__badge tariff-info__badge--router">
                                        <svg class="tariff-info__badge-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                            <path d="M2 4h12v2H2V4zm0 4h12v2H2V8zm0 4h12v2H2v-2z"/>
                                        </svg>
                                        Wi-Fi роутер в подарок
                                    </span>
                                {% endif %}
                                {% if tariff.tv_channels %}
                                    <span class="tariff-info__badge tariff-info__badge--tv">
                                        <svg class="tariff-info__badge-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                            <path d="M2 3h12v8H2V3zm2 2v4h8V5H4z"/>
                                        </svg>
                                        {{ tariff.tv_channels }} ТВ-каналов
                                    </span>
                                {% endif %}
                            </div>
                            <p class="tariff-info__description">{{ tariff.description|safe }}</p>
                        </div>
                        <div class="tariff-info__price">
                            <div class="tariff-info__price-value">{{ tariff.price }} ₽</div>
                            <small class="tariff-info__price-unit">в месяц</small>
                        </div>
                    </div>
                </section>
                
                <!-- Пакеты ТВ-каналов -->
                {% if tv_packages %}
                <div class="tab-pane fade show active" id="tv-packages" role="tabpanel">
                    <h3 class="tv-packages__title">Добавить пакеты каналов</h3>
                    <p class="tv-packages__description">Добавьте расширенные пакеты каналов к вашему телевидению.</p>
                    <div class="tv-packages__list">
                        {% for package in tv_packages %}
                            <article class="tv-package">
                                <div class="tv-package__content">
                                    <div class="tv-package__header">
                                        <div class="tv-package__info">
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox"
                                                    id="package-{{ package.id }}"
                                                    onclick="updateTVPackage('{{ package.id }}', {{ package.price }})">
                                                <label class="tv-package__label" for="package-{{ package.id }}">
                                                    <h5 class="tv-package__name">{{ package.name }}</h5>
                                                    <!-- Блок с количеством каналов и ссылкой -->
                                                    <div class="tv-package__meta">
                                                        <div class="tv-package__channels">
                                                            {{ package.total_channels }} каналов
                                                        </div>
                                                        <a href="#"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#channelsModal-package-{{ package.id }}"
                                                            class="tv-package__channels-link"
                                                            aria-label="Посмотреть каналы пакета {{ package.name }}">
                                                            Список каналов
                                                        </a>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="tv-package__image-container">
                                            {% if package.image %}
                                                <img src="{{ package.image.url }}" alt="Изображение пакета {{ package.name }}" class="tv-package__image">
                                            {% else %}
                                                <div class="tv-package__image-placeholder" aria-hidden="true">
                                                    <span>Нет изображения</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="tv-package__description">{{ package.description|safe }}</p>
                                </div>
                                <div class="tv-package__footer">
                                    <div class="tv-package__price">{{ package.price }} ₽/мес</div>
                                </div>
                            </article>
                            {% include 'core/partials/channels_modal.html' with object=package channels=package.channels.all modal_type="package" %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Оборудование -->
                <section class="equipment">
                    <h3 class="equipment__title">Добавить оборудование</h3>
                    <p class="equipment__description">Оборудование приобретается при подключении и не входит в абонентскую плату.</p>
                    <div class="equipment__list">
                        {% for product in products %}
                            <article class="equipment__item" data-id="{{ product.id }}" onclick="selectEquipment(this, {{ product.price }})">
                                <div class="equipment__content">
                                    <div class="equipment__header">
                                        <div class="equipment__image-container">
                                            {% if product.get_main_image %}
                                                <img src="{{ product.get_main_image.image.url }}" alt="{{ product.name }}" class="equipment__image">
                                            {% else %}
                                                <div class="equipment__image-placeholder" aria-hidden="true">
                                                    <svg class="equipment__image-icon" width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                                                        <path d="M2 4h12v2H2V4zm0 4h12v2H2V8zm0 4h12v2H2v-2z"/>
                                                    </svg>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="equipment__info">
                                            <h5 class="equipment__name">{{ product.name }}</h5>
                                            <p class="equipment__short-description">{{ product.short_description }}</p>
                                        </div>
                                    </div>
                                    <p class="equipment__description">{{ product.description|safe }}</p>
                                    <div class="equipment__footer">
                                        <div class="equipment__price">{{ product.price }} ₽</div>
                                        {% if product.category %}
                                            <div class="equipment__category">{{ product.category.name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                    <div class="equipment__no-equipment">
                        <input class="equipment__checkbox" type="checkbox" id="noEquipment" onclick="toggleNoEquipment()">
                        <label class="equipment__label" for="noEquipment">
                            У меня есть свое оборудование, ничего не нужно
                        </label>
                    </div>
                </section>

                <!-- Дополнительные услуги -->
                <section class="services">
                    <h3 class="services__title">Дополнительные услуги</h3>
                    <p class="services__description">Выберите дополнительные услуги, которые будут подключены вместе с вашим тарифом.</p>
                    <div class="services__list">
                        {% for service in services %}
                            <article class="services__item">
                                <div class="services__content">
                                    <div class="services__header">
                                        <div class="services__switch">
                                            <input class="services__checkbox" type="checkbox" id="{{ service.slug }}"
                                                   onclick="updateService('{{ service.slug }}', {{ service.price }})">
                                            <label class="services__label" for="{{ service.slug }}">
                                                <h5 class="services__name">{{ service.name }}</h5>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="services__description">{{ service.description|safe }}</p>
                                    <div class="services__footer">
                                        <div class="services__price">{{ service.price }} ₽/мес</div>
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </section>

                <!-- Место для вставки блока "Итоговая стоимость" на мобильных -->
                <div class="order-form__mobile-summary" id="mobileSummaryTarget"></div>

                <!-- Форма заявки -->
                <section class="order-form__section">
                    <h3 class="order-form__section-title">Оформление заявки</h3>
                    <form class="order-form__form" id="orderForm" method="post">
                        {% csrf_token %}
                        <!-- Скрытые поля для ManyToMany -->
                        <input type="hidden" name="selected_equipment_ids" id="selected_equipment_ids">
                        <input type="hidden" name="selected_service_slugs" id="selected_service_slugs">
                        <input type="hidden" name="selected_tv_package_ids" id="selected_tv_package_ids">
                        <!-- Вспомогательные скрытые поля для подсчета -->
                        <input type="hidden" id="total_equipment_cost">
                        <input type="hidden" id="total_services_cost">
                        <input type="hidden" id="total_tv_packages_cost">
                        <input type="hidden" id="total_price">

                        <!-- Основные поля формы -->
                        <div class="order-form__fields">
                            <div class="order-form__field">
                                <label for="name" class="order-form__label">Ваше имя</label>
                                <input type="text" name="full_name" class="order-form__input" id="name" required>
                            </div>
                            <div class="order-form__field">
                                <label for="phone" class="order-form__label">Номер телефона</label>
                                <input type="tel" name="phone" class="order-form__input" id="phone" required>
                            </div>
                            <div class="order-form__field order-form__field--street">
                                <label for="street" class="order-form__label">Улица</label>
                                <input type="text" name="street" class="order-form__input" id="street" required>
                            </div>
                            <div class="order-form__field order-form__field--house">
                                <label for="house" class="order-form__label">Дом</label>
                                <input type="text" name="house" class="order-form__input" id="house" required>
                            </div>
                            <div class="order-form__field order-form__field--comments">
                                <label for="comments" class="order-form__label">Комментарий (необязательно)</label>
                                <textarea name="comment" class="order-form__textarea" id="comments" rows="2"></textarea>
                            </div>
                            <div class="order-form__field">
                                <div class="order-form__checkbox-wrapper">
                                    <input class="order-form__checkbox" type="checkbox" id="agree" required>
                                    <label class="order-form__checkbox-label" for="agree">
                                        Я согласен на обработку персональных данных и ознакомлен с <a href="#" class="order-form__link">договором оферты</a>
                                    </label>
                                </div>
                            </div>
                            <div class="order-form__field">
                                <button type="submit" class="order-form__submit">Оставить заявку</button>
                            </div>
                        </div>
                    </form>
                </section>
            </div>

            <!-- Итоговая стоимость -->
            <aside class="summary" id="summaryCardContainer">
                <div class="summary__content">
                    <h3 class="summary__title">Заявка на подключение</h3>
                    <div class="summary__section">
                        <h5 class="summary__section-title">Тариф</h5>
                        <div class="summary__item">
                            <span class="summary__item-name">{{ tariff.name }}</span>
                            <span class="summary__item-value">{{ tariff.price }} ₽/мес</span>
                        </div>
                    </div>
                    <div class="summary__section" id="equipmentSummary">
                        <h5 class="summary__section-title">Оборудование</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    <div class="summary__section" id="servicesSummary">
                        <h5 class="summary__section-title">Дополнительные услуги</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    <div class="summary__section" id="tvPackagesSummary">
                        <h5 class="summary__section-title">Пакеты ТВ</h5>
                        <div class="summary__item summary__item--empty">Не выбрано</div>
                    </div>
                    <div class="summary__section">
                        <h5 class="summary__section-title">Подключение</h5>
                        <div class="summary__item">
                            <span class="summary__item-name">Разово</span>
                            <span class="summary__item-value" id="connectionPrice">{{ tariff.connection_price }} ₽</span>
                        </div>
                    </div>
                    <hr class="summary__divider">
                    <div class="summary__total">
                        <h5 class="summary__total-title">Итого к оплате:</h5>
                        <h5 class="summary__total-value" id="totalPrice">{{ tariff.price }} ₽</h5>
                    </div>
                    <div class="summary__info">
                        <small>Абонентская плата начнет взиматься с момента активации тарифа. Оборудование оплачивается единоразово при подключении.</small>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script>
    // === Переменные для хранения выбранных значений ===
    let selectedEquipment = {};
    let selectedEquipmentPrice = 0;
    let selectedServices = {};
    let totalServicesPrice = 0;
    let selectedTVPackages = {};
    let totalTVPackagesPrice = 0;

    // === Функция выбора оборудования ===
    function selectEquipment(element, price) {
        const name = element.querySelector('.equipment__name').textContent.trim();
        if (element.classList.contains('selected')) {
            element.classList.remove('selected');
            delete selectedEquipment[name];
        } else {
            element.classList.add('selected');
            selectedEquipment[name] = price;
        }
        selectedEquipmentPrice = Object.values(selectedEquipment).reduce((sum, p) => sum + p, 0);
        updateEquipmentSummary();
        calculateTotal();
        document.getElementById('noEquipment').checked = false;
    }

    // === Выбор "у меня есть своё оборудование" ===
    function toggleNoEquipment() {
        const noEquipmentChecked = document.getElementById('noEquipment').checked;
        if (noEquipmentChecked) {
            document.querySelectorAll('.equipment__item').forEach(item => item.classList.remove('selected'));
            selectedEquipment = {};
            selectedEquipmentPrice = 0;
        }
        updateEquipmentSummary();
        calculateTotal();
    }

    // === Выбор дополнительной услуги ===
    function updateService(serviceId, price) {
        const checkbox = document.getElementById(serviceId);
        const label = checkbox.nextElementSibling;
        const serviceName = label?.querySelector('.services__name').textContent.trim() || 'Неизвестная услуга';
        if (checkbox.checked) {
            selectedServices[serviceId] = { name: serviceName, price: parseInt(price) };
        } else {
            delete selectedServices[serviceId];
        }
        totalServicesPrice = Object.values(selectedServices).reduce((sum, s) => sum + s.price, 0);
        updateServicesSummary();
        calculateTotal();
    }

    // === Выбор ТВ-пакета ===
    function updateTVPackage(packageId, price) {
        const checkbox = document.getElementById(`package-${packageId}`);
        const name = checkbox?.nextElementSibling?.querySelector('.tv-package__name').textContent.trim() || 'Пакет каналов';
        if (checkbox.checked) {
            selectedTVPackages[packageId] = { name, price: parseInt(price) };
        } else {
            delete selectedTVPackages[packageId];
        }
        totalTVPackagesPrice = Object.values(selectedTVPackages).reduce((sum, p) => sum + p.price, 0);
        updateTVPackageSummary();
        calculateTotal();
    }

    // === Обновление отображения оборудования ===
    function updateEquipmentSummary() {
        const container = document.getElementById('equipmentSummary');
        if (Object.keys(selectedEquipment).length > 0) {
            let html = '<h5 class="summary__section-title">Оборудование</h5>';
            for (const [name, price] of Object.entries(selectedEquipment)) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${name}</span>
                        <span class="summary__item-value">${price.toLocaleString()} ₽</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Оборудование</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    // === Обновление отображения доп. услуг ===
    function updateServicesSummary() {
        const container = document.getElementById('servicesSummary');
        if (Object.keys(selectedServices).length > 0) {
            let html = '<h5 class="summary__section-title">Дополнительные услуги</h5>';
            for (const key in selectedServices) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${selectedServices[key].name}</span>
                        <span class="summary__item-value">${selectedServices[key].price.toLocaleString()} ₽/мес</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Дополнительные услуги</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    // === Обновление отображения ТВ-пакетов ===
    function updateTVPackageSummary() {
        const container = document.getElementById('tvPackagesSummary');
        if (Object.keys(selectedTVPackages).length > 0) {
            let html = '<h5 class="summary__section-title">Пакеты ТВ</h5>';
            for (const key in selectedTVPackages) {
                html += `
                    <div class="summary__item">
                        <span class="summary__item-name">${selectedTVPackages[key].name}</span>
                        <span class="summary__item-value">${selectedTVPackages[key].price.toLocaleString()} ₽/мес</span>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<h5 class="summary__section-title">Пакеты ТВ</h5><div class="summary__item summary__item--empty">Не выбрано</div>`;
        }
    }

    // === Подсчет итоговой суммы ===
    function calculateTotal() {
        const connectionPrice = parseInt(document.getElementById('connectionPrice').textContent) || 0;
        const totalPrice = connectionPrice + selectedEquipmentPrice + totalServicesPrice + totalTVPackagesPrice;
        document.getElementById('totalPrice').textContent = `${totalPrice.toLocaleString()} ₽`;
        document.getElementById('total_equipment_cost').value = selectedEquipmentPrice;
        document.getElementById('total_services_cost').value = totalServicesPrice;
        document.getElementById('total_tv_packages_cost').value = totalTVPackagesPrice;
        document.getElementById('total_price').value = totalPrice;
    }

    // === Отправка формы ===
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('selected_equipment_ids').value = Object.keys(selectedEquipment);
        document.getElementById('selected_service_slugs').value = Object.keys(selectedServices);
        document.getElementById('selected_tv_package_ids').value = Object.keys(selectedTVPackages);
        this.submit();
    });

    // === Перемещение блока "Итоговая стоимость" ===
    function moveSummaryCard() {
        const isMobile = window.innerWidth < 992;
        const summaryContent = document.querySelector('.summary__content');
        if (!summaryContent) return;

        if (!isMobile && summaryContent.closest('.order-form__mobile-summary')) {
            const originalContainer = document.getElementById('summaryCardContainer');
            originalContainer.appendChild(summaryContent);
        } else if (isMobile && !summaryContent.closest('.order-form__mobile-summary')) {
            const mobileTarget = document.getElementById('mobileSummaryTarget');
            if (mobileTarget) {
                mobileTarget.innerHTML = '';
                mobileTarget.appendChild(summaryContent);
            }
        }
    }

    // === Обработчик модальных окон ===
    document.querySelectorAll('[data-modal-target]').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const modalId = button.getAttribute('data-modal-target');
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        });
    });

    // === Закрытие модальных окон ===
    document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    });

    // === Инициализация ===
    window.addEventListener('DOMContentLoaded', moveSummaryCard);
    window.addEventListener('resize', () => {
        setTimeout(moveSummaryCard, 100);
    });
</script>
{% endblock %}