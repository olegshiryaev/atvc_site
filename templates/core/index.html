{% extends 'base.html' %}
{% load static %}

{% block title %}Главная страница{% endblock %}

{% block content %}
<div class="min-h-screen font-sans">
    <!-- Карусель -->
    {% if banners %}
    <div id="bannerCarousel" class="carousel slide mb-5" data-bs-ride="carousel" data-bs-interval="5000" data-bs-pause="hover">
        <div class="carousel-inner">
            {% for banner in banners %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <div class="carousel-item-bg" {% if banner.background_image %}style="background-image: url('{{ banner.background_image.url }}');"{% endif %}>
                    <div class="container py-3 py-md-5">
                        <div class="row align-items-center">
                            <!-- Текстовая часть -->
                            <div class="col-12 col-md-8 text-center text-md-start">
                                <h2 class="fs-48 fw-black lh-custom carousel-title">{{ banner.title }}</h2>
                                <p class="fs-5 carousel-description">{{ banner.description }}</p>
                                {% if banner.link %}
                                <a href="{{ banner.link }}"
                                   class="btn bg-sky-600 text-white fs-6 fw-medium carousel-button">
                                    {{ banner.button_text }}
                                </a>
                                {% endif %}
                            </div>
                            <!-- Изображение -->
                            {% if banner.image %}
                            <div class="col-12 col-md-4 d-none d-md-flex justify-content-end align-items-center">
                                <img src="{{ banner.image.url }}"
                                     alt="{{ banner.title }}"
                                     loading="lazy"
                                     class="img-fluid carousel-image">
                            </div>
                            {% else %}
                            <div class="col-12 col-md-4 d-none d-md-block"></div> <!-- Пустой блок для сохранения высоты -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Пагинация -->
        {% if banners|length > 1 %}
        <div class="carousel-indicators">
            {% for banner in banners %}
            <button type="button"
                    data-bs-target="#bannerCarousel"
                    data-bs-slide-to="{{ forloop.counter0 }}"
                    {% if forloop.first %}class="active" aria-current="true"{% endif %}
                    aria-label="Слайд {{ forloop.counter1 }}"></button>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}


    <!-- Блок тарифов -->
    {% if displayed_tariffs.exists %}
    <div class="container py-5">
        <div class="mb-5">
            <h2 class="fs-48 fw-black lh-custom text-gray-800 mb-4">Выберите тариф</h2>
            <div class="d-flex flex-wrap gap-2">
                <!-- Кнопка Интернет -->
                <button class="filter-btn btn {% if active_filter == 'internet' %}bg-sky-600 text-white hover-bg-sky-700{% else %}btn-outline-sky-700 text-sky-700 hover-bg-gray-100{% endif %} 
                        fs-6 fw-medium px-3 py-2 w-auto min-w-120px"
                        data-filter="internet">
                    <span class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 me-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                        </svg>
                        Интернет
                    </span>
                </button>
                <!-- Кнопка Телевидение -->
                <button class="filter-btn btn {% if active_filter == 'televidenie' %}bg-sky-600 text-white hover-bg-sky-700{% else %}btn-outline-sky-700 text-sky-700 hover-bg-gray-100{% endif %} 
                        fs-6 fw-medium px-3 py-2 w-auto min-w-120px"
                        data-filter="televidenie">
                    <span class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 me-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        Телевидение
                    </span>
                </button>
                <!-- Кнопка Комбо -->
                <button class="filter-btn btn {% if active_filter == 'kombo' %}bg-sky-600 text-white hover-bg-sky-700{% else %}btn-outline-sky-700 text-sky-700 hover-bg-gray-100{% endif %} 
                        fs-6 fw-medium px-3 py-2 w-auto min-w-120px"
                        data-filter="kombo">
                    <span class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 me-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        Интернет + ТВ
                    </span>
                </button>
            </div>
        </div>

        <!-- Контейнер с тарифами -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% include 'core/partials/tariffs_list.html' %}
        </div>
    </div>
    {% endif %}

    <!-- Модальное окно -->
    <div class="modal fade" id="applicationModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header no-border">
                    <h5 class="modal-title fs-2 fw-black lh-38 w-100 text-center" id="modalTitle">Оставить заявку</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="formContainer">
                        <form id="applicationForm" method="post" novalidate>
                            {% csrf_token %}
                            <!-- Первая строка: Имя и Телефон -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label text-gray-700">Имя</label>
                                    <input type="text" name="name" id="name" class="form-control" placeholder="Ваше имя" required>
                                    <div id="nameError" class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label text-gray-700">Телефон</label>
                                    <input type="tel" name="phone" id="phone" class="form-control" placeholder="+7 (___) ___-__-__" required>
                                    <div id="phoneError" class="invalid-feedback"></div>
                                </div>
                            </div>
                            <!-- Вторая строка: Улица и Номер дома -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="street" class="form-label text-gray-700">Улица</label>
                                    <input type="text" name="street" id="street" class="form-control" placeholder="Укажите улицу">
                                    <div id="streetError" class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="house_number" class="form-label text-gray-700">Номер дома</label>
                                    <input type="text" name="house_number" id="house_number" class="form-control" placeholder="Укажите номер дома">
                                    <div id="house_numberError" class="invalid-feedback"></div>
                                </div>
                            </div>
                            <!-- Третья строка: Комментарий -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="comment" class="form-label text-gray-700">Комментарий</label>
                                    <textarea name="comment" id="comment" class="form-control" rows="3" placeholder="Ваши пожелания или дополнительная информация"></textarea>
                                    <div id="commentError" class="invalid-feedback"></div>
                                </div>
                            </div>
                            <!-- Четвёртая строка: Чекбокс и Кнопка -->
                            <div class="row align-items-center">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <div class="form-check">
                                        <input type="checkbox" name="privacy" id="privacy" class="form-check-input" required>
                                        <label for="privacy" class="form-check-label text-gray-700">
                                            Я соглашаюсь, что ознакомлен с 
                                            <a href="#" class="text-sky-600 hover-text-sky-600">политикой конфиденциальности</a>
                                        </label>
                                        <div id="privacyError" class="invalid-feedback">
                                            Необходимо согласиться с политикой конфиденциальности
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn bg-sky-600 text-white hover-bg-sky-700 w-100 py-2 py-md-3 fs-6 text-uppercase" id="submitBtn" disabled>Отправить</button>
                                </div>
                            </div>
                            <div id="formErrors" class="text-danger mb-3 hidden"></div>
                        </form>
                    </div>
                    <div id="successMessage" class="hidden text-center">
                        <h5 class="modal-title fs-2 fw-black lh-38 w-100 text-center mb-4">Заявка успешно отправлена</h5>
                        <p class="fs-5 text-gray-600 mb-4">Скоро мы свяжемся с Вами и уточним детали</p>
                        <a href="/" class="btn bg-sky-600 text-white hover-bg-sky-700 text-uppercase" id="toHomeBtn">На главную</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние новости -->
    {% if latest_news %}
    <div class="container py-4 animate-fade-in">
        <div class="d-block d-sm-flex align-items-sm-center justify-content-between mb-4">
            <div>
                <h2 class="fs-3 fw-bold text-gray-800 mb-2 mb-sm-0" style="line-height: 38px;">Последние новости</h2>
                <a href="{% url 'news:news_list' city.slug %}" 
                class="text-primary text-decoration-none transition-colors duration-300 fw-semibold d-flex align-items-center gap-1 d-sm-none"
                style="font-size: 15px; line-height: 21px;"
                aria-label="Перейти ко всем новостям">
                    Все новости
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            </div>
            <a href="{% url 'news:news_list' city.slug %}" 
            class="text-primary text-decoration-none transition-colors duration-300 fw-semibold d-none d-sm-flex align-items-center gap-1"
            style="font-size: 15px; line-height: 21px;"
            aria-label="Перейти ко всем новостям">
                Все новости
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </a>
        </div>

        <!-- Слайдер Swiper -->
        <div class="swiper news-slider position-relative">
            <div class="swiper-wrapper">
                {% for news in latest_news %}
                <div class="swiper-slide">
                    <a href="{% url 'news:news_detail' city.slug news.slug %}" 
                    class="card text-decoration-none d-flex flex-column h-100"
                    aria-label="Читать новость: {{ news.title }}">
                        {% if news.image %}
                        <div class="position-relative overflow-hidden rounded-top-3">
                            <img src="{{ news.image.url }}" 
                                alt="{{ news.title }}" 
                                loading="lazy" 
                                class="card-img-top object-fit-cover w-100 h-36 h-md-40"
                                style="aspect-ratio: 16/9;">
                        </div>
                        {% else %}
                        <div class="bg-gray-100 rounded-top-3 d-flex align-items-center justify-content-center w-100 h-36 h-md-40 text-gray-500 fs-6 fw-medium" 
                            style="aspect-ratio: 16/9;"
                            role="img" 
                            aria-label="Изображение отсутствует">
                            Изображение отсутствует
                        </div>
                        {% endif %}
                        <div class="card-body pt-3 pb-3 d-flex flex-column flex-grow-1">
                            <p class="text-muted fs-6 fw-medium mb-1 transition-colors duration-300 hover-text-primary">
                                {{ news.created_at|date:"d.m.Y" }}
                            </p>
                            <h3 class="card-title fs-4 fw-semibold text-gray-900 mb-2 text-truncate-2 lh-base">
                                {{ news.title }}
                            </h3>
                            {% if news.content %}
                            <p class="text-muted fs-base fw-normal text-truncate-2 lh-base mt-auto">
                                {{ news.content|striptags|truncatechars:100 }}
                            </p>
                            {% endif %}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            <div class="swiper-pagination mt-3 bottom-0"></div>
        </div>
    </div>
    {% endif %}

    <!-- Секция проверки адреса -->
    <div class="container-fluid py-5 address-check-section" style="background: linear-gradient(135deg, #0284c7 0%, #075985 100%);">
        <!-- Изображение для десктопов -->
        <img src="{% static 'img/girl-with-laptop.png' %}" alt="Девушка с ноутбуком" class="img-fluid address-check-image d-none d-lg-block">
        <!-- Изображение для мобильных -->
        <img src="{% static 'img/girl-with-laptop-mobile.png' %}" alt="Девушка с ноутбуком" class="img-fluid address-check-image-mobile d-lg-none">
    
        <div class="container">
            <div class="row align-items-end">
                <!-- Левая часть (пустая, сохраняет место в сетке) -->
                <div class="col-lg-6 mb-4 mb-lg-0"></div>
                <!-- Правая часть с формой -->
                <div class="col-lg-6">
                    <div class="text-center mb-4">
                        <h2 class="fs-48 fw-black lh-custom text-white mb-4">Проверьте свой адрес на подключение</h2>
                    </div>
                    <form id="checkAddressForm" method="post" novalidate>
                        <!-- Оригинальная форма без изменений -->
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- Улица -->
                            <div class="col-md-6">
                                <input type="text" name="street" id="street" class="form-control" placeholder="Укажите улицу">
                                <div id="streetError" class="invalid-feedback"></div>
                            </div>
                            <!-- Номер дома -->
                            <div class="col-md-6">
                                <input type="text" name="house_number" id="house_number" class="form-control" placeholder="Укажите номер дома">
                                <div id="house_numberError" class="invalid-feedback"></div>
                            </div>
                            <!-- Имя -->
                            <div class="col-md-6">
                                <input type="text" name="name" id="name" class="form-control" placeholder="Ваше имя" required>
                                <div id="nameError" class="invalid-feedback"></div>
                            </div>
                            <!-- Телефон -->
                            <div class="col-md-6">
                                <input type="tel" name="phone" id="phone" class="form-control" placeholder="+7 (___) ___-__-__" required>
                                <div id="phoneError" class="invalid-feedback"></div>
                            </div>
                            <!-- Чекбокс и кнопка -->
                            <div class="col-12">
                                <div class="row align-items-center">
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="form-check">
                                            <input type="checkbox" name="privacy" id="privacy" class="form-check-input" required>
                                            <label for="privacy" class="form-check-label text-white">
                                                Я соглашаюсь, что ознакомлен с 
                                                <a href="#" class="text-white text-decoration-underline">политикой конфиденциальности</a>
                                            </label>
                                            <div id="privacyError" class="invalid-feedback d-none"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn bg-white text-sky-600 hover-bg-gray-100 w-100 py-2 py-md-3 fs-6 text-uppercase" id="submitAddressBtn" disabled>Оставить заявку</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Инициализация Swiper -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        new Swiper('.news-slider', {
            slidesPerView: 1,
            spaceBetween: 12,
            centeredSlides: true,
            breakpoints: {
                640: {
                    slidesPerView: 2,
                    spaceBetween: 16,
                    centeredSlides: false,
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 20,
                    centeredSlides: false,
                },
                1280: {
                    slidesPerView: 3,
                    spaceBetween: 20,
                    centeredSlides: false,
                },
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                dynamicBullets: true,
            },
            loop: {% if latest_news.count > 3 %}true{% else %}false{% endif %},
            grabCursor: true,
            speed: 600,
            effect: 'slide',
            watchSlidesProgress: true,
        });
    });
</script>

<!-- Скрипты -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Анимация карточек новостей
        const cards = document.querySelectorAll('.animate-slide-up');
        cards.forEach((card, index) => {
            const delay = (index / 3).toFixed(2);
            card.style.animationDelay = `${delay}s`;
        });

        // Фильтры тарифов
        const tariffsContainer = document.querySelector('.row.row-cols-1');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const citySlug = window.location.pathname.split('/')[1];

        async function loadTariffs(filterType) {
            try {
                tariffsContainer.innerHTML = `
                    <div class="col-12 py-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                `;
                const response = await fetch(`?type=${filterType}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                updateUI(filterType, data.html);
                addConnectButtonListeners();
            } catch (error) {
                console.error('Ошибка загрузки тарифов:', error);
                tariffsContainer.innerHTML = `
                    <div class="col-12 text-center py-12">
                        <p class="text-danger">Произошла ошибка. Пожалуйста, попробуйте ещё раз.</p>
                        <button onclick="location.reload()" class="btn btn-primary mt-4">Обновить страницу</button>
                    </div>
                `;
            }
        }

        function updateUI(activeFilter, tariffsHTML) {
            tariffsContainer.innerHTML = tariffsHTML;
            filterButtons.forEach(btn => {
                const isActive = btn.dataset.filter === activeFilter;
                btn.classList.toggle('bg-sky-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('hover-bg-sky-700', isActive);
                btn.classList.toggle('btn-outline-sky-700', !isActive);
                btn.classList.toggle('text-sky-700', !isActive);
                btn.classList.toggle('hover-bg-gray-100', !isActive);
            });
        }

        // Общая функция для валидации телефона
        function validatePhone(phoneValue) {
            return phoneValue.replace(/[^0-9]/g, '').length === 11;
        }

        // Общая функция для проверки заполненности формы
        function checkFormValidity(form) {
            const nameInput = form.querySelector('[name="name"]');
            const phoneInput = form.querySelector('[name="phone"]');
            const privacyInput = form.querySelector('[name="privacy"]');
            const submitBtn = form.querySelector('button[type="submit"]');

            if (!nameInput || !phoneInput || !privacyInput || !submitBtn) return;

            const isNameFilled = nameInput.value.trim() !== '';
            const isPhoneFilled = validatePhone(phoneInput.value);
            const isPrivacyChecked = privacyInput.checked;

            submitBtn.disabled = !(isNameFilled && isPhoneFilled && isPrivacyChecked);
        }

        // Инициализация формы проверки адреса
        function initAddressCheckForm() {
            const addressForm = document.getElementById('checkAddressForm');
            if (!addressForm) return;

            const phoneInput = addressForm.querySelector('[name="phone"]');
            if (phoneInput) {
                IMask(phoneInput, {
                    mask: '+7(000)000-0000',
                    lazy: false,
                    placeholderChar: '_'
                });
            }

            // Слушатели изменений для обязательных полей
            addressForm.querySelectorAll('[name="name"], [name="phone"], [name="privacy"]').forEach(input => {
                input.addEventListener('input', () => checkFormValidity(addressForm));
            });

            // Обработчик отправки формы
            addressForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Сброс предыдущих ошибок
                addressForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                addressForm.querySelectorAll('.invalid-feedback').forEach(el => {
                    el.classList.add('d-none');
                    el.textContent = '';
                });

                // Валидация
                let isValid = true;
                const name = addressForm.querySelector('[name="name"]');
                const phone = addressForm.querySelector('[name="phone"]');
                const street = addressForm.querySelector('[name="street"]');
                const houseNumber = addressForm.querySelector('[name="house_number"]');
                const privacy = addressForm.querySelector('[name="privacy"]');

                if (name.value.trim() === '') {
                    name.classList.add('is-invalid');
                    const errorDiv = addressForm.querySelector('#nameError');
                    if (errorDiv) {
                        errorDiv.textContent = 'Пожалуйста, укажите ваше имя';
                        errorDiv.classList.remove('d-none');
                    }
                    isValid = false;
                }

                if (!validatePhone(phone.value)) {
                    phone.classList.add('is-invalid');
                    const errorDiv = addressForm.querySelector('#phoneError');
                    if (errorDiv) {
                        errorDiv.textContent = 'Пожалуйста, укажите корректный номер телефона';
                        errorDiv.classList.remove('d-none');
                    }
                    isValid = false;
                }

                if (!privacy.checked) {
                    privacy.classList.add('is-invalid');
                    const errorDiv = addressForm.querySelector('#privacyError');
                    if (errorDiv) {
                        errorDiv.classList.remove('d-none');
                    }
                    isValid = false;
                }

                if (!isValid) {
                    return;
                }

                // Отправка формы
                try {
                    const formData = new FormData(addressForm);
                    formData.append('comment', ''); // Добавляем пустое поле comment
                    const submitUrl = `/${citySlug}/application/submit/`;
                    const response = await fetch(submitUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Открываем модальное окно с сообщением об успехе
                        const modal = document.getElementById('applicationModal');
                        const modalHeader = modal.querySelector('.modal-header');
                        const formContainer = document.getElementById('formContainer');
                        const successMessage = document.getElementById('successMessage');

                        if (modal && modalHeader && formContainer && successMessage) {
                            modalHeader.classList.add('hidden');
                            formContainer.classList.add('hidden');
                            successMessage.classList.remove('hidden');
                            const bsModal = new bootstrap.Modal(modal);
                            bsModal.show();

                            // Автозакрытие через 5 секунд
                            setTimeout(() => {
                                bsModal.hide();
                            }, 5000);
                        }
                    } else {
                        if (data.errors) {
                            for (const [field, errors] of Object.entries(data.errors)) {
                                const errorDiv = addressForm.querySelector(`#${field}Error`);
                                if (errorDiv) {
                                    errorDiv.textContent = errors.join(' ');
                                    errorDiv.classList.remove('d-none');
                                    const input = addressForm.querySelector(`[name="${field}"]`);
                                    if (input) input.classList.add('is-invalid');
                                }
                            }
                        } else {
                            const errorDiv = addressForm.querySelector('#formErrors');
                            if (errorDiv) {
                                errorDiv.textContent = data.error || 'Произошла ошибка при отправке';
                                errorDiv.classList.remove('d-none');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Ошибка при отправке формы:', error);
                    const errorDiv = addressForm.querySelector('#formErrors');
                    if (errorDiv) {
                        errorDiv.textContent = 'Произошла ошибка при отправке';
                        errorDiv.classList.remove('d-none');
                    }
                }
            });
        }

        function addConnectButtonListeners() {
            const connectButtons = document.querySelectorAll('.connect-btn');
            connectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tariffName = this.dataset.tariffName || '';
                    const citySlug = this.dataset.citySlug || window.citySlug || '';
                    const modal = document.getElementById('applicationModal');
                    const modalHeader = modal.querySelector('.modal-header');
                    const modalTitle = document.getElementById('modalTitle');
                    const form = document.getElementById('applicationForm');
                    const nameInput = form.querySelector('[name="name"]');
                    const phoneInput = form.querySelector('[name="phone"]');
                    const streetInput = form.querySelector('[name="street"]');
                    const houseNumberInput = form.querySelector('[name="house_number"]');
                    const commentInput = form.querySelector('[name="comment"]');
                    const privacyInput = form.querySelector('[name="privacy"]');
                    const formErrors = document.getElementById('formErrors');
                    const formContainer = document.getElementById('formContainer');
                    const successMessage = document.getElementById('successMessage');
                    const submitBtn = form.querySelector('button[type="submit"]');

                    modalTitle.textContent = 'Оставить заявку';
                    modalHeader.classList.remove('hidden');
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();

                    setTimeout(() => { nameInput.focus(); }, 50);

                    let phoneMask;
                    if (phoneInput) {
                        phoneMask = IMask(phoneInput, {
                            mask: '+7(000)000-0000',
                            lazy: false,
                            placeholderChar: '_'
                        });
                    }

                    // Очистка формы и состояния
                    form.reset();
                    if (phoneMask) phoneMask.updateValue();
                    if (commentInput) commentInput.value = tariffName ? `Тариф: ${tariffName}` : '';
                    if (formErrors) {
                        formErrors.classList.add('hidden');
                        formErrors.textContent = '';
                    }

                    ['nameError', 'phoneError', 'streetError', 'house_numberError', 'commentError', 'privacyError'].forEach(id => {
                        const errorDiv = document.getElementById(id);
                        if (errorDiv) {
                            errorDiv.textContent = '';
                            errorDiv.classList.remove('d-block');
                        }
                    });

                    ['name', 'phone', 'street', 'house_number', 'comment', 'privacy'].forEach(name => {
                        const input = form.querySelector(`[name="${name}"]`);
                        if (input) input.classList.remove('is-invalid');
                    });

                    if (submitBtn) submitBtn.disabled = true;

                    // Слушатели для полей
                    form.querySelectorAll('[name="name"], [name="phone"], [name="street"], [name="house_number"], [name="comment"], [name="privacy"]').forEach(input => {
                        input.addEventListener('input', () => checkFormValidity(form));
                    });

                    // Обработчик отправки формы
                    form.onsubmit = async function(e) {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        formData.append('privacy', privacyInput.checked ? 'on' : 'off');

                        try {
                            const submitUrl = `/${citySlug}/application/submit/`;
                            console.log('Отправка на:', submitUrl);
                            const response = await fetch(submitUrl, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            const data = await response.json();
                            console.log('Ответ сервера:', data);

                            if (response.ok && data.success) {
                                if (formContainer) formContainer.classList.add('hidden');
                                if (modalHeader) modalHeader.classList.add('hidden');
                                if (successMessage) successMessage.classList.remove('hidden');
                                // Автозакрытие через 5 секунд
                                setTimeout(() => {
                                    bsModal.hide();
                                }, 5000);
                            } else {
                                if (data.errors) {
                                    for (const [field, errors] of Object.entries(data.errors)) {
                                        const errorDiv = document.getElementById(`${field}Error`);
                                        if (errorDiv) {
                                            errorDiv.textContent = errors.join(' ');
                                            errorDiv.classList.add('d-block');
                                            const input = form.querySelector(`[name="${field}"]`);
                                            if (input) input.classList.add('is-invalid');
                                        }
                                    }
                                } else if (formErrors) {
                                    formErrors.classList.remove('hidden');
                                    formruheErrors.textContent = data.error || 'Произошла ошибка при отправке';
                                }
                            }
                        } catch (error) {
                            console.error('Ошибка fetch:', error);
                            if (formErrors) {
                                formErrors.classList.remove('hidden');
                                formErrors.textContent = `Ошибка: ${error.message}`;
                            }
                        }
                    };

                    // Сброс состояния при открытии формы
                    modal.addEventListener('show.bs.modal', () => {
                        if (modalHeader) modalHeader.classList.remove('hidden');
                        if (formContainer) formContainer.classList.remove('hidden');
                        if (successMessage) successMessage.classList.add('hidden');
                    });

                    // Очистка маски и слушателей при закрытии модального окна
                    modal.addEventListener('hidden.bs.modal', () => {
                        if (phoneMask) {
                            phoneMask.destroy();
                            phoneMask = null;
                        }
                        form.querySelectorAll('[name="name"], [name="phone"], [name="street"], [name="house_number"], [name="comment"], [name="privacy"]').forEach(input => {
                            input.removeEventListener('input', () => checkFormValidity(form));
                        });
                    }, { once: true });
                });
            });
        }

        filterButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const filterType = this.dataset.filter;
                history.pushState({}, '', `?type=${filterType}`);
                loadTariffs(filterType);
            });
        });

        window.addEventListener('popstate', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const filterType = urlParams.get('type') || 'internet';
            loadTariffs(filterType);
        });

        // Инициализация всех функций
        initAddressCheckForm();
        addConnectButtonListeners();
    });
</script>

<!-- JavaScript для поиска каналов -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function initChannelSearch() {
            document.querySelectorAll('.channel-search').forEach(function (searchInput) {
                const tariffId = searchInput.id.split('-')[1];
                const channelList = document.getElementById('channelList-' + tariffId);
                const channelItems = channelList.querySelectorAll('.channel-item');
                const categoryHeaders = channelList.querySelectorAll('.category-header');
    
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    let visibleCategories = new Set();
    
                    channelItems.forEach(function (item) {
                        const channelName = item.querySelector('span').textContent.toLowerCase();
                        const isVisible = channelName.includes(searchTerm);
                        item.style.display = isVisible ? '' : 'none';
                        if (isVisible) {
                            visibleCategories.add(item.dataset.category);
                        }
                    });
    
                    categoryHeaders.forEach(function (header) {
                        const categoryName = header.textContent;
                        header.style.display = visibleCategories.has(categoryName) ? '' : 'none';
                    });
                });
            });
        }
    
        // Инициализация при загрузке страницы
        initChannelSearch();
    
        // Повторная инициализация после AJAX (для HTMX)
        document.addEventListener('htmx:afterSwap', function () {
            initChannelSearch();
        });
    });
</script>
{% endblock %}