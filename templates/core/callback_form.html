{% load static %}
<div class="callback-modal" id="callbackModal" style="display: none;">
    <div class="callback-modal-backdrop" onclick="closeModal()"></div>
    <div class="callback-modal-content">
        <button class="callback-modal-close" onclick="closeModal()">×</button>
        <h3 class="callback-modal-title">Консультация от специалистов<br><span class="accent">АТК</span></h3>
        <p class="callback-modal-subtitle">Заполните данные, и наши специалисты свяжутся<br>с Вами в ближайшее время.</p>
        <form id="callbackForm" 
              method="post" 
              action="{% url 'core:feedback_form' locality_slug=request.locality.slug %}"
              hx-post="{% url 'core:feedback_form' locality_slug=request.locality.slug %}"
              hx-target="#callbackModal .callback-modal-content"
              hx-swap="innerHTML">
            {% csrf_token %}
            
            <input type="text" name="name" placeholder="Ваше имя" class="callback-input" required>
            
            <input type="tel" name="phone" id="phone" class="callback-input" placeholder="+7 (___) ___-__-__" required>
            
            <!-- Новые поля -->
            <input type="text" name="street" placeholder="Улица" class="callback-input">
            <input type="text" name="house" placeholder="Дом" class="callback-input">
            <input type="text" name="apartment" placeholder="Квартира" class="callback-input">
            
            <textarea name="content" placeholder="Ваше сообщение" class="callback-input" rows="3"></textarea>
            
            <button type="submit" class="callback-btn">Отправить</button>
            
            <label class="callback-checkbox">
                <input type="checkbox" required>
                Я согласен с 
                <a 
                    href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    class="callback-checkbox__link"
                >
                    Политикой конфиденциальности
                </a> 
                и разрешаю обработку персональных данных
            </label>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const callbackForm = document.getElementById('callbackForm');
        const phoneInput = callbackForm.querySelector('[name="phone"]');
        const phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false,
            placeholderChar: '_'
        });
    });

    function openModal() {
        const modal = document.getElementById('callbackModal');
        const body = document.body;

        // Сохраняем текущую позицию скролла
        const scrollY = window.scrollY;
        body.style.top = `-${scrollY}px`;
        body.classList.add('modal-open');

        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('callbackModal');
        const body = document.body;

        modal.style.display = 'none';

        // Убираем класс и восстанавливаем скролл
        body.classList.remove('modal-open');
        const scrollY = parseInt(body.style.top || '0') * -1;
        window.scrollTo(0, scrollY);
        body.style.top = '';
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Ensure modal is visible after HTMX content swap
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'callbackModal' || event.detail.target.classList.contains('callback-modal-content')) {
            document.getElementById('callbackModal').style.display = 'flex';
            // Если модалка открыта через HTMX — тоже блокируем скролл
            const body = document.body;
            if (!body.classList.contains('modal-open')) {
                const scrollY = window.scrollY;
                body.style.top = `-${scrollY}px`;
                body.classList.add('modal-open');
            }
        }
    });
</script>