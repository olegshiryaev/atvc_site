{% load compress %}
{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <meta name="description" content="{{ meta_tag.description|default:'Default Description' }}">
    <meta name="keywords" content="{{ meta_tag.keywords|default:'default, keywords' }}">
    <meta name="robots" content="{{ meta_tag.robots|default:'robots' }}">

    <!-- Open Graph meta tags -->
    <meta property="og:locale" content="ru_RU">
    <meta property="og:type" content="website">
    {% if meta_tag.og_title %}
        <meta property="og:title" content="{{ meta_tag.og_title }}">
    {% endif %}
    <meta property="og:site_name" content="{{ site_name }}">
    {% if meta_tag.og_description %}
        <meta property="og:description" content="{{ meta_tag.og_description }}">
    {% endif %}
    {% if meta_tag.og_image %}
        <meta property="og:image" content="{{ meta_tag.og_image.url }}">
    {% endif %}
    <meta property="og:url" content="{{ canonical_url }}">

    <link rel="canonical" href="{{ canonical_url }}" />

    <!-- Bootstrap CSS -->
    {% compress css %}
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    {% endcompress %}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="{% static 'fontawesome/css/all.min.css' %}">
    <!-- Swiper CSS -->
    {% comment %} <link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}" /> {% endcomment %}
    <!-- HTMX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–∫–∞ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω) -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    {% include 'partials/_navbar.html' %}

    <main class="page__main bg-white w-100">
        {% block content %}{% endblock %}
    </main>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ -->
    <button id="chat-toggle" class="chat-toggle-btn" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">üí¨ –ß–∞—Ç</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div id="chat-modal" class="chat-modal" role="dialog" aria-modal="true" aria-labelledby="chat-header-title" aria-hidden="true" tabindex="-1">
        <div class="chat-header">
            <strong id="chat-header-title">–û–Ω–ª–∞–π–Ω-—á–∞—Ç</strong>
            <button id="chat-close" class="chat-close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">√ó</button>
        </div>

        <div id="chat-error" class="chat-error" role="alert" aria-live="assertive"></div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ -->
        <div id="chat-user-form" class="chat-user-form">
            <input type="text" id="chat-name" class="chat-input" placeholder="–í–∞—à–µ –∏–º—è" aria-label="–í–∞—à–µ –∏–º—è" autocomplete="name" />
            <input type="text" id="chat-contact" class="chat-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email" aria-label="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email" autocomplete="email tel" />
            <button id="chat-start" class="chat-start-btn">–ù–∞—á–∞—Ç—å</button>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
        <div id="chat-messages" class="chat-messages" aria-live="polite" aria-relevant="additions"></div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ -->
        <div id="chat-typing-indicator" class="chat-typing-indicator" aria-live="polite" aria-atomic="true" style="display:none;">
            <span class="typing-text"><span id="typing-name"></span> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span></span>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="chat-input-wrapper" class="chat-input-wrapper" style="display:none;">
            <input type="text" id="chat-input" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off" />
            <button id="chat-send-btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚û§</button>
        </div>
    </div>

    {% include 'partials/_footer.html' %}

    <!-- Bootstrap JS -->
    <script defer src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <!-- IMask JS -->
    <script defer src="{% static 'js/imask.min.js' %}"></script>
    <!-- Alpine.js -->
    <script defer src="{% static 'js/alpinejs.min.js' %}" defer></script>
    <!-- Swiper JS -->
    <script defer src="{% static 'js/swiper-bundle.min.js' %}"></script>
    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ -->
    <script src="{% static 'js/order_modal.js' %}" defer></script>
    <script src="{% static 'js/channels_filter.js' %}" defer></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            console.log('Current URL:', window.location.pathname);
            window.localitySlug = "{{ request.locality.slug|default:''|escapejs }}";
            console.log('Initial locality slug:', window.localitySlug);
        });
        document.addEventListener('htmx:afterSwap', () => {
            console.log('HTMX afterSwap');
        });
    </script>
<script>
/* --- JS –ª–æ–≥–∏–∫–∞ —á–∞—Ç–∞ --- */

let sessionId = null;
let socket = null;
let isChatOpen = false;
const notificationSound = new Audio('/static/sounds/notification.mp3');

function escapeHTML(str) {
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
}

function showChatNotification() {
    document.getElementById('chat-toggle').classList.add('chat-notification');
}

function clearChatNotification() {
    document.getElementById('chat-toggle').classList.remove('chat-notification');
}

function sendTypingEvent(isTyping) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'typing',
            is_typing: isTyping,
            sender: localStorage.getItem('chatName') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
        }));
    }
}

function scrollChatToBottom() {
    const messagesBox = document.getElementById('chat-messages');
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addMessageToChat(data, isHistory = false) {
    const msg = document.createElement('div');
    msg.className = data.is_support ? 'message-support' : 'message-client';

    const date = new Date(data.timestamp);
    const time = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º sender ‚Äî –µ—Å–ª–∏ undefined, —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
    const senderName = data.sender || (data.is_support ? '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç' : '–ö–ª–∏–µ–Ω—Ç');

    msg.innerHTML = `<strong>${escapeHTML(senderName)}</strong> <span class="chat-time">${time}</span><br>${escapeHTML(data.message)}`;

    const messagesBox = document.getElementById('chat-messages');
    messagesBox.appendChild(msg);
    scrollChatToBottom();

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∞ –Ω–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
    if (!isHistory && (!isChatOpen || !document.hasFocus())) {
        notificationSound.play().catch(() => {});
        showChatNotification();
    }
}

function startChatWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${sessionId}/`);

    socket.onopen = () => console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'typing') {
            const typingIndicator = document.getElementById('chat-typing-indicator');
            const typingName = document.getElementById('typing-name');

            if (data.is_typing) {
                typingName.textContent = escapeHTML(data.sender || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
            return;
        }

        if (data.type === 'chat_message') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ history, –µ—Å–ª–∏ –Ω–µ—Ç - false –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            addMessageToChat(data, data.history || false);
        }
    };

    socket.onerror = () => {
        document.getElementById('chat-error').style.display = 'block';
        document.getElementById('chat-error').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —á–∞—Ç–æ–º';
    };

    socket.onclose = () => {
        document.getElementById('chat-error').style.display = 'block';
        document.getElementById('chat-error').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —á–∞—Ç–æ–º –∑–∞–∫—Ä—ã—Ç–æ, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...';
        setTimeout(startChatWebSocket, 5000);
    };
}

document.getElementById('chat-toggle').onclick = () => {
    document.getElementById('chat-modal').style.display = 'flex';
    isChatOpen = true;
    clearChatNotification();
};

document.getElementById('chat-close').onclick = () => {
    document.getElementById('chat-modal').style.display = 'none';
    if (socket) socket.close();

    document.getElementById('chat-messages').innerHTML = '';
    document.getElementById('chat-input').value = '';
    document.getElementById('chat-user-form').style.display = 'block';
    document.getElementById('chat-input-wrapper').style.display = 'none';
    document.getElementById('chat-error').textContent = '';

    localStorage.removeItem('chatSessionId');
    localStorage.removeItem('chatName');
    localStorage.removeItem('chatContact');
    isChatOpen = false;
    sendTypingEvent(false);
    clearChatNotification();
};

document.getElementById('chat-start').onclick = async () => {
    const name = document.getElementById('chat-name').value.trim();
    const contact = document.getElementById('chat-contact').value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const phoneRegex = /^\+?\d{10,15}$/;

    document.getElementById('chat-error').style.display = 'none';

    if (!name || (!emailRegex.test(contact) && !phoneRegex.test(contact))) {
        document.getElementById('chat-error').style.display = 'block';
        document.getElementById('chat-error').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –∏ –∫–æ–Ω—Ç–∞–∫—Ç (email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω)';
        return;
    }

    document.getElementById('chat-user-form').style.display = 'none';
    document.getElementById('chat-error').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏...';

    try {
        const response = await fetch('/chat/api/start/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ name, contact }),
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

        const data = await response.json();
        sessionId = data.session_id;

        localStorage.setItem('chatSessionId', sessionId);
        localStorage.setItem('chatName', name);
        localStorage.setItem('chatContact', contact);

        startChatWebSocket();
        document.getElementById('chat-messages').style.display = 'block';
        document.getElementById('chat-input-wrapper').style.display = 'flex';
        document.getElementById('chat-error').style.display = 'none';
    } catch (error) {
        document.getElementById('chat-error').style.display = 'block';
        document.getElementById('chat-error').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏';
        document.getElementById('chat-user-form').style.display = 'block';
    }
};

document.getElementById('chat-send-btn').onclick = () => {
    sendMessage();
};

document.getElementById('chat-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.value.trim() !== '') {
        sendMessage();
        e.preventDefault();
    }
});

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (message.length > 1000) {
        document.getElementById('chat-error').style.display = 'block';
        document.getElementById('chat-error').textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ';
        return;
    }
    if (message.length === 0) return;

    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            message: message,
            is_support: false
        }));
        input.value = '';
        sendTypingEvent(false);
    }
}

const input = document.getElementById('chat-input');
let typing = false;
let typingTimeout = null;

input.addEventListener('input', () => {
    if (!typing) {
        typing = true;
        sendTypingEvent(true);
    }
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        typing = false;
        sendTypingEvent(false);
    }, 3000);
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

window.addEventListener('load', () => {
    sessionId = localStorage.getItem('chatSessionId');
    const name = localStorage.getItem('chatName');
    const contact = localStorage.getItem('chatContact');

    if (sessionId && name && contact) {
        document.getElementById('chat-user-form').style.display = 'none';
        document.getElementById('chat-messages').style.display = 'block';
        document.getElementById('chat-input-wrapper').style.display = 'flex';
        startChatWebSocket();
    }
});

window.addEventListener('beforeunload', () => {
    sendTypingEvent(false);
});
</script>
</body>
</html>