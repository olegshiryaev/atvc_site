{% load compress %}
{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title|escape }}</title>
    <meta name="description" content="{{ meta_tag.description|default:'Default Description'|escape }}">
    <meta name="keywords" content="{{ meta_tag.keywords|default:'default, keywords'|escape }}">
    <meta name="robots" content="{{ meta_tag.robots|default:'index, follow'|escape }}">

    <!-- Open Graph meta tags -->
    <meta property="og:locale" content="ru_RU">
    <meta property="og:type" content="website">
    {% if meta_tag.og_title %}
        <meta property="og:title" content="{{ meta_tag.og_title|escape }}">
    {% endif %}
    <meta property="og:site_name" content="{{ site_name|escape }}">
    {% if meta_tag.og_description %}
        <meta property="og:description" content="{{ meta_tag.og_description|escape }}">
    {% endif %}
    {% if meta_tag.og_image %}
        <meta property="og:image" content="{{ meta_tag.og_image.url }}">
    {% endif %}
    <meta property="og:url" content="{{ canonical_url }}">

    <link rel="canonical" href="{{ canonical_url }}" />

    <!-- Yandex.Metrika counter -->
    {% if YANDEX_METRIKA_ID %}
    <script type="text/javascript" defer>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ú–µ—Ç—Ä–∏–∫–∏
        if (!window['disableYandexMetrika'] && !localStorage.getItem('cookieConsent') || localStorage.getItem('cookieConsent') === 'accepted') {
            (function(m,e,t,r,i,k,a){
                m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
                m[i].l=1*new Date();
                for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
                k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
            })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js?id={{ YANDEX_METRIKA_ID }}', 'ym');

            ym({{ YANDEX_METRIKA_ID }}, 'init', {
                ssr: true,
                webvisor: true,
                clickmap: true,
                ecommerce: "dataLayer",
                accurateTrackBounce: true,
                trackLinks: true
            });
        }
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/{{ YANDEX_METRIKA_ID }}" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    {% endif %}

    <!-- Bootstrap CSS -->
    {% compress css %}
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    {% endcompress %}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="{% static 'fontawesome/css/all.min.css' %}">
    <!-- Swiper CSS -->
    {% comment %} <link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}" /> {% endcomment %}
    <!-- HTMX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–∫–∞ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω) -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    {% include 'partials/_navbar.html' %}

    <main class="page__main bg-white w-100">
        {% block content %}{% endblock %}
    </main>

    <!-- –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏-->
    {% include "core/callback_form.html" %}

    <!-- Chat toggle button -->
    <button id="chat-toggle" class="chat-toggle-btn" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç" aria-expanded="false" aria-controls="chat-modal">
        <i class="fas fa-comments"></i>
        <span id="unread-count" class="chat-unread-count" style="display: none;">0</span>
    </button>

    <!-- Chat modal -->
    <div id="chat-modal" class="chat-modal" role="dialog" aria-modal="true" aria-labelledby="chat-header-title" aria-hidden="true" tabindex="-1">
        <div class="chat-header">
            <div>
                <strong id="chat-header-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</strong>
                <div id="chat-status" class="chat-status" data-status="pending">–û–∂–∏–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞...</div>
            </div>
            <button id="chat-close" class="chat-close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">√ó</button>
        </div>
        <div id="chat-error" class="chat-error" role="alert" aria-live="assertive"></div>

        <!-- User form -->
        <div id="chat-user-form" class="chat-user-form">
            <div class="chat-form-header">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
            <input type="text" id="chat-name" class="chat-input" placeholder="–í–∞—à–µ –∏–º—è" aria-label="–í–∞—à–µ –∏–º—è" aria-describedby="name-hint" autocomplete="name" required />
            <span id="name-hint" class="sr-only">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</span>
            <input type="text" id="chat-contact" class="chat-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email" aria-label="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email" aria-describedby="contact-hint" autocomplete="email tel" required pattern="^([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}|^\+?\d{10,15})$" />
            <span id="contact-hint" class="sr-only">–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>
            <button id="chat-start" class="chat-start-btn">–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
        </div>

        <!-- Chat messages -->
        <div id="chat-messages" class="chat-messages" aria-live="polite" aria-relevant="additions" style="display: none;"></div>

        <!-- Typing indicator -->
        <div id="chat-typing-indicator" class="chat-typing-indicator" aria-live="polite" aria-atomic="true" style="display:none;">
            <span class="typing-text"><span id="typing-name"></span> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>

        <!-- Message input -->
        <div id="chat-input-wrapper" class="chat-input-wrapper" style="display:none;">
            <input type="text" id="chat-input" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off" />
            <button id="chat-send-btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚û§</button>
            <label for="chat-file" class="chat-file-upload">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="chat-file" style="display:none;" accept="image/*,.pdf" />
        </div>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent" class="cookie-consent" role="dialog" aria-modal="true" aria-labelledby="cookie-consent-title">
        <div class="cookie-consent-content">
            <p id="cookie-consent-title">–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookie –∏ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∞–π—Ç, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.</p>
        </div>
        <div class="cookie-consent-buttons">
            <button id="cookie-accept" class="btn btn-primary">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button id="cookie-decline" class="btn btn-secondary">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
        </div>
    </div>

    {% include 'partials/_footer.html' %}

    <!-- Bootstrap JS -->
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <!-- IMask JS -->
    <script src="{% static 'js/imask.js' %}"></script>
    <!-- Alpine.js -->
    <script src="{% static 'js/alpinejs.min.js' %}"></script>
    <!-- Swiper JS -->
    <script defer src="{% static 'js/swiper-bundle.min.js' %}"></script>
    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ -->
    <script src="{% static 'js/cookie_consent.js' %}" defer></script>
    <script src="{% static 'js/offices.js' %}"></script>
    <script src="{% static 'js/order_modal.js' %}" defer></script>
    <script src="{% static 'js/channels_filter.js' %}" defer></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            console.log('Current URL:', window.location.pathname);
            window.localitySlug = "{{ request.locality.slug|default:''|escapejs }}";
            console.log('Initial locality slug:', window.localitySlug);
        });
        document.addEventListener('htmx:afterSwap', () => {
            console.log('HTMX afterSwap');
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const callbackForm = document.getElementById('callbackForm');

            if (!callbackForm) return;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const phoneInput = document.querySelector('[name="phone"]');
            const phoneMask = IMask(phoneInput, {
                mask: '+{7}(000)000-00-00',
                lazy: false,
                placeholderChar: '_'
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ
            function preparePhoneNumber(phoneValue) {
                const digits = phoneValue.replace(/\D/g, '');
                if (digits.length === 11 && digits.startsWith('7')) {
                    return '+7' + digits.substring(1);
                }
                return null;
            }

            function openModal() {
                document.getElementById('callbackModal').style.display = 'flex';
            }

            function closeModal() {
                document.getElementById('callbackModal').style.display = 'none';
            }

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });

            document.body.addEventListener('htmx:afterRequest', function(event) {
                if (event.detail.successful) {
                    closeModal();
                } else {
                    console.error('HTMX request failed:', event.detail.xhr.status);
                }
            });
        });
    </script>
<script>
    let sessionId = null;
    let socket = null;
    let isChatOpen = false;
    let unreadCount = 0;
    let lastDateHeader = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 3;
    const notificationSound = new Audio('/static/sounds/notification.mp3');
    const loadedMessageIds = new Set();
    let markReadTimeout = null;

    function escapeHTML(str) {
        const escapeMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };
        return str.replace(/[&<>"']/g, char => escapeMap[char]);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return `${bytes} –ë`;
        const kb = bytes / 1024;
        if (kb < 1024) return `${kb.toFixed(1)} –ö–ë`;
        const mb = kb / 1024;
        return `${mb.toFixed(1)} –ú–ë`;
    }

    function updateUnreadCount(count) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ unread_count:', count);
        unreadCount = count;
        const unreadBadge = document.getElementById('unread-count');
        unreadBadge.textContent = count;
        unreadBadge.style.display = count > 0 ? 'block' : 'none';
    }

    function showChatNotification() {
        document.getElementById('chat-toggle').classList.add('chat-notification');
        updateUnreadCount(unreadCount);
    }

    function clearChatNotification() {
        document.getElementById('chat-toggle').classList.remove('chat-notification');
        updateUnreadCount(0);
    }

    function sendTypingEvent(isTyping) {
        if (socket?.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'typing',
                is_typing: isTyping,
                sender: localStorage.getItem('chatName') || '–ö–ª–∏–µ–Ω—Ç'
            }));
        }
    }

    function scrollChatToBottom() {
        const messagesBox = document.getElementById('chat-messages');
        if (messagesBox && getComputedStyle(messagesBox).display !== 'none') {
            console.log('–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é, scrollHeight:', messagesBox.scrollHeight);
            requestAnimationFrame(() => {
                messagesBox.scrollTo({ top: messagesBox.scrollHeight, behavior: 'auto' });
                console.log('–ü–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, scrollTop:', messagesBox.scrollTop);
            });
        } else {
            console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #chat-messages –Ω–µ–≤–∏–¥–∏–º –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–∞');
        }
    }

    function formatDateHeader(timestamp) {
        const date = new Date(timestamp);
        const today = new Date();
        let headerText = '';
        if (date.toDateString() === today.toDateString()) {
            headerText = '–°–µ–≥–æ–¥–Ω—è';
        } else if (new Date(today.setDate(today.getDate() - 1)).toDateString() === date.toDateString()) {
            headerText = '–í—á–µ—Ä–∞';
        } else {
            headerText = date.toLocaleDateString('ru-RU');
        }
        return headerText;
    }

    function addMessageToChat(data, isHistory = false) {
        if (loadedMessageIds.has(data.message_id)) {
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, message_id:', data.message_id);
            return;
        }
        loadedMessageIds.add(data.message_id);

        const fragment = document.createDocumentFragment();
        const currentHeader = formatDateHeader(data.timestamp);
        if (currentHeader !== lastDateHeader) {
            const dateDivider = document.createElement('div');
            dateDivider.className = 'chat-date-divider';
            dateDivider.innerText = currentHeader;
            fragment.appendChild(dateDivider);
            lastDateHeader = currentHeader;
        }

        const msg = document.createElement('div');
        msg.className = data.is_support ? 'message-support' : 'message-client';
        msg.dataset.messageId = data.message_id;
        const time = new Date(data.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', hour12: false });
        const senderName = escapeHTML(data.sender || (data.is_support ? '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç' : localStorage.getItem('chatName') || '–ö–ª–∏–µ–Ω—Ç'));
        let messageContent = escapeHTML(data.message);
        if (data.attachment) {
            if (data.attachment.match(/\.(jpg|jpeg|png|gif)$/i)) {
                messageContent = `<img src="${data.attachment}" alt="–í–ª–æ–∂–µ–Ω–∏–µ" style="max-width: 100%; border-radius: 8px;" />`;
            } else {
                let fileName = data.attachment.split('/').pop();
                if (fileName.includes('_') && fileName.length > 37) {
                    fileName = fileName.substring(37);
                }
                const icon = fileName.endsWith('.pdf') ? '<span class="file-icon">üìÑ</span>' : '<span class="file-icon">üìé</span>';
                const fileSize = data.file_size ? ` (${formatFileSize(data.file_size)})` : '';
                messageContent = `<a href="${data.attachment}" target="_blank">${icon} ${escapeHTML(decodeURIComponent(fileName))}${fileSize}</a>`;
            }
        }

        msg.innerHTML = `
            <div class="chat-message-bubble">${messageContent}</div>
            <div class="chat-message-footer">
                <span class="chat-sender">${senderName}</span>
                <span class="chat-time">${time}</span>
            </div>
        `;
        fragment.appendChild(msg);
        const messagesBox = document.getElementById('chat-messages');
        messagesBox.appendChild(fragment);

        if (!isHistory && isChatOpen) {
            if (data.attachment && data.attachment.match(/\.(jpg|jpeg|png|gif)$/i)) {
                const img = msg.querySelector('img');
                if (img.complete) {
                    scrollChatToBottom();
                } else {
                    img.onload = () => scrollChatToBottom();
                    img.onerror = () => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', data.attachment);
                        scrollChatToBottom();
                    };
                }
            } else {
                scrollChatToBottom();
            }
        }

        if (!isHistory && data.is_support && (!isChatOpen || !document.hasFocus())) {
            unreadCount++;
            console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, unreadCount —É–≤–µ–ª–∏—á–µ–Ω –¥–æ:', unreadCount);
            notificationSound.play().catch(() => {});
            if ('vibrate' in navigator) navigator.vibrate(200);
            showChatNotification();
        }
    }

    function showError(message, persistent = false) {
        const errorDiv = document.getElementById('chat-error');
        errorDiv.innerHTML = message;
        errorDiv.style.display = 'block';
        if (!persistent) {
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
    }

    function updateChatStatus(status, message) {
        const statusDiv = document.getElementById('chat-status');
        statusDiv.textContent = message;
        statusDiv.setAttribute('data-status', status);
    }

    async function checkSessionStatus(sessionId) {
        try {
            const response = await fetch(`/chat/api/history/${sessionId}/`, {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (!response.ok) {
                updateChatStatus('closed', '–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
                return;
            }
            const messages = await response.json();
            const hasSupportMessages = messages.some(msg => msg.is_support);
            updateChatStatus(
                hasSupportMessages ? 'connected' : 'pending',
                hasSupportMessages ? '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–∞ —Å–≤—è–∑–∏' : '–û–∂–∏–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞...'
            );
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏:', error);
            updateChatStatus('disconnected', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const trimmed = cookie.trim();
                if (trimmed.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                    break;
                }
            }
        }
        if (!cookieValue) console.warn('CSRF-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return cookieValue;
    }

    async function markMessagesAsRead() {
        if (!sessionId || !isChatOpen) {
            console.log('markMessagesAsRead –ø—Ä–æ–ø—É—â–µ–Ω: sessionId –∏–ª–∏ isChatOpen –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
            return;
        }
        if (markReadTimeout) {
            console.log('markMessagesAsRead —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            return;
        }
        markReadTimeout = setTimeout(async () => {
            try {
                if (socket?.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'mark_read' }));
                    console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å mark_read —á–µ—Ä–µ–∑ WebSocket –¥–ª—è sessionId:', sessionId);
                } else {
                    console.warn('WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º HTTP –¥–ª—è mark_read');
                    const response = await fetch(`/chat/api/mark_read/${sessionId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                    if (response.ok) {
                        console.log('–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ HTTP');
                        await updateUnreadCountFromServer();
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ HTTP:', response.status);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ mark_read:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö.');
            }
            markReadTimeout = null;
        }, 500);
    }

    function startChatWebSocket() {
        const contact = encodeURIComponent(localStorage.getItem('chatContact') || '');
        if (!contact || !sessionId) {
            showError('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ ID —Å–µ—Å—Å–∏–∏.', true);
            return;
        }
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${sessionId}/?token=${contact}&skip_history=true`);
        socket.onopen = () => {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            reconnectAttempts = 0;
            updateChatStatus('pending', '–û–∂–∏–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞...');
            updateUnreadCountFromServer();
        };
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
            if (data.type === 'error') {
                showError(data.message, true);
                if (data.message.includes('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞') || data.message.includes('–°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞')) {
                    updateChatStatus('closed', '–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
                    document.getElementById('chat-input').disabled = true;
                    document.getElementById('chat-send-btn').disabled = true;
                    document.getElementById('chat-input-wrapper').style.opacity = '0.5';
                    document.getElementById('chat-input-wrapper').style.pointerEvents = 'none';
                    localStorage.removeItem('chatSessionId');
                    localStorage.removeItem('chatName');
                    localStorage.removeItem('chatContact');
                    localStorage.setItem('chatOpen', 'false');
                    isChatOpen = false;
                    document.getElementById('chat-user-form').style.display = 'block';
                    document.getElementById('chat-messages').style.display = 'none';
                    document.getElementById('chat-input-wrapper').style.display = 'none';
                }
                return;
            }
            if (data.type === 'typing') {
                const typingIndicator = document.getElementById('chat-typing-indicator');
                const typingName = document.getElementById('typing-name');
                typingName.textContent = escapeHTML(data.sender || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
                typingIndicator.style.display = data.is_typing ? 'block' : 'none';
                if (data.is_typing && data.sender !== localStorage.getItem('chatName')) {
                    updateChatStatus('connected', '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–∞ —Å–≤—è–∑–∏');
                }
                return;
            }
            if (data.type === 'chat_message') {
                addMessageToChat(data, data.history || false);
                if (data.is_support) {
                    updateChatStatus('connected', '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–∞ —Å–≤—è–∑–∏');
                }
            }
            if (data.type === 'read_status') {
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ read_status, unread_count:', data.unread_count);
                updateUnreadCount(data.unread_count);
                if (data.unread_count === 0) clearChatNotification();
            }
            if (data.type === 'session_closed') {
                showError(data.message, true);
                updateChatStatus('closed', '–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
                document.getElementById('chat-input').disabled = true;
                document.getElementById('chat-send-btn').disabled = true;
                document.getElementById('chat-input-wrapper').style.opacity = '0.5';
                document.getElementById('chat-input-wrapper').style.pointerEvents = 'none';
                localStorage.removeItem('chatSessionId');
                localStorage.removeItem('chatName');
                localStorage.removeItem('chatContact');
                localStorage.setItem('chatOpen', 'false');
                isChatOpen = false;
                document.getElementById('chat-user-form').style.display = 'block';
                document.getElementById('chat-messages').style.display = 'none';
                document.getElementById('chat-input-wrapper').style.display = 'none';
            }
            if (data.type === 'status_update') {
                updateChatStatus(data.status, data.message);
            }
        };
        socket.onerror = () => {
            showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —á–∞—Ç–æ–º');
            updateChatStatus('disconnected', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
        };
        socket.onclose = () => {
            showError('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —á–∞—Ç–æ–º –∑–∞–∫—Ä—ã—Ç–æ.');
            updateChatStatus('disconnected', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
            if (reconnectAttempts < maxReconnectAttempts) {
                setTimeout(startChatWebSocket, 5000 * (reconnectAttempts + 1));
                reconnectAttempts++;
            } else {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —á–∞—Ç—É. <button onclick="reconnectChat()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>', true);
            }
        };
    }

    function reconnectChat() {
        reconnectAttempts = 0;
        startChatWebSocket();
    }

    async function updateUnreadCountFromServer() {
        if (!sessionId) return;
        try {
            const response = await fetch(`/chat/api/unread/?session_id=${sessionId}`);
            const data = await response.json();
            console.log('–ü–æ–ª—É—á–µ–Ω unread_count:', data.unread);
            updateUnreadCount(data.unread);
            if (data.unread > 0 && !isChatOpen) showChatNotification();
            else if (data.unread === 0) clearChatNotification();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }

    function startStatusCheck(sessionId) {
        setInterval(() => {
            if (socket?.readyState !== WebSocket.OPEN && sessionId) {
                checkSessionStatus(sessionId);
            }
        }, 30000);
    }

    function toggleChatModal(show) {
        const modal = document.getElementById('chat-modal');
        modal.style.display = show ? 'flex' : 'none';
        modal.setAttribute('aria-hidden', show ? 'false' : 'true');
        isChatOpen = show;
        localStorage.setItem('chatOpen', show ? 'true' : 'false');
        if (show) {
            modal.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
            document.getElementById('chat-name').focus();
            if (sessionId) {
                checkSessionStatus(sessionId);
                scrollChatToBottom();
                updateUnreadCountFromServer();
            }
        } else {
            modal.removeEventListener('touchmove', (e) => e.preventDefault());
        }
    }

    document.getElementById('chat-toggle').onclick = () => {
        toggleChatModal(true);
        clearChatNotification();
    };

    document.getElementById('chat-close').onclick = () => {
        toggleChatModal(false);
        sendTypingEvent(false);
    };

    document.getElementById('chat-start').onclick = async () => {
        const name = document.getElementById('chat-name').value.trim();
        const contact = document.getElementById('chat-contact').value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^\+?\d{10,15}$/;
        document.getElementById('chat-error').style.display = 'none';

        if (!name) {
            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.');
            document.getElementById('chat-name').classList.add('error');
            return;
        }
        if (!emailRegex.test(contact) && !phoneRegex.test(contact)) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (10-15 —Ü–∏—Ñ—Ä).');
            document.getElementById('chat-contact').classList.add('error');
            return;
        }

        document.getElementById('chat-name').classList.remove('error');
        document.getElementById('chat-contact').classList.remove('error');
        document.getElementById('chat-user-form').style.display = 'none';
        showError('–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏...');

        try {
            const response = await fetch('/chat/api/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ name, contact }),
            });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            const data = await response.json();
            sessionId = data.session_id;
            localStorage.setItem('chatSessionId', sessionId);
            localStorage.setItem('chatName', name);
            localStorage.setItem('chatContact', contact);
            localStorage.setItem('chatOpen', 'true');
            isChatOpen = true;
            document.getElementById('chat-messages').innerHTML = '';
            loadedMessageIds.clear();
            lastDateHeader = null;
            document.getElementById('chat-messages').style.display = 'flex';
            document.getElementById('chat-input-wrapper').style.display = 'flex';
            document.getElementById('chat-error').style.display = 'none';
            document.getElementById('chat-input').focus();
            try {
                const response = await fetch(`/chat/api/history/${sessionId}/`);
                if (!response.ok) throw new Error('–°–µ—Å—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                const messages = await response.json();
                messages.forEach(msg => addMessageToChat(msg, true));
                requestAnimationFrame(() => {
                    scrollChatToBottom();
                    console.log('–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏');
                });
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.');
            }
            startChatWebSocket();
            checkSessionStatus(sessionId);
            startStatusCheck(sessionId);
            toggleChatModal(true);
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            document.getElementById('chat-user-form').style.display = 'block';
        }
    };

    document.getElementById('chat-send-btn').onclick = () => sendMessage();
    document.getElementById('chat-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.value.trim() !== '') {
            sendMessage();
            e.preventDefault();
        }
    });

    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (message.length > 1000) {
            showError('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤).');
            return;
        }
        if (message.length === 0) return;
        if (socket?.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'chat_message',
                message: message,
                is_support: false,
                sender: localStorage.getItem('chatName') || '–ö–ª–∏–µ–Ω—Ç'
            }));
            input.value = '';
            sendTypingEvent(false);
        } else {
            showError('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', true);
        }
    }

    document.getElementById('chat-file').addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
            showError('–§–∞–π–ª –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë.');
            this.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('session_id', sessionId);

        try {
            const response = await fetch('/chat/api/upload/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const result = await response.json();
            if (response.ok) {
                if (!result.file_url.startsWith('/media/chat_attachments/')) {
                    showError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π URL –≤–ª–æ–∂–µ–Ω–∏—è');
                    console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π file_url:', result.file_url);
                    this.value = '';
                    return;
                }
                socket.send(JSON.stringify({
                    type: 'chat_message',
                    message: '[–§–∞–π–ª]',
                    is_support: false,
                    sender: localStorage.getItem('chatName') || '–ö–ª–∏–µ–Ω—Ç',
                    attachment: result.file_url,
                    file_size: result.file_size
                }));
                this.value = '';
            } else {
                showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.');
            }
        } catch (err) {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.');
        }
    });

    const input = document.getElementById('chat-input');
    let typing = false;
    let typingTimeout = null;
    input.addEventListener('input', () => {
        const maxLength = 1000;
        if (input.value.length > maxLength) {
            input.value = input.value.slice(0, maxLength);
            showError('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ 1000 —Å–∏–º–≤–æ–ª–æ–≤.');
        }
        if (!typing) {
            typing = true;
            sendTypingEvent(true);
        }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typing = false;
            sendTypingEvent(false);
        }, 3000);
    });

    input.addEventListener('focus', () => {
        if (sessionId && isChatOpen) {
            console.log('–§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞, –≤—ã–∑–æ–≤ markMessagesAsRead');
            markMessagesAsRead();
        }
    });

    document.getElementById('chat-messages').addEventListener('scroll', async () => {
        const messagesBox = document.getElementById('chat-messages');
        if (messagesBox.scrollTop === 0 && sessionId) {
            const messageElements = messagesBox.querySelectorAll('[data-message-id]').length;
            const offset = messageElements;
            console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, offset:', offset);
            try {
                const response = await fetch(`/chat/api/history/${sessionId}/?offset=${offset}`);
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
                }
                const messages = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', messages.length);
                if (messages.length === 0) {
                    console.log('–ë–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç');
                    return;
                }
                const previousScrollHeight = messagesBox.scrollHeight;
                messages.forEach(msg => addMessageToChat(msg, true));
                const newScrollHeight = messagesBox.scrollHeight;
                messagesBox.scrollTop = newScrollHeight - previousScrollHeight;
                console.log('–ü–æ–¥–≥—Ä—É–∂–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ–≤—ã–π scrollTop:', messagesBox.scrollTop);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞.');
            }
        }
    });

    window.addEventListener('load', async () => {
        sessionId = localStorage.getItem('chatSessionId');
        const name = localStorage.getItem('chatName');
        const contact = localStorage.getItem('chatContact');
        const chatOpen = localStorage.getItem('chatOpen') === 'true';
        if (sessionId && name && contact) {
            try {
                const response = await fetch(`/chat/api/history/${sessionId}/`);
                if (!response.ok) {
                    localStorage.removeItem('chatSessionId');
                    localStorage.removeItem('chatName');
                    localStorage.removeItem('chatContact');
                    localStorage.setItem('chatOpen', 'false');
                    document.getElementById('chat-user-form').style.display = 'block';
                    showError('–°–µ—Å—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç.', true);
                    updateChatStatus('closed', '–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
                    return;
                }
                document.getElementById('chat-user-form').style.display = 'none';
                document.getElementById('chat-messages').style.display = 'flex';
                document.getElementById('chat-input-wrapper').style.display = 'flex';
                document.getElementById('chat-messages').innerHTML = '';
                loadedMessageIds.clear();
                lastDateHeader = null;
                const messages = await response.json();
                messages.forEach(msg => addMessageToChat(msg, true));
                if (chatOpen) {
                    toggleChatModal(true);
                    clearChatNotification();
                    requestAnimationFrame(() => {
                        scrollChatToBottom();
                        console.log('–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                    });
                }
                startChatWebSocket();
                checkSessionStatus(sessionId);
                startStatusCheck(sessionId);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏.', true);
                updateChatStatus('disconnected', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                localStorage.setItem('chatOpen', 'false');
            }
        }
        await updateUnreadCountFromServer();
    });

    window.addEventListener('beforeunload', () => {
        sendTypingEvent(false);
    });
</script>
    {% block extra_js %}{% endblock %}
</body>
</html>