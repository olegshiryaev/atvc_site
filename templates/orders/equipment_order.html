{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <div class="order-form__layout">
            {% if product_item.in_stock > 0 %}
                <div class="order-form__main">
                    <!-- Информация о товаре -->
                    <section class="product-order">
                        <div class="product-order__content">
                            <!-- Изображение слева -->
                            <div class="product-order__image" id="productImageContainer">
                                {% with main_image=product_item.get_main_image %}
                                    {% if main_image %}
                                        <img src="{{ main_image.image.url }}" alt="{{ product_item.get_display_name }}" class="product-order__img" id="productImage">
                                    {% else %}
                                        <div class="product-order__img-placeholder" id="productImagePlaceholder">
                                            <span>Нет изображения</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <!-- Название, цвет и цена -->
                            <div class="product-order__details">
                                <div class="product-order__header">
                                    <!-- Название слева -->
                                    <div class="product-order__title-wrapper">
                                        <h3 class="product-order__title">
                                            <a href="{% url 'equipments:product_detail' locality_slug=locality.slug slug=product_item.slug %}"
                                            class="product-order__link"
                                            title="Подробнее о {{ product_item.get_display_name }}">
                                                {{ product_item.get_display_name }}
                                            </a>
                                        </h3>
                                        <!-- Цвет -->
                                        {% if product_item.color %}
                                            <div class="product-order__color-info">
                                                <span class="product-order__color-label">Цвет:</span>
                                                <span class="product-order__color-name">{{ product_item.color.name|lower }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <!-- Цена справа -->
                                    <div class="product-order__price-block">
                                        <div class="product-order__price-value" id="current-price-display">
                                            {{ product_item.get_price_display }}
                                        </div>
                                        {% if product_item.old_price %}
                                            <div class="product-order__old-price">
                                                {{ product_item.old_price|intcomma }} ₽
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {% if product_item.installment_available %}
                    <!-- Способ приобретения оборудования -->
                    <section class="payment-methods">
                        <h3 class="payment-methods__title">Выберите подходящий вариант оплаты</h3>
                        <div class="payment-methods__options">
                            <label class="payment-method">
                                <input 
                                    type="radio" 
                                    name="payment_type" 
                                    value="purchase" 
                                    {% if selected_payment_type == 'purchase' %}checked{% endif %}
                                    data-price="{{ product_item.get_final_price }}"
                                >
                                <span class="payment-method__content">
                                    <span class="payment-method__title">Полная стоимость</span>
                                    <span class="payment-method__price">{{ product_item.get_final_price|intcomma }} ₽</span>
                                </span>
                            </label>
                            {% if product_item.installment_12_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment12"
                                        {% if selected_payment_type == 'installment12' %}checked{% endif %}
                                        data-price="{{ product_item.installment_12_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">Рассрочка на 12 месяцев</span>
                                        <span class="payment-method__price">{{ product_item.installment_12_months|intcomma }} ₽/мес.</span>
                                    </span>
                                </label>
                            {% endif %}
                            {% if product_item.installment_24_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment24"
                                        {% if selected_payment_type == 'installment24' %}checked{% endif %}
                                        data-price="{{ product_item.installment_24_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">Рассрочка на 24 месяца</span>
                                        <span class="payment-method__price">{{ product_item.installment_24_months|intcomma }} ₽/мес.</span>
                                    </span>
                                </label>
                            {% endif %}
                            {% if product_item.installment_48_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment48"
                                        {% if selected_payment_type == 'installment48' %}checked{% endif %}
                                        data-price="{{ product_item.installment_48_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">Рассрочка на 48 месяцев</span>
                                        <span class="payment-method__price">{{ product_item.installment_48_months|intcomma }} ₽/мес.</span>
                                    </span>
                                </label>
                            {% endif %}
                        </div>         
                    </section>
                    {% endif %}

                    <!-- Блок итогов (на мобильных — между товаром и формой) -->
                    <aside class="summary summary--mobile">
                        <div class="summary__content">
                            <h3 class="summary__title">Заявка на оборудование</h3>
                            <div class="summary__section" id="equipmentSummaryMobile">
                                <h5 class="summary__section-title">Оборудование</h5>
                                <div class="summary__item">
                                    <span class="summary__item-name">{{ product_item.get_display_name }}</span>
                                    <span class="summary__item-value" id="summary-price-mobile">{{ product_item.get_price_display }}</span>
                                </div>
                            </div>
                            <div class="summary__total">
                                <h5 class="summary__total-title">Итого к оплате</h5>
                                <h5 class="summary__total-value" id="summary-total-mobile">{{ product_item.get_price_display }}</h5>
                            </div>
                        </div>
                    </aside>

                    <!-- Форма заявки -->
                    <section class="order-form__section">
                        <h3 class="order-form__section-title">Оформление заявки</h3>
                        <noscript>
                            <div class="alert alert-danger">Для корректной работы формы требуется включённый JavaScript.</div>
                        </noscript>

                        <!-- 🔥 КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Добавляем атрибуты HTMX -->
                        <form class="order-form__form" 
                              id="orderForm" 
                              method="post" 
                              action="{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=product_item.id %}"
                              hx-post="{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=product_item.id %}"
                              hx-target="#orderFormContainer"
                              hx-swap="outerHTML"
                              hx-indicator="#submit-button"
                              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            {% csrf_token %}
                            <div class="order-form__fields">
                                <!-- Имя -->
                                <div class="order-form__field order-form__field--full-name">
                                    <label for="id_full_name" class="order-form__label">Ваше имя</label>
                                    {{ form.full_name }}
                                    <div id="error_full_name" class="order-form__validation-message">
                                        {% if form.full_name.errors %}{{ form.full_name.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- Телефон -->
                                <div class="order-form__field order-form__field--phone">
                                    <label for="id_phone" class="order-form__label">Номер телефона</label>
                                    {{ form.phone }}
                                    <div id="error_phone" class="order-form__validation-message">
                                        {% if form.phone.errors %}{{ form.phone.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- Второй ряд: Улица, Дом, Квартира -->
                                <div class="order-form__row--address">
                                    <!-- Улица -->
                                    <div class="order-form__field order-form__field--street">
                                        <label for="id_street" class="order-form__label">Улица</label>
                                        {{ form.street }}
                                        <div id="error_street" class="order-form__validation-message">
                                            {% if form.street.errors %}{{ form.street.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                    <!-- Дом -->
                                    <div class="order-form__field order-form__field--house">
                                        <label for="id_house" class="order-form__label">Дом</label>
                                        {{ form.house }}
                                        <div id="error_house" class="order-form__validation-message">
                                            {% if form.house.errors %}{{ form.house.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                    <!-- Квартира -->
                                    <div class="order-form__field order-form__field--apartment">
                                        <label for="id_apartment" class="order-form__label">Квартира</label>
                                        {{ form.apartment }}
                                        <div id="error_apartment" class="order-form__validation-message">
                                            {% if form.apartment.errors %}{{ form.apartment.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <!-- Комментарий -->
                                <div class="order-form__field order-form__field--comments">
                                    <label for="id_comment" class="order-form__label">Комментарий (необязательно)</label>
                                    {{ form.comment }}
                                    <div id="error_comment" class="order-form__validation-message">
                                        {% if form.comment.errors %}{{ form.comment.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- Скрытые поля (не отображаем) -->
                                {{ form.product_item_id }}
                                {{ form.payment_type }}
                                {{ form.tariff_id }}
                                {{ form.selected_equipment_ids }}
                                {{ form.equipment_payment_options }}
                                {{ form.selected_service_slugs }}
                                {{ form.selected_tv_package_ids }}
                                <!-- Общие ошибки формы -->
                                <div id="form-errors" class="error-container">
                                    {% if form.non_field_errors %}
                                        <ul class="errorlist">
                                            {% for error in form.non_field_errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Согласие и кнопка -->
                            <div class="order-form__field order-form__field--actions">
                                <div class="order-form__consent-text">
                                    Нажимая кнопку «Отправить заявку», вы соглашаетесь с 
                                    <a target="_blank" class="order-form__link" href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" rel="noopener noreferrer">
                                        Условиями обработки персональных данных
                                    </a>
                                </div>
                                <button type="submit" class="order-form__submit" id="submit-button" disabled aria-label="Отправить заявку на подключение">Отправить заявку</button>
                            </div>
                        </form>
                    </section>
                </div>

                <!-- Боковая панель с итогами (для десктопа) -->
                <aside class="summary summary--desktop">
                    <div class="summary__content">
                        <h3 class="summary__title">Заявка на оборудование</h3>
                        <div class="summary__section" id="equipmentSummary">
                            <h5 class="summary__section-title">Оборудование</h5>
                            <div class="summary__item">
                                <span class="summary__item-name">{{ product_item.get_display_name }}</span>
                                <span class="summary__item-value" id="summary-price">{{ product_item.get_price_display }}</span>
                            </div>
                        </div>
                        <div class="summary__total">
                            <h5 class="summary__total-title">Итого к оплате</h5>
                            <h5 class="summary__total-value" id="summary-total">{{ product_item.get_price_display }}</h5>
                        </div>
                    </div>
                </aside>
            {% else %}
                <div class="alert alert-danger">
                    Выбранная товарная позиция недоступна или отсутствует на складе. Пожалуйста, выберите другой товар.
                    <a href="{% url 'equipments:product_list' locality_slug=locality.slug %}" class="btn btn-primary">Вернуться к каталогу</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 🔥 КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Подключаем HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/imask@7/dist/imask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const phoneInput = document.querySelector('#orderForm [name="phone"]');
    const submitButton = document.querySelector('#submit-button');
    const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
    const priceDisplay = document.querySelector('#current-price-display');
    const summaryPrice = document.querySelector('#summary-price');
    const summaryTotal = document.querySelector('#summary-total');

    // Проверка доступности JavaScript
    if (typeof IMask === 'undefined') {
        document.getElementById('form-errors').innerHTML = '<ul class="errorlist"><li>Для корректной работы формы требуется включённый JavaScript.</li></ul>';
        submitButton.disabled = true;
        return;
    }

    // Маска телефона
    let phoneMask = null;
    if (phoneInput) {
        phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false
        });
    }

    // Подготовка номера телефона
    function preparePhoneNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11 && ['7', '8'].includes(digits[0])) {
            return '+7' + digits.slice(1);
        }
        return null;
    }

    // Валидация формы
    function validateOrderForm() {
        const fullName = document.querySelector('#orderForm [name="full_name"]').value.trim();
        const phoneValid = phoneMask && preparePhoneNumber(phoneMask.unmaskedValue);
        submitButton.disabled = !(fullName.length >= 3 && phoneValid);
    }

    // Обновление цены
    function updatePrice() {
        const selectedPayment = document.querySelector('input[name="payment_type"]:checked')?.value || 'purchase';
        const price = document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`)?.dataset.price || {{ product_item.get_final_price }};
        const isMonthly = selectedPayment !== 'purchase';
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(price) + ' ₽' + (isMonthly ? '/мес.' : '');
        // Обновляем отображение цены
        priceDisplay.textContent = formattedPrice;
        summaryPrice.textContent = formattedPrice;
        summaryTotal.textContent = formattedPrice;
        // 🔥 Обновляем мобильную версию итогов
        document.querySelector('#summary-price-mobile').textContent = formattedPrice;
        document.querySelector('#summary-total-mobile').textContent = formattedPrice;
        // Обновляем поле формы
        document.querySelector('#orderForm [name="payment_type"]').value = selectedPayment;
        // Активация выбранного способа оплаты
        paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
        document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`).parentElement.classList.add('active');
    }

    // Слушатели на ввод
    document.querySelectorAll('#orderForm [name="full_name"], #orderForm [name="phone"]').forEach(el => {
        el.addEventListener('input', validateOrderForm);
    });

    // Слушатели на выбор способа оплаты
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', updatePrice);
    });

    // Начальная валидация и обновление цены
    validateOrderForm();
    updatePrice();

    // 🔥 КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Добавляем глобальные обработчики для HTMX
    document.body.addEventListener('htmx:beforeSend', function(evt) {
        const btn = evt.detail.elt;
        if (btn.id === 'submit-button') {
            btn.disabled = true;
            btn.classList.add('order-form__submit--loading');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Отправка...';
        }
    });
    document.body.addEventListener('htmx:afterSettle', function(evt) {
        const btn = evt.detail.elt;
        if (btn.id === 'submit-button') {
            btn.disabled = false;
            btn.classList.remove('order-form__submit--loading');
            btn.innerHTML = 'Отправить заявку';
        }
    });
});
</script>
{% endblock %}