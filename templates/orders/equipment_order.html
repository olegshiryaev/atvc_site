{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <div class="order-form__layout">
            {% if product_item.in_stock > 0 %}
                <div class="order-form__main">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                    <section class="product-order">
                        <div class="product-order__content">
                            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–µ–≤–∞ -->
                            <div class="product-order__image" id="productImageContainer">
                                {% with main_image=product_item.get_main_image %}
                                    {% if main_image %}
                                        <img src="{{ main_image.image.url }}" alt="{{ product_item.get_display_name }}" class="product-order__img" id="productImage">
                                    {% else %}
                                        <div class="product-order__img-placeholder" id="productImagePlaceholder">
                                            <span>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ, —Ü–≤–µ—Ç –∏ —Ü–µ–Ω–∞ -->
                            <div class="product-order__details">
                                <div class="product-order__header">
                                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–µ–≤–∞ -->
                                    <div class="product-order__title-wrapper">
                                        <h3 class="product-order__title">
                                            <a href="{% url 'equipments:product_detail' locality_slug=locality.slug slug=product_item.slug %}"
                                            class="product-order__link"
                                            title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ {{ product_item.get_display_name }}">
                                                {{ product_item.get_display_name }}
                                            </a>
                                        </h3>
                                        <!-- –¶–≤–µ—Ç -->
                                        {% if product_item.color %}
                                            <div class="product-order__color-info">
                                                <span class="product-order__color-label">–¶–≤–µ—Ç:</span>
                                                <span class="product-order__color-name">{{ product_item.color.name|lower }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <!-- –¶–µ–Ω–∞ —Å–ø—Ä–∞–≤–∞ -->
                                    <div class="product-order__price-block">
                                        <div class="product-order__price-value" id="current-price-display">
                                            {{ product_item.get_price_display }}
                                        </div>
                                        {% if product_item.old_price %}
                                            <div class="product-order__old-price">
                                                {{ product_item.old_price|intcomma }} ‚ÇΩ
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {% if product_item.installment_available %}
                    <!-- –°–ø–æ—Å–æ–± –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
                    <section class="payment-methods">
                        <h3 class="payment-methods__title">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø–ª–∞—Ç—ã</h3>
                        <div class="payment-methods__options">
                            <label class="payment-method">
                                <input 
                                    type="radio" 
                                    name="payment_type" 
                                    value="purchase" 
                                    {% if selected_payment_type == 'purchase' %}checked{% endif %}
                                    data-price="{{ product_item.get_final_price }}"
                                >
                                <span class="payment-method__content">
                                    <span class="payment-method__title">–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
                                    <span class="payment-method__price">{{ product_item.get_final_price|intcomma }} ‚ÇΩ</span>
                                </span>
                            </label>
                            {% if product_item.installment_12_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment12"
                                        {% if selected_payment_type == 'installment12' %}checked{% endif %}
                                        data-price="{{ product_item.installment_12_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">–†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤</span>
                                        <span class="payment-method__price">{{ product_item.installment_12_months|intcomma }} ‚ÇΩ/–º–µ—Å.</span>
                                    </span>
                                </label>
                            {% endif %}
                            {% if product_item.installment_24_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment24"
                                        {% if selected_payment_type == 'installment24' %}checked{% endif %}
                                        data-price="{{ product_item.installment_24_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">–†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ 24 –º–µ—Å—è—Ü–∞</span>
                                        <span class="payment-method__price">{{ product_item.installment_24_months|intcomma }} ‚ÇΩ/–º–µ—Å.</span>
                                    </span>
                                </label>
                            {% endif %}
                            {% if product_item.installment_48_months %}
                                <label class="payment-method">
                                    <input 
                                        type="radio" 
                                        name="payment_type" 
                                        value="installment48"
                                        {% if selected_payment_type == 'installment48' %}checked{% endif %}
                                        data-price="{{ product_item.installment_48_months }}"
                                    >
                                    <span class="payment-method__content">
                                        <span class="payment-method__title">–†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ 48 –º–µ—Å—è—Ü–µ–≤</span>
                                        <span class="payment-method__price">{{ product_item.installment_48_months|intcomma }} ‚ÇΩ/–º–µ—Å.</span>
                                    </span>
                                </label>
                            {% endif %}
                        </div>         
                    </section>
                    {% endif %}

                    <!-- –ë–ª–æ–∫ –∏—Ç–æ–≥–æ–≤ (–Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–æ–º –∏ —Ñ–æ—Ä–º–æ–π) -->
                    <aside class="summary summary--mobile">
                        <div class="summary__content">
                            <h3 class="summary__title">–ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
                            <div class="summary__section" id="equipmentSummaryMobile">
                                <h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>
                                <div class="summary__item">
                                    <span class="summary__item-name">{{ product_item.get_display_name }}</span>
                                    <span class="summary__item-value" id="summary-price-mobile">{{ product_item.get_price_display }}</span>
                                </div>
                            </div>
                            <div class="summary__total">
                                <h5 class="summary__total-title">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</h5>
                                <h5 class="summary__total-value" id="summary-total-mobile">{{ product_item.get_price_display }}</h5>
                            </div>
                        </div>
                    </aside>

                    <!-- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ -->
                    <section class="order-form__section">
                        <h3 class="order-form__section-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h3>
                        <noscript>
                            <div class="alert alert-danger">–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ñ–æ—Ä–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á—ë–Ω–Ω—ã–π JavaScript.</div>
                        </noscript>

                        <!-- üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã HTMX -->
                        <form class="order-form__form" 
                              id="orderForm" 
                              method="post" 
                              action="{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=product_item.id %}"
                              hx-post="{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=product_item.id %}"
                              hx-target="#orderFormContainer"
                              hx-swap="outerHTML"
                              hx-indicator="#submit-button"
                              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            {% csrf_token %}
                            <div class="order-form__fields">
                                <!-- –ò–º—è -->
                                <div class="order-form__field order-form__field--full-name">
                                    <label for="id_full_name" class="order-form__label">–í–∞—à–µ –∏–º—è</label>
                                    {{ form.full_name }}
                                    <div id="error_full_name" class="order-form__validation-message">
                                        {% if form.full_name.errors %}{{ form.full_name.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
                                <div class="order-form__field order-form__field--phone">
                                    <label for="id_phone" class="order-form__label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                                    {{ form.phone }}
                                    <div id="error_phone" class="order-form__validation-message">
                                        {% if form.phone.errors %}{{ form.phone.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥: –£–ª–∏—Ü–∞, –î–æ–º, –ö–≤–∞—Ä—Ç–∏—Ä–∞ -->
                                <div class="order-form__row--address">
                                    <!-- –£–ª–∏—Ü–∞ -->
                                    <div class="order-form__field order-form__field--street">
                                        <label for="id_street" class="order-form__label">–£–ª–∏—Ü–∞</label>
                                        {{ form.street }}
                                        <div id="error_street" class="order-form__validation-message">
                                            {% if form.street.errors %}{{ form.street.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                    <!-- –î–æ–º -->
                                    <div class="order-form__field order-form__field--house">
                                        <label for="id_house" class="order-form__label">–î–æ–º</label>
                                        {{ form.house }}
                                        <div id="error_house" class="order-form__validation-message">
                                            {% if form.house.errors %}{{ form.house.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                    <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∞ -->
                                    <div class="order-form__field order-form__field--apartment">
                                        <label for="id_apartment" class="order-form__label">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                                        {{ form.apartment }}
                                        <div id="error_apartment" class="order-form__validation-message">
                                            {% if form.apartment.errors %}{{ form.apartment.errors.0 }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                                <div class="order-form__field order-form__field--comments">
                                    <label for="id_comment" class="order-form__label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    {{ form.comment }}
                                    <div id="error_comment" class="order-form__validation-message">
                                        {% if form.comment.errors %}{{ form.comment.errors.0 }}{% endif %}
                                    </div>
                                </div>
                                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è (–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º) -->
                                {{ form.product_item_id }}
                                {{ form.payment_type }}
                                {{ form.tariff_id }}
                                {{ form.selected_equipment_ids }}
                                {{ form.equipment_payment_options }}
                                {{ form.selected_service_slugs }}
                                {{ form.selected_tv_package_ids }}
                                <!-- –û–±—â–∏–µ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
                                <div id="form-errors" class="error-container">
                                    {% if form.non_field_errors %}
                                        <ul class="errorlist">
                                            {% for error in form.non_field_errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- –°–æ–≥–ª–∞—Å–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ -->
                            <div class="order-form__field order-form__field--actions">
                                <div class="order-form__consent-text">
                                    –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å 
                                    <a target="_blank" class="order-form__link" href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" rel="noopener noreferrer">
                                        –£—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                    </a>
                                </div>
                                <button type="submit" class="order-form__submit" id="submit-button" disabled aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                            </div>
                        </form>
                    </section>
                </div>

                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Ç–æ–≥–∞–º–∏ (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞) -->
                <aside class="summary summary--desktop">
                    <div class="summary__content">
                        <h3 class="summary__title">–ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
                        <div class="summary__section" id="equipmentSummary">
                            <h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>
                            <div class="summary__item">
                                <span class="summary__item-name">{{ product_item.get_display_name }}</span>
                                <span class="summary__item-value" id="summary-price">{{ product_item.get_price_display }}</span>
                            </div>
                        </div>
                        <div class="summary__total">
                            <h5 class="summary__total-title">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</h5>
                            <h5 class="summary__total-value" id="summary-total">{{ product_item.get_price_display }}</h5>
                        </div>
                    </div>
                </aside>
            {% else %}
                <div class="alert alert-danger">
                    –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ–≤–∞—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä.
                    <a href="{% url 'equipments:product_list' locality_slug=locality.slug %}" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–¥–∫–ª—é—á–∞–µ–º HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/imask@7/dist/imask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const phoneInput = document.querySelector('#orderForm [name="phone"]');
    const submitButton = document.querySelector('#submit-button');
    const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
    const priceDisplay = document.querySelector('#current-price-display');
    const summaryPrice = document.querySelector('#summary-price');
    const summaryTotal = document.querySelector('#summary-total');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ JavaScript
    if (typeof IMask === 'undefined') {
        document.getElementById('form-errors').innerHTML = '<ul class="errorlist"><li>–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ñ–æ—Ä–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á—ë–Ω–Ω—ã–π JavaScript.</li></ul>';
        submitButton.disabled = true;
        return;
    }

    // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    let phoneMask = null;
    if (phoneInput) {
        phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false
        });
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function preparePhoneNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11 && ['7', '8'].includes(digits[0])) {
            return '+7' + digits.slice(1);
        }
        return null;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    function validateOrderForm() {
        const fullName = document.querySelector('#orderForm [name="full_name"]').value.trim();
        const phoneValid = phoneMask && preparePhoneNumber(phoneMask.unmaskedValue);
        submitButton.disabled = !(fullName.length >= 3 && phoneValid);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
    function updatePrice() {
        const selectedPayment = document.querySelector('input[name="payment_type"]:checked')?.value || 'purchase';
        const price = document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`)?.dataset.price || {{ product_item.get_final_price }};
        const isMonthly = selectedPayment !== 'purchase';
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(price) + ' ‚ÇΩ' + (isMonthly ? '/–º–µ—Å.' : '');
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
        priceDisplay.textContent = formattedPrice;
        summaryPrice.textContent = formattedPrice;
        summaryTotal.textContent = formattedPrice;
        // üî• –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –∏—Ç–æ–≥–æ–≤
        document.querySelector('#summary-price-mobile').textContent = formattedPrice;
        document.querySelector('#summary-total-mobile').textContent = formattedPrice;
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        document.querySelector('#orderForm [name="payment_type"]').value = selectedPayment;
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
        document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`).parentElement.classList.add('active');
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –≤–≤–æ–¥
    document.querySelectorAll('#orderForm [name="full_name"], #orderForm [name="phone"]').forEach(el => {
        el.addEventListener('input', validateOrderForm);
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', updatePrice);
    });

    // –ù–∞—á–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
    validateOrderForm();
    updatePrice();

    // üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è HTMX
    document.body.addEventListener('htmx:beforeSend', function(evt) {
        const btn = evt.detail.elt;
        if (btn.id === 'submit-button') {
            btn.disabled = true;
            btn.classList.add('order-form__submit--loading');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
    });
    document.body.addEventListener('htmx:afterSettle', function(evt) {
        const btn = evt.detail.elt;
        if (btn.id === 'submit-button') {
            btn.disabled = false;
            btn.classList.remove('order-form__submit--loading');
            btn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
        }
    });
});
</script>
{% endblock %}