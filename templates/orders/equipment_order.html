{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <div class="order-form__layout">
            {% if product_item.in_stock > 0 %}
                <div class="order-form__main">
                    <!-- Информация о товаре -->
                    <section class="product-info">
                        <div class="product-info__content">
                            <div class="product-info__image" id="productImageContainer">
                                {% with main_image=product_item.get_main_image %}
                                    {% if main_image %}
                                        <img src="{{ main_image.image.url }}" alt="{{ product_item.get_display_name }}" class="product-info__img" id="productImage">
                                    {% else %}
                                        <div class="product-info__img-placeholder" id="productImagePlaceholder">
                                            <span>Нет изображения</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="product-info__details">
                                <div class="product-info__header">
                                    <h3 class="product-info__title">
                                        <a href="{% url 'equipments:product_detail' locality_slug=locality.slug slug=product_item.slug %}" 
                                           class="product-info__link"
                                           title="Подробнее о {{ product_item.get_display_name }}">
                                            {{ product_item.get_display_name }}
                                        </a>
                                    </h3>
                                    <div class="product-info__price-inline">
                                        <div class="product-info__price-value" id="current-price-display">
                                            {{ product_item.get_price_display }}
                                        </div>
                                    </div>
                                </div>
                                {% if product_item.color %}
                                    <div class="product-info__color-selection">
                                        <h5 class="product-info__variant-title">Цвет</h5>
                                        <span>{{ product_item.color.name }}</span>
                                    </div>
                                {% endif %}
                                <!-- Способы оплаты -->
                                {% if product_item.installment_available %}
                                    <div class="product-info__payment-selection">
                                        <h5 class="product-info__variant-title">Способ оплаты</h5>
                                        <div class="payment-methods__options">
                                            <label class="payment-method">
                                                <input 
                                                    type="radio" 
                                                    name="payment_type" 
                                                    value="purchase" 
                                                    {% if selected_payment_type == 'purchase' %}checked{% endif %}
                                                    data-price="{{ product_item.get_final_price }}"
                                                >
                                                <span class="payment-method__content">
                                                    <span class="payment-method__title">Полная стоимость</span>
                                                    <span class="payment-method__price">{{ product_item.get_final_price|intcomma }} ₽</span>
                                                </span>
                                            </label>
                                            {% if product_item.installment_12_months %}
                                                <label class="payment-method">
                                                    <input 
                                                        type="radio" 
                                                        name="payment_type" 
                                                        value="installment12"
                                                        {% if selected_payment_type == 'installment12' %}checked{% endif %}
                                                        data-price="{{ product_item.installment_12_months }}"
                                                    >
                                                    <span class="payment-method__content">
                                                        <span class="payment-method__title">Рассрочка на 12 месяцев</span>
                                                        <span class="payment-method__price">{{ product_item.installment_12_months|intcomma }} ₽/мес.</span>
                                                    </span>
                                                </label>
                                            {% endif %}
                                            {% if product_item.installment_24_months %}
                                                <label class="payment-method">
                                                    <input 
                                                        type="radio" 
                                                        name="payment_type" 
                                                        value="installment24"
                                                        {% if selected_payment_type == 'installment24' %}checked{% endif %}
                                                        data-price="{{ product_item.installment_24_months }}"
                                                    >
                                                    <span class="payment-method__content">
                                                        <span class="payment-method__title">Рассрочка на 24 месяца</span>
                                                        <span class="payment-method__price">{{ product_item.installment_24_months|intcomma }} ₽/мес.</span>
                                                    </span>
                                                </label>
                                            {% endif %}
                                            {% if product_item.installment_48_months %}
                                                <label class="payment-method">
                                                    <input 
                                                        type="radio" 
                                                        name="payment_type" 
                                                        value="installment48"
                                                        {% if selected_payment_type == 'installment48' %}checked{% endif %}
                                                        data-price="{{ product_item.installment_48_months }}"
                                                    >
                                                    <span class="payment-method__content">
                                                        <span class="payment-method__title">Рассрочка на 48 месяцев</span>
                                                        <span class="payment-method__price">{{ product_item.installment_48_months|intcomma }} ₽/мес.</span>
                                                    </span>
                                                </label>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>

                    <!-- Форма заявки -->
                    <section class="order-form__section">
                        <h3 class="order-form__section-title">Оформление заявки</h3>
                        <noscript>
                            <div class="alert alert-danger">Для корректной работы формы требуется включённый JavaScript.</div>
                        </noscript>
                        <form class="order-form__form" id="orderForm" method="post" action="{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=product_item.id %}">
                            {% csrf_token %}
                            <!-- Поля формы -->
                            {{ form.as_p }}
                            <!-- Ошибки формы -->
                            <div id="form-errors" class="error-container">
                                {% if form.errors %}
                                    <ul class="errorlist">
                                        {% for field in form %}
                                            {% for error in field.errors %}
                                                <li>{{ field.label }}: {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <!-- Согласие и кнопка -->
                            <div class="order-form__field order-form__field--actions">
                                <div class="order-form__consent-text">
                                    Нажимая кнопку «Отправить заявку», вы соглашаетесь с 
                                    <a target="_blank" class="order-form__link" href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" rel="noopener noreferrer">
                                        Условиями обработки персональных данных
                                    </a>
                                </div>
                                <button type="submit" class="order-form__submit" id="submit-button" disabled aria-label="Отправить заявку на подключение">Отправить заявку</button>
                            </div>
                        </form>
                    </section>
                </div>

                <!-- Боковая панель с итогами (для десктопа) -->
                <aside class="summary summary--desktop">
                    <div class="summary__content">
                        <h3 class="summary__title">Заявка на оборудование</h3>
                        <div class="summary__section" id="equipmentSummary">
                            <h5 class="summary__section-title">Оборудование</h5>
                            <div class="summary__item">
                                <span class="summary__item-name">{{ product_item.get_display_name }}</span>
                                <span class="summary__item-value" id="summary-price">{{ product_item.get_price_display }}</span>
                            </div>
                        </div>
                        <div class="summary__total">
                            <h5 class="summary__total-title">Итого к оплате</h5>
                            <h5 class="summary__total-value" id="summary-total">{{ product_item.get_price_display }}</h5>
                        </div>
                    </div>
                </aside>
            {% else %}
                <div class="alert alert-danger">
                    Выбранная товарная позиция недоступна или отсутствует на складе. Пожалуйста, выберите другой товар.
                    <a href="{% url 'equipments:product_list' locality_slug=locality.slug %}" class="btn btn-primary">Вернуться к каталогу</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://unpkg.com/imask@7/dist/imask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const phoneInput = document.querySelector('#orderForm [name="phone"]');
    const submitButton = document.querySelector('#submit-button');
    const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
    const priceDisplay = document.querySelector('#current-price-display');
    const summaryPrice = document.querySelector('#summary-price');
    const summaryTotal = document.querySelector('#summary-total');

    // Проверка доступности JavaScript
    if (typeof IMask === 'undefined') {
        document.getElementById('form-errors').innerHTML = '<ul class="errorlist"><li>Для корректной работы формы требуется включённый JavaScript.</li></ul>';
        submitButton.disabled = true;
        return;
    }

    // Маска телефона
    let phoneMask = null;
    if (phoneInput) {
        phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false
        });
    }

    // Подготовка номера телефона
    function preparePhoneNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11 && ['7', '8'].includes(digits[0])) {
            return '+7' + digits.slice(1);
        }
        return null;
    }

    // Валидация формы
    function validateOrderForm() {
        const fullName = document.querySelector('#orderForm [name="full_name"]').value.trim();
        const phoneValid = phoneMask && preparePhoneNumber(phoneMask.unmaskedValue);
        submitButton.disabled = !(fullName.length >= 3 && phoneValid);
    }

    // Обновление цены
    function updatePrice() {
        const selectedPayment = document.querySelector('input[name="payment_type"]:checked')?.value || 'purchase';
        const price = document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`)?.dataset.price || {{ product_item.get_final_price }};
        const isMonthly = selectedPayment !== 'purchase';
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(price) + ' ₽' + (isMonthly ? '/мес.' : '');

        priceDisplay.textContent = formattedPrice;
        summaryPrice.textContent = formattedPrice;
        summaryTotal.textContent = formattedPrice;

        // Обновляем поле формы payment_type
        document.querySelector('#orderForm [name="payment_type"]').value = selectedPayment;

        // Удаляем active класс у всех и добавляем к выбранному
        paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
        document.querySelector(`input[name="payment_type"][value="${selectedPayment}"]`).parentElement.classList.add('active');
    }

    // Слушатели на ввод
    document.querySelectorAll('#orderForm [name="full_name"], #orderForm [name="phone"]').forEach(el => {
        el.addEventListener('input', validateOrderForm);
    });

    // Слушатели на выбор способа оплаты
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', updatePrice);
    });

    // Начальная валидация и обновление цены
    validateOrderForm();
    updatePrice();

    // Обработка отправки формы
    document.getElementById('orderForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Сброс ошибок
        document.querySelectorAll('.order-form__input, .order-form__textarea').forEach(el => {
            el.classList.remove('order-form__input--invalid');
        });
        document.querySelectorAll('.order-form__validation-message').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        document.getElementById('form-errors').innerHTML = '';

        const formData = new FormData(this);

        // Валидация телефона
        const phone = phoneMask ? preparePhoneNumber(phoneMask.unmaskedValue) : null;
        if (!phone) {
            const phoneField = document.querySelector('#phone');
            phoneField.classList.add('order-form__input--invalid');
            document.getElementById('error_phone').textContent = 'Введите корректный номер';
            document.getElementById('error_phone').style.display = 'block';
            return;
        }
        formData.set('phone', phone);

        // Валидация имени
        const fullName = formData.get('full_name').trim();
        if (fullName.length < 3) {
            document.querySelector('#name').classList.add('order-form__input--invalid');
            document.getElementById('error_full_name').textContent = 'Минимум 3 символа';
            document.getElementById('error_full_name').style.display = 'block';
            return;
        }

        submitButton.disabled = true;
        submitButton.classList.add('order-form__submit--loading');
        submitButton.innerHTML = 'Отправка...';

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();
            if (response.ok && data.success) {
                this.reset();
                if (phoneMask) phoneMask.updateValue();
                window.location.href = data.redirect_url;
            } else {
                const errorList = document.createElement('ul');
                errorList.className = 'errorlist';
                for (const [field, errors] of Object.entries(data.errors || {})) {
                    errors.forEach(err => {
                        const li = document.createElement('li');
                        li.textContent = err;
                        errorList.appendChild(li);
                        const fieldElement = document.querySelector(`#orderForm [name="${field}"]`);
                        if (fieldElement) {
                            fieldElement.classList.add('order-form__input--invalid');
                            const errorDiv = document.getElementById(`error_${field}`);
                            if (errorDiv) {
                                errorDiv.textContent = err;
                                errorDiv.style.display = 'block';
                            }
                        }
                    });
                }
                document.getElementById('form-errors').appendChild(errorList);
                document.getElementById('form-errors').scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) {
            console.error('Ошибка сети:', error);
            document.getElementById('form-errors').innerHTML = '<ul class="errorlist"><li>Ошибка соединения. Попробуйте позже.</li></ul>';
            document.getElementById('form-errors').scrollIntoView({ behavior: 'smooth' });
        } finally {
            submitButton.disabled = false;
            submitButton.classList.remove('order-form__submit--loading');
            submitButton.innerHTML = 'Отправить заявку';
        }
    });
});
</script>
{% endblock %}