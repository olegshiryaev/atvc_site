{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="order-form">
    <div class="order-form__container container">
        <div class="order-form__layout">
            <div class="order-form__main">
                <section class="tariff-info">
                    <div class="tariff-info__content">
                        <div class="tariff-info__details">
                            <h3 class="tariff-info__title">{{ tariff.name }}</h3>
                            {% if tariff.description %}
                                <p class="tariff-info__description">{{ tariff.description|safe }}</p>
                            {% endif %}
                            <div class="tariff-info__included">
                                <h4 class="tariff-info__included-title">–í —Ç–∞—Ä–∏—Ñ –≤–∫–ª—é—á–µ–Ω–æ:</h4>
                                <div class="tariff-info__badges">
                                    {% if tariff.speed %}
                                        <span class="tariff-info__badge tariff-info__badge--speed">
                                            <i class="bi bi-wifi"></i>
                                            –°–∫–æ—Ä–æ—Å—Ç—å: {{ tariff.speed }} –ú–±–∏—Ç/—Å
                                        </span>
                                    {% endif %}
                                    {% if tariff.total_channels %}
                                        <span class="tariff-info__badge tariff-info__badge--tv">
                                            <i class="bi bi-tv"></i>
                                            {{ tariff.total_channels }} –¢–í-–∫–∞–Ω–∞–ª–æ–≤
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="tariff-info__price">
                            <div class="tariff-info__price-value">
                                {{ tariff.get_actual_price }} ‚ÇΩ/–º–µ—Å.
                            </div>
                            {% if tariff.is_promo and tariff.promo_price and tariff.promo_months %}
                                <div class="tariff-info__promo-note">
                                    <small class="text-muted">
                                        –ü–æ—Å–ª–µ {{ tariff.promo_months }} –º–µ—Å. ‚Äî 
                                        <strong>{{ tariff.price }} ‚ÇΩ/–º–µ—Å.</strong>
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </section>

                {% if is_internet_tariff and tv_tariffs.exists %}
                <section class="tv-tariff-section" aria-hidden="false">
                    <h3 class="tv-tariff-section__title">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ</h3>
                    <p class="tv-tariff-section__description">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –Ω–∞ —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ ‚Äî –æ–Ω –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω –≤–º–µ—Å—Ç–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º</p>
                    <div class="tv-tariff-grid">
                        {% for tv_tariff in tv_tariffs %}
                            <article class="tv-tariff-card" data-id="{{ tv_tariff.id }}">
                                <div class="tv-tariff-card__header">
                                    <div class="tv-tariff-card__content-left">
                                        <div class="tv-tariff-card__info">
                                            <h5 class="tv-tariff-card__name">{{ tv_tariff.name }}</h5>
                                            <div class="tv-tariff-card__meta">
                                                <div class="tv-tariff-card__channels">
                                                    <i class="bi bi-tv"></i> {{ tv_tariff.channel_count_display }}
                                                </div>
                                                <a href="#"
                                                data-bs-toggle="modal"
                                                data-bs-target="#channelsModal-tariff-{{ tv_tariff.id }}"
                                                class="tv-tariff-card__channels-link"
                                                aria-label="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–Ω–∞–ª—ã —Ç–∞—Ä–∏—Ñ–∞ {{ tv_tariff.name }}">
                                                    –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tv-tariff-card__switch">
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="tv-tariff-checkbox-{{ tv_tariff.id }}"
                                                onchange="selectTVTariff(this, '{{ tv_tariff.id }}', {{ tv_tariff.get_actual_price }}, '{{ tv_tariff.name|escapejs }}', {{ tv_tariff.price }}, {{ tv_tariff.is_promo|yesno:'true,false' }}, {{ tv_tariff.promo_months|default:0 }}, {{ tv_tariff.connection_price }})">
                                            <label class="tv-tariff-card__label" for="tv-tariff-checkbox-{{ tv_tariff.id }}"></label>
                                        </div>
                                    </div>
                                </div>
                                <p class="tv-tariff-card__description">
                                    {{ tv_tariff.description|truncatewords:15|safe }}
                                </p>
                                <div class="tv-tariff-card__footer">
                                    <div class="tv-tariff-card__price">
                                        {{ tv_tariff.get_actual_price }} ‚ÇΩ/–º–µ—Å.
                                        {% if tv_tariff.is_promo and tv_tariff.promo_months %}
                                            <small>({{ tv_tariff.promo_months }} –º–µ—Å. –ø–æ –∞–∫—Ü–∏–∏)</small>
                                        {% endif %}
                                        {% if tv_tariff.connection_price > 0 %}
                                            <br><small>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: {{ tv_tariff.connection_price }} ‚ÇΩ</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </article>
                            {% include 'core/partials/channels_modal.html' with object=tv_tariff channels=tv_tariff.included_channels.all category_choices=TVChannel.CATEGORY_CHOICES modal_type="tariff" %}
                        {% endfor %}
                    </div>
                </section>
                {% else %}
                <section class="tv-tariff-section" style="display: none;" aria-hidden="true"></section>
                {% endif %}

                <section class="tv-packages" id="tv-packages-section" {% if not is_tv_tariff %}style="display: none; opacity: 0;" aria-hidden="true"{% else %}style="opacity: 1;" aria-hidden="false"{% endif %}>
                    <h3 class="tv-packages__title">–î–æ–±–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã –∫–∞–Ω–∞–ª–æ–≤</h3>
                    <p class="tv-packages__description">–î–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –∫–∞–Ω–∞–ª–æ–≤ –∫ –≤–∞—à–µ–º—É —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏—é.</p>
                    {% if tv_packages.exists %}
                    <div class="tv-packages__list">
                        {% for package in tv_packages %}
                            <article class="tv-package" data-id="{{ package.id }}" data-tariff-ids="{% for t in package.tariffs.all %}{{ t.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                                <div class="tv-package__content">
                                    <div class="tv-package__header">
                                        <div class="tv-package__content-left">
                                            <div class="tv-package__image-container">
                                                {% if package.image %}
                                                    <img src="{{ package.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ {{ package.name }}" class="tv-package__image">
                                                {% else %}
                                                    <div class="tv-package__image-placeholder" aria-hidden="true">
                                                        <span>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="tv-package__info">
                                                <h5 class="tv-package__name">{{ package.name }}</h5>
                                                <div class="tv-package__meta">
                                                    <div class="tv-package__channels">
                                                        <i class="bi bi-tv"></i> {{ package.channel_count_display }}
                                                    </div>
                                                    <a href="#"
                                                       data-bs-toggle="modal"
                                                       data-bs-target="#channelsModal-package-{{ package.id }}"
                                                       class="tv-package__channels-link"
                                                       aria-label="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–Ω–∞–ª—ã –ø–∞–∫–µ—Ç–∞ {{ package.name }}">
                                                        –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tv-package__switch-container">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input" type="checkbox"
                                                       id="package-{{ package.id }}"
                                                       onclick="updateTVPackage('{{ package.id }}', {{ package.price }})">
                                                <label class="tv-package__label" for="package-{{ package.id }}"></label>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="tv-package__description">{{ package.description|safe }}</p>
                                </div>
                                <div class="tv-package__footer">
                                    <div class="tv-package__price">{{ package.price }} ‚ÇΩ/–º–µ—Å.</div>
                                </div>
                            </article>
                            {% include 'core/partials/channels_modal.html' with object=package channels=package.channels.all modal_type="package" %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="tv-packages__empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.</p>
                    {% endif %}
                </section>

                {% if products.exists %}
                <section class="equipment">
                    <h3 class="equipment__title">–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
                    <p class="equipment__description">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –∞–±–æ–Ω–µ–Ω—Ç—Å–∫—É—é –ø–ª–∞—Ç—É.</p>
                    <div class="equipment__list">
                        {% for product_item in products %}
                            <article class="equipment__item" data-id="{{ product_item.id }}" data-price="{% if product_item.installment_available and product_item.installment_12_months %}{{ product_item.installment_12_months }}{% elif product_item.installment_available and product_item.installment_24_months %}{{ product_item.installment_24_months }}{% elif product_item.installment_available and product_item.installment_48_months %}{{ product_item.installment_48_months }}{% else %}{{ product_item.price }}{% endif %}">
                                <div class="equipment__content">
                                    <div class="equipment__header">
                                        <div class="equipment__image-container">
                                            {% if product_item.get_main_image %}
                                                <img src="{{ product_item.get_main_image.image.url }}" alt="{{ product_item.get_display_name }}" class="equipment__image">
                                            {% else %}
                                                <div class="equipment__image-placeholder" aria-hidden="true">
                                                    <svg class="equipment__image-icon" width="48" height="28" viewBox="0 0 48 28" fill="currentColor">
                                                        <rect x="2" y="2" width="44" height="24" rx="4" fill="#e5e7eb"/>
                                                        <path d="M8 10h8v8H8zm14 0h8v8h-8zm14 0h8v8h-8z" fill="#9ca3af"/>
                                                    </svg>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="equipment__info-group">
                                            <h5 class="equipment__name">{{ product_item.get_display_name }}</h5>
                                        </div>
                                        <div class="equipment__footer">
                                            <div class="equipment__price-block" {% if product_item.installment_available %}data-installment-available="true"{% endif %}>
                                                <div class="equipment__payment-label" id="label-{{ product_item.id }}">
                                                    {% if product_item.installment_available and product_item.installment_12_months %}
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.)
                                                    {% elif product_item.installment_available and product_item.installment_24_months %}
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)
                                                    {% elif product_item.installment_available and product_item.installment_48_months %}
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)
                                                    {% else %}
                                                        –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
                                                    {% endif %}
                                                </div>
                                                <div class="equipment__price-value" id="price-{{ product_item.id }}">
                                                    {% if product_item.installment_available and product_item.installment_12_months %}
                                                        {{ product_item.installment_12_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    {% elif product_item.installment_available and product_item.installment_24_months %}
                                                        {{ product_item.installment_24_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    {% elif product_item.installment_available and product_item.installment_48_months %}
                                                        {{ product_item.installment_48_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    {% else %}
                                                        {{ product_item.get_price_display }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="equipment__switch-container">
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input"
                                                        type="checkbox"
                                                        id="equipment-{{ product_item.id }}"
                                                        onchange="toggleEquipmentSelection(
                                                            '{{ product_item.id }}', 
                                                            this.checked, 
                                                            {{ product_item.price }}, 
                                                            {{ product_item.installment_12_months|default:'null' }}, 
                                                            {{ product_item.installment_24_months|default:'null' }}, 
                                                            {{ product_item.installment_48_months|default:'null' }}
                                                        )">
                                                    <label class="form-check-label" for="equipment-{{ product_item.id }}"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>
                            {% if product_item.installment_available %}
                            <div class="equipment-payment-modal fade" id="installmentModal-{{ product_item.id }}" tabindex="-1" aria-labelledby="installmentModalLabel-{{ product_item.id }}">
                                <div class="equipment-payment-modal__dialog">
                                    <div class="equipment-payment-modal__content">
                                        <div class="equipment-payment-modal__header">
                                            <h5 class="equipment-payment-modal__title" id="installmentModalLabel-{{ product_item.id }}">{{ product_item.get_display_name }}</h5>
                                            <button type="button" class="equipment-payment-modal__close" data-modal-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M18 6L6 18M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="equipment-payment-modal__body">
                                            {% if product_item.installment_available %}
                                                {% if product_item.installment_12_months %}
                                                <div class="equipment-payment-modal__option">
                                                    <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-{{ product_item.id }}" id="paymentOption-installment12-{{ product_item.id }}" value="installment12" checked>
                                                    <label class="equipment-payment-modal__option-label" for="paymentOption-installment12-{{ product_item.id }}">
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.) - {{ product_item.installment_12_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    </label>
                                                </div>
                                                {% endif %}
                                                {% if product_item.installment_24_months %}
                                                <div class="equipment-payment-modal__option">
                                                    <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-{{ product_item.id }}" id="paymentOption-installment24-{{ product_item.id }}" value="installment24">
                                                    <label class="equipment-payment-modal__option-label" for="paymentOption-installment24-{{ product_item.id }}">
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.) - {{ product_item.installment_24_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    </label>
                                                </div>
                                                {% endif %}
                                                {% if product_item.installment_48_months %}
                                                <div class="equipment-payment-modal__option">
                                                    <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-{{ product_item.id }}" id="paymentOption-installment48-{{ product_item.id }}" value="installment48">
                                                    <label class="equipment-payment-modal__option-label" for="paymentOption-installment48-{{ product_item.id }}">
                                                        –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.) - {{ product_item.installment_48_months|intcomma }} ‚ÇΩ/–º–µ—Å.
                                                    </label>
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                            <div class="equipment-payment-modal__option">
                                                <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-{{ product_item.id }}" id="paymentOption-purchase-{{ product_item.id }}" value="purchase">
                                                <label class="equipment-payment-modal__option-label" for="paymentOption-purchase-{{ product_item.id }}">
                                                    –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å - {{ product_item.get_price_display }}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="equipment-payment-modal__footer">
                                            <button type="button" class="equipment-payment-modal__button equipment-payment-modal__button--secondary" data-modal-close onclick="closeAndResetModal('{{ product_item.id }}')">–û—Ç–º–µ–Ω–∞</button>
                                            <button type="button" class="equipment-payment-modal__button equipment-payment-modal__button--primary" onclick="applyPaymentOption(
                                                '{{ product_item.id }}', 
                                                {{ product_item.price }}, 
                                                {{ product_item.installment_12_months|default:'null' }}, 
                                                {{ product_item.installment_24_months|default:'null' }}, 
                                                {{ product_item.installment_48_months|default:'null' }}
                                            )">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                {% if services.exists %}
                <section class="services">
                    <h3 class="services__title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                    <p class="services__description">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –≤–º–µ—Å—Ç–µ —Å –≤–∞—à–∏–º —Ç–∞—Ä–∏—Ñ–æ–º.</p>
                    <div class="services__list">
                        {% for service in services %}
                            <article class="services__item">
                                <div class="services__content">
                                    <div class="services__header">
                                        <h5 class="services__name">{{ service.name }}</h5>
                                        <div class="services__switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="service-{{ service.slug }}"
                                                    onclick="updateService('{{ service.slug }}', {{ service.price }})">
                                                <label class="services__label" for="{{ service.slug }}"></label>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="services__description">{{ service.description|safe }}</p>
                                    <div class="services__footer">
                                        <div class="services__price">{{ service.price }} ‚ÇΩ/–º–µ—Å.</div>
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <aside class="summary summary--mobile">
                    <div class="summary__content">
                        <h3 class="summary__title">–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
                        <div class="summary__section">
                            <h5 class="summary__section-title">–¢–∞—Ä–∏—Ñ</h5>
                            <div class="summary__item">
                                <span class="summary__item-name">{{ tariff.name }}</span>
                                <span class="summary__item-value">
                                    {{ tariff.get_actual_price|intcomma }} ‚ÇΩ/–º–µ—Å.
                                    {% if tariff.is_promo and tariff.promo_price and tariff.promo_months %}
                                        <br>(–≤ —Ç–µ—á–µ–Ω–∏–µ {{ tariff.promo_months }} –º–µ—Å., –∑–∞—Ç–µ–º ‚Äî {{ tariff.price }} ‚ÇΩ/–º–µ—Å.)
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        {% if not is_tv_tariff and tv_tariffs.exists %}
                        <div class="summary__section" id="tvTariffSummary">
                            <h5 class="summary__section-title">–¢–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ</h5>
                            <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                        </div>
                        {% endif %}

                        {% if products.exists %}
                        <div class="summary__section" id="equipmentSummary">
                            <h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>
                            <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                        </div>
                        {% endif %}

                        {% if services.exists %}
                        <div class="summary__section" id="servicesSummary">
                            <h5 class="summary__section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h5>
                            <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                        </div>
                        {% endif %}

                        {% if tv_packages.exists %}
                        <div class="summary__section" id="tvPackagesSummary">
                            <h5 class="summary__section-title">–ü–∞–∫–µ—Ç—ã –¢–í</h5>
                            <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                        </div>
                        {% endif %}

                        <div class="summary__section">
                            <div class="summary__item">
                                <span class="summary__item-name"><strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</strong></span>
                                <span class="summary__item-value summary-connection-price">
                                    {% if tariff.connection_price == 0 %}
                                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                                    {% else %}
                                        {{ tariff.connection_price|intcomma }} ‚ÇΩ
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <hr class="summary__divider">

                        <div class="summary__total">
                            <h5 class="summary__total-title">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</h5>
                            <h5 class="summary__total-value summary-total-price">{{ tariff.get_actual_price|add:tariff.connection_price|intcomma }} ‚ÇΩ</h5>
                        </div>

                        <div class="summary__breakdown">
                            <div class="summary__breakdown-item">
                                <span class="summary__breakdown-name">–ò–∑ –Ω–∏—Ö</span>
                            </div>
                            <div class="summary__breakdown-item summary__breakdown-item--monthly-price">
                                <span class="summary__breakdown-name">–ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞</span>
                                <span class="summary__breakdown-value summary-monthly-price">{{ tariff.get_actual_price|intcomma }} ‚ÇΩ/–º–µ—Å.</span>
                            </div>
                            <div class="summary__breakdown-item summary__breakdown-item--installment summary-installment-breakdown" style="display: none;">
                                <span class="summary__breakdown-name">–†–∞—Å—Å—Ä–æ—á–∫–∞</span>
                                <span class="summary__breakdown-value summary-installment-price">0 ‚ÇΩ/–º–µ—Å.</span>
                            </div>
                            <div class="summary__breakdown-item summary__breakdown-item--connection-price">
                                <span class="summary__breakdown-name">–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏</span>
                                <span class="summary__breakdown-value summary-connection-total-price">{{ tariff.connection_price|intcomma }} ‚ÇΩ</span>
                            </div>
                        </div>

                        <div class="summary__info">
                            <small>–ù–∞—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –í–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–∫–∏</small>
                        </div>
                    </div>
                </aside>

                <section class="order-form__section">
                    <h3 class="order-form__section-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h3>
                    <noscript>
                        <div class="alert alert-danger">–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ñ–æ—Ä–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á—ë–Ω–Ω—ã–π JavaScript.</div>
                    </noscript>

                    <!-- üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã HTMX -->
                    <div id="orderFormContainer">
                        <form class="order-form__form" 
                              id="orderForm" 
                              method="post" 
                              action="{{ submit_order_url }}"
                              hx-post="{{ submit_order_url }}"
                              hx-target="#orderFormContainer"
                              hx-swap="outerHTML"
                              hx-indicator="#submit-button"
                              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            {% csrf_token %}
                            <input type="hidden" name="tariff_ids" id="selected_tariff_ids" value="[{{ tariff.id }}]">
                            <input type="hidden" name="selected_equipment_ids" id="selected_equipment_ids" value="[]">
                            <input type="hidden" name="selected_service_slugs" id="selected_service_slugs" value="[]">
                            <input type="hidden" name="selected_tv_package_ids" id="selected_tv_package_ids" value="[]">
                            <input type="hidden" name="equipment_payment_options" id="equipment_payment_options" value="{}">
                            <input type="hidden" name="product_item_id" value="">
                            <input type="hidden" name="payment_type" value="">
                            <input type="hidden" id="total_equipment_cost" value="0">
                            <input type="hidden" id="total_services_cost" value="0">
                            <input type="hidden" id="total_tv_packages_cost" value="0">
                            <input type="hidden" id="total_price" value="0">

                            <div class="order-form__fields">
                                <div class="order-form__field order-form__field--full-name">
                                    <label for="name" class="order-form__label">–í–∞—à–µ –∏–º—è</label>
                                    <input type="text" name="full_name" class="order-form__input" id="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                                    <div id="error_full_name" class="order-form__validation-message"></div>
                                </div>

                                <div class="order-form__field order-form__field--phone">
                                    <label for="phone" class="order-form__label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                                    <input type="tel" name="phone" class="order-form__input" id="phone" required placeholder="+7 (___) ___-__-__">
                                    <div id="error_phone" class="order-form__validation-message"></div>
                                </div>

                                <div class="order-form__row--address">
                                    <div class="order-form__field order-form__field--street">
                                        <label for="street" class="order-form__label">–£–ª–∏—Ü–∞</label>
                                        <input type="text" name="street" class="order-form__input" id="street" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É">
                                        <div id="error_street" class="order-form__validation-message"></div>
                                    </div>
                                    <div class="order-form__field order-form__field--house">
                                        <label for="house" class="order-form__label">–î–æ–º</label>
                                        <input type="text" name="house" class="order-form__input" id="house" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–º–∞">
                                        <div id="error_house" class="order-form__validation-message"></div>
                                    </div>
                                    <div class="order-form__field order-form__field--apartment">
                                        <label for="apartment" class="order-form__label">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                                        <input type="text" name="apartment" class="order-form__input" id="apartment" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã">
                                        <div id="error_apartment" class="order-form__validation-message"></div>
                                    </div>
                                </div>

                                <div class="order-form__field order-form__field--comments">
                                    <label for="comments" class="order-form__label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <textarea name="comment" class="order-form__textarea" id="comments" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                                    <div id="error_comment" class="order-form__validation-message"></div>
                                </div>

                                <div id="form-errors" class="error-container"></div>

                                <div class="order-form__field order-form__field--actions">
                                    <small class="order-form__consent-text">
                                        –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å 
                                        <a target="_blank" class="order-form__link" href="{% url 'core:static_page' locality_slug=locality.slug slug='privacy-policy' %}" rel="noopener noreferrer">
                                            –£—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                        </a>
                                    </small>
                                    <!-- üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º ID –∫ –∫–Ω–æ–ø–∫–µ -->
                                    <button type="submit" class="order-form__submit" id="submit-button" disabled aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- üî• –ö–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
                </section>
            </div>

            <aside class="summary summary--desktop">
                <div class="summary__content">
                    <h3 class="summary__title">–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
                    <div class="summary__section">
                        <h5 class="summary__section-title">–¢–∞—Ä–∏—Ñ</h5>
                        <div class="summary__item">
                            <span class="summary__item-name">{{ tariff.name }}</span>
                            <span class="summary__item-value">
                                {{ tariff.get_actual_price|intcomma }} ‚ÇΩ/–º–µ—Å.
                                {% if tariff.is_promo and tariff.promo_price and tariff.promo_months %}
                                    <br>(–≤ —Ç–µ—á–µ–Ω–∏–µ {{ tariff.promo_months }} –º–µ—Å., –∑–∞—Ç–µ–º ‚Äî {{ tariff.price }} ‚ÇΩ/–º–µ—Å.)
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    {% if not is_tv_tariff and tv_tariffs.exists %}
                    <div class="summary__section" id="tvTariffSummary">
                        <h5 class="summary__section-title">–¢–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ</h5>
                        <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                    </div>
                    {% endif %}

                    {% if products.exists %}
                    <div class="summary__section" id="equipmentSummary">
                        <h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>
                        <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                    </div>
                    {% endif %}

                    {% if services.exists %}
                    <div class="summary__section" id="servicesSummary">
                        <h5 class="summary__section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h5>
                        <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                    </div>
                    {% endif %}

                    {% if tv_packages.exists %}
                    <div class="summary__section" id="tvPackagesSummary">
                        <h5 class="summary__section-title">–ü–∞–∫–µ—Ç—ã –¢–í</h5>
                        <div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                    </div>
                    {% endif %}

                    <div class="summary__section">
                        <div class="summary__item">
                            <span class="summary__item-name"><strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</strong></span>
                            <span class="summary__item-value summary-connection-price">
                                {% if tariff.connection_price == 0 %}
                                    –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                                {% else %}
                                    {{ tariff.connection_price|intcomma }} ‚ÇΩ
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <hr class="summary__divider">

                    <div class="summary__total">
                        <h5 class="summary__total-title">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</h5>
                        <h5 class="summary__total-value summary-total-price">{{ tariff.get_actual_price|add:tariff.connection_price|intcomma }} ‚ÇΩ</h5>
                    </div>

                    <div class="summary__breakdown">
                        <div class="summary__breakdown-item">
                            <span class="summary__breakdown-name">–ò–∑ –Ω–∏—Ö</span>
                        </div>
                        <div class="summary__breakdown-item summary__breakdown-item--monthly-price">
                            <span class="summary__breakdown-name">–ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞</span>
                            <span class="summary__breakdown-value summary-monthly-price">{{ tariff.get_actual_price|intcomma }} ‚ÇΩ/–º–µ—Å.</span>
                        </div>
                        <div class="summary__breakdown-item summary__breakdown-item--installment summary-installment-breakdown" style="display: none;">
                            <span class="summary__breakdown-name">–†–∞—Å—Å—Ä–æ—á–∫–∞</span>
                            <span class="summary__breakdown-value summary-installment-price">0 ‚ÇΩ/–º–µ—Å.</span>
                        </div>
                        <div class="summary__breakdown-item summary__breakdown-item--connection-price">
                            <span class="summary__breakdown-name">–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏</span>
                            <span class="summary__breakdown-value summary-connection-total-price">{{ tariff.connection_price|intcomma }} ‚ÇΩ</span>
                        </div>
                    </div>

                    <div class="summary__info">
                        <small>–ù–∞—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –í–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–∫–∏</small>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
    document.body.addEventListener('htmx:beforeSend', function(evt) {
        const btn = evt.detail.elt;
        if (btn.classList.contains('order-form__submit')) {
            btn.disabled = true;
            btn.classList.add('order-form__submit--loading');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
    });
    document.body.addEventListener('htmx:afterSettle', function(evt) {
        const btn = evt.detail.elt;
        if (btn.classList.contains('order-form__submit')) {
            btn.disabled = false;
            btn.classList.remove('order-form__submit--loading');
            btn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
        }
    });
    document.getElementById('submit-button').addEventListener('click', function() {
        console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É": —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã...');
        syncFormFields();
    });
</script>

<script>
    function updateAll(selector, text, property = 'textContent') {
        document.querySelectorAll(selector).forEach(el => {
            if (property.startsWith('style.')) {
                const styleProp = property.slice(6);
                el.style[styleProp] = text;
            } else {
                el[property] = text;
            }
        });
    }

    let selectedEquipment = {};
    let selectedServices = {};
    let selectedTVPackages = {};
    let selectedTVTariff = null;
    let totalServicesPrice = 0;
    let totalTVPackagesPrice = 0;
    let pendingPaymentOptions = {};
    const internetTariffId = {{ tariff.id }};
    const isTvTariff = {{ is_tv_tariff|yesno:"true,false" }};
    let originalEquipmentHTML = '';

    // –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // –ù–û–í–û–ï: –ö—ç—à –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ—É (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    const equipmentCache = {};

    function calculateTotal() {
        const tariffPrice = parseInt('{{ tariff.get_actual_price }}') || 0;
        const connectionPrice = parseInt('{{ tariff.connection_price }}') || 0;

        // –£—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –¢–í-—Ç–∞—Ä–∏—Ñ–∞ –∏ –µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ç–∞—Ä–∏—Ñ–æ–≤
        const tvTariffPrice = isTvTariff ? 0 : (selectedTVTariff ? selectedTVTariff.actual_price : 0);
        const tvConnectionPrice = isTvTariff ? 0 : (selectedTVTariff ? selectedTVTariff.connection_price : 0);

        // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: —Ç–∞—Ä–∏—Ñ + –¢–í-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const tariffConnectionPrice = connectionPrice + tvConnectionPrice;

        // –ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞: —Ç–∞—Ä–∏—Ñ—ã + —É—Å–ª—É–≥–∏ + –¢–í-–ø–∞–∫–µ—Ç—ã)
        const subscriptionPrice = tariffPrice + tvTariffPrice + totalServicesPrice + totalTVPackagesPrice;

        // –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
        const equipmentPurchasePrice = Object.values(selectedEquipment).reduce((sum, p) => {
            return sum + (p.paymentType === 'purchase' ? p.price : 0);
        }, 0);

        // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: —Ç–∞—Ä–∏—Ñ—ã + –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        const connectionTotalPrice = tariffConnectionPrice + equipmentPurchasePrice;

        // –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂)
        const installmentPrice = Object.values(selectedEquipment).reduce((sum, p) => {
            return sum + (
                p.paymentType === 'installment12' ||
                p.paymentType === 'installment24' ||
                p.paymentType === 'installment48'
                    ? p.price
                    : 0
            );
        }, 0);

        // –û–±—â–∞—è –µ–∂–µ–º–µ—Å—è—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è "–ò—Ç–æ–≥–æ")
        const monthlyPrice = subscriptionPrice + installmentPrice;

        // –û–±—â–∞—è —Å—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ (–µ–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ + –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü)
        const totalPrice = monthlyPrice + connectionTotalPrice;

        console.debug(`–†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–∞: subscriptionPrice=${subscriptionPrice}, installmentPrice=${installmentPrice}, connectionTotalPrice=${connectionTotalPrice}, monthlyPrice=${monthlyPrice}, totalPrice=${totalPrice}`);

        // –û–±–Ω–æ–≤–ª—è–µ–º DOM –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        updateAll('.summary-total-price', `${totalPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
        updateAll('.summary-connection-total-price', `${connectionTotalPrice.toLocaleString('ru-RU')} ‚ÇΩ`);

        // –¢–æ–ª—å–∫–æ –∞–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞ (–±–µ–∑ —Ä–∞—Å—Å—Ä–æ—á–∫–∏!)
        updateAll('.summary-monthly-price', `${subscriptionPrice.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.`);

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∞—Å—Å—Ä–æ—á–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ
        if (installmentPrice > 0 && Object.keys(selectedEquipment).length > 0) {
            const installmentItems = Object.values(selectedEquipment).filter(p =>
                p.paymentType === 'installment12' ||
                p.paymentType === 'installment24' ||
                p.paymentType === 'installment48'
            );
            let label = '–†–∞—Å—Å—Ä–æ—á–∫–∞';
            if (installmentItems.length === 1) {
                const type = installmentItems[0].paymentType;
                if (type === 'installment12') label = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.)';
                else if (type === 'installment24') label = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)';
                else if (type === 'installment48') label = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)';
            }
            updateAll('.summary-installment-price', `${installmentPrice.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.`);
            document.querySelectorAll('.summary-installment-breakdown').forEach(el => {
                const nameEl = el.querySelector('.summary__breakdown-name');
                if (nameEl) nameEl.textContent = label;
                el.style.display = 'flex';
            });
        } else {
            document.querySelectorAll('.summary-installment-breakdown').forEach(el => {
                el.style.display = 'none';
            });
            updateAll('.summary-installment-price', '0 ‚ÇΩ/–º–µ—Å.');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        const connectionPriceText = tariffConnectionPrice === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : `${tariffConnectionPrice.toLocaleString('ru-RU')} ‚ÇΩ`;
        updateAll('.summary-connection-price', connectionPriceText);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        document.getElementById('total_equipment_cost').value = equipmentPurchasePrice;
        document.getElementById('total_services_cost').value = totalServicesPrice;
        document.getElementById('total_tv_packages_cost').value = totalTVPackagesPrice;
        document.getElementById('total_price').value = totalPrice;
    }

    function updateEquipmentSummary() {
        const containers = document.querySelectorAll('#equipmentSummary');
        const html = Object.keys(selectedEquipment).length > 0
            ? `<h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>` +
            Object.entries(selectedEquipment).map(([id, item]) => {
                const priceDisplay = item.paymentType === 'purchase'
                    ? `${item.price.toLocaleString('ru-RU')} ‚ÇΩ`
                    : `${item.price.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.`;
                return `<div class="summary__item"><span class="summary__item-name">${item.name}</span><span class="summary__item-value">${priceDisplay}</span></div>`;
            }).join('')
            : `<h5 class="summary__section-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5><div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>`;
        containers.forEach(container => { container.innerHTML = html; });
    }

    function updateServicesSummary() {
        const containers = document.querySelectorAll('#servicesSummary');
        const html = Object.keys(selectedServices).length > 0
            ? `<h5 class="summary__section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h5>` +
            Object.entries(selectedServices).map(([slug, item]) =>
                `<div class="summary__item"><span class="summary__item-name">${item.name}</span><span class="summary__item-value">${item.price.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.</span></div>`
            ).join('')
            : `<h5 class="summary__section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h5><div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>`;
        containers.forEach(container => { container.innerHTML = html; });
    }

    function updateTVPackageSummary() {
        const containers = document.querySelectorAll('#tvPackagesSummary');
        const html = Object.keys(selectedTVPackages).length > 0
            ? `<h5 class="summary__section-title">–ü–∞–∫–µ—Ç—ã –¢–í</h5>` +
            Object.entries(selectedTVPackages).map(([id, item]) =>
                `<div class="summary__item"><span class="summary__item-name">${item.name}</span><span class="summary__item-value">${item.price.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.</span></div>`
            ).join('')
            : `<h5 class="summary__section-title">–ü–∞–∫–µ—Ç—ã –¢–í</h5><div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>`;
        containers.forEach(container => { container.innerHTML = html; });
    }

    function updateTVTariffSummary() {
        if (isTvTariff) return;
        const containers = document.querySelectorAll('#tvTariffSummary');
        if (containers.length === 0) return;
        let html = '';
        if (selectedTVTariff) {
            html = `
                <h5 class="summary__section-title">–¢–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ</h5>
                <div class="summary__item">
                    <span class="summary__item-name">${escapeHtml(selectedTVTariff.name)}</span>
                    <span class="summary__item-value">
                        ${selectedTVTariff.actual_price.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.
                        ${selectedTVTariff.is_promo ? `<br>(–≤ —Ç–µ—á–µ–Ω–∏–µ ${selectedTVTariff.promo_months} –º–µ—Å., –∑–∞—Ç–µ–º ‚Äî ${selectedTVTariff.original_price.toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.)` : ''}
                    </span>
                </div>
            `;
        } else {
            html = `<h5 class="summary__section-title">–¢–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ</h5><div class="summary__item summary__item--empty">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>`;
        }
        containers.forEach(container => { container.innerHTML = html; });
    }

    function filterTVPackages() {
        const tvPackages = document.querySelectorAll('.tv-package');
        const tvPackagesSection = document.getElementById('tv-packages-section');
        if (!tvPackagesSection) return;

        let hasCompatiblePackages = false;
        tvPackages.forEach(package => {
            const tariffIds = package.dataset.tariffIds ? package.dataset.tariffIds.split(',').map(id => parseInt(id.trim(), 10)).filter(id => !isNaN(id)) : [];
            const isCompatible = (selectedTVTariff && tariffIds.includes(parseInt(selectedTVTariff.id, 10))) || (isTvTariff && tariffIds.includes(internetTariffId));
            package.style.display = isCompatible ? 'block' : 'none';
            package.style.opacity = isCompatible ? '1' : '0';
            package.setAttribute('aria-hidden', isCompatible ? 'false' : 'true');
            if (isCompatible) {
                hasCompatiblePackages = true;
            }
            if (!isCompatible) {
                const checkbox = package.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    checkbox.checked = false;
                    delete selectedTVPackages[package.dataset.id];
                }
            }
        });

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —ç—Ç–æ –Ω–µ –¢–í-—Ç–∞—Ä–∏—Ñ
        tvPackagesSection.style.display = (hasCompatiblePackages || isTvTariff) ? 'block' : 'none';
        tvPackagesSection.style.opacity = (hasCompatiblePackages || isTvTariff) ? '1' : '0';
        tvPackagesSection.setAttribute('aria-hidden', (hasCompatiblePackages || isTvTariff) ? 'false' : 'true');

        if (!hasCompatiblePackages && !isTvTariff) {
            selectedTVPackages = {};
            totalTVPackagesPrice = 0;
            updateTVPackageSummary();
        }
    }

    function selectTVTariff(checkbox, id, actual_price, name, original_price, is_promo, promo_months, connection_price) {
        if (isTvTariff || !{{ tv_tariffs.exists|yesno:"true,false" }}) return;
        if (!checkbox.checked) {
            if (selectedTVTariff && selectedTVTariff.id === id) {
                selectedTVTariff = null;
            }
        } else {
            document.querySelectorAll('.tv-tariff-card input[type="checkbox"]').forEach(cb => {
                if (cb.id !== checkbox.id) {
                    cb.checked = false;
                }
            });
            selectedTVTariff = {
                id,
                actual_price: parseInt(actual_price),
                name: escapeHtml(name),
                original_price: parseInt(original_price),
                is_promo: is_promo,
                promo_months: parseInt(promo_months),
                connection_price: parseInt(connection_price)
            };
        }
        updateTVTariffSummary();
        filterTVPackages();
        calculateTotal();
        updateEquipmentList(selectedTVTariff ? selectedTVTariff.id : null);
    }

    function toggleEquipmentSelection(id, checked, purchasePrice, installment12Price, installment24Price, installment48Price) {
        const element = document.querySelector(`.equipment__item[data-id="${id}"]`);
        const name = element.querySelector('.equipment__name').textContent.trim();
        const labelElement = document.getElementById(`label-${id}`);
        const priceElement = document.getElementById(`price-${id}`);
        const checkbox = document.getElementById(`equipment-${id}`);
        const installmentAvailable = element.querySelector('.equipment__price-block')?.dataset.installmentAvailable === 'true';

        if (!checked) {
            element.classList.remove('selected');
            delete selectedEquipment[id];
            delete pendingPaymentOptions[id];
            updateEquipmentSummary();
            calculateTotal();
            return;
        }

        if (!installmentAvailable) {
            selectedEquipment[id] = { name, price: parseInt(purchasePrice), paymentType: 'purchase' };
            pendingPaymentOptions[id] = { name, price: parseInt(purchasePrice), paymentType: 'purchase' };
            labelElement.innerHTML = `–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å`;
            priceElement.textContent = `${parseInt(purchasePrice).toLocaleString('ru-RU')} ‚ÇΩ`;
            element.classList.add('selected');
            updateEquipmentSummary();
            calculateTotal();
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—Å—Ä–æ—á–∫—É –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤ –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
        let defaultPaymentType = 'installment12';
        let defaultPrice = installment12Price;
        let defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.)';

        if (!installment12Price || isNaN(parseInt(installment12Price))) {
            if (installment24Price && !isNaN(parseInt(installment24Price))) {
                defaultPaymentType = 'installment24';
                defaultPrice = installment24Price;
                defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)';
            } else if (installment48Price && !isNaN(parseInt(installment48Price))) {
                defaultPaymentType = 'installment48';
                defaultPrice = installment48Price;
                defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)';
            } else {
                defaultPaymentType = 'purchase';
                defaultPrice = purchasePrice;
                defaultLabel = '–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å';
            }
        }

        selectedEquipment[id] = { name, price: parseInt(defaultPrice), paymentType: defaultPaymentType };
        pendingPaymentOptions[id] = { name, price: parseInt(defaultPrice), paymentType: defaultPaymentType };
        labelElement.innerHTML = defaultLabel;
        priceElement.textContent = `${parseInt(defaultPrice).toLocaleString('ru-RU')} ${defaultPaymentType === 'purchase' ? '‚ÇΩ' : '‚ÇΩ/–º–µ—Å.'}`;
        element.classList.add('selected');

        const modal = document.getElementById(`installmentModal-${id}`);
        if (modal) {
            openEquipmentModal(modal);
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–¥–∏–æ–±–æ–∫—Å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const radio = modal.querySelector(`input[name="paymentOption-${id}"][value="${defaultPaymentType}"]`);
            if (radio) {
                radio.checked = true;
            }
        } else {
            console.error(`–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!`);
        }

        updateEquipmentSummary();
        calculateTotal();
    }

    function updateService(serviceSlug, price) {
        const checkbox = document.getElementById(`service-${serviceSlug}`);
        if (!checkbox) {
            console.error(`–ß–µ–∫–±–æ–∫—Å service-${serviceSlug} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            return;
        }
        const serviceItem = checkbox.closest('.services__item');
        const serviceName = serviceItem?.querySelector('.services__name')?.textContent.trim() || `–£—Å–ª—É–≥–∞ ${serviceSlug}`;
        if (checkbox.checked) {
            selectedServices[serviceSlug] = { 
                name: serviceName, 
                price: parseInt(price) 
            };
        } else {
            delete selectedServices[serviceSlug];
        }
        totalServicesPrice = Object.values(selectedServices).reduce((sum, s) => sum + s.price, 0);
        updateServicesSummary();
        calculateTotal();
    }

    function updateTVPackage(packageId, price) {
        if (!selectedTVTariff && !isTvTariff) {
            console.warn('–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –¢–í-–ø–∞–∫–µ—Ç –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–í-—Ç–∞—Ä–∏—Ñ–∞');
            const checkbox = document.getElementById(`package-${packageId}`);
            if (checkbox) checkbox.checked = false;
            return;
        }
        const packageElement = document.querySelector(`.tv-package[data-id="${packageId}"]`);
        const tariffIds = packageElement.dataset.tariffIds ? packageElement.dataset.tariffIds.split(',').map(id => parseInt(id.trim(), 10)).filter(id => !isNaN(id)) : [];
        const currentTariffId = isTvTariff ? {{ tariff.id }} : (selectedTVTariff ? selectedTVTariff.id : null);
        if (!tariffIds.includes(parseInt(currentTariffId, 10))) {
            console.warn(`–ü–∞–∫–µ—Ç ${packageId} –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å —Ç–∞—Ä–∏—Ñ–æ–º ${currentTariffId}`);
            const checkbox = document.getElementById(`package-${packageId}`);
            if (checkbox) checkbox.checked = false;
            return;
        }
        const checkbox = document.getElementById(`package-${packageId}`);
        const tvPackage = checkbox.closest('.tv-package');
        const name = tvPackage.querySelector('.tv-package__name')?.textContent.trim() || '–ü–∞–∫–µ—Ç –∫–∞–Ω–∞–ª–æ–≤';
        if (checkbox.checked) {
            selectedTVPackages[packageId] = { name, price: parseInt(price) };
        } else {
            delete selectedTVPackages[packageId];
        }
        totalTVPackagesPrice = Object.values(selectedTVPackages).reduce((sum, p) => sum + p.price, 0);
        updateTVPackageSummary();
        calculateTotal();
    }

    function openEquipmentModal(modal) {
        if (typeof modal === 'string') modal = document.getElementById(`installmentModal-${modal}`);
        if (!modal) return;
        modal.classList.add('show');
        modal.style.display = 'flex';
        modal.removeAttribute('aria-hidden');
        const modalId = modal.id;
        const productId = modalId.split('-').pop();
        modal.addEventListener('click', function closeOnBackdrop(e) {
            if (e.target === modal) {
                closeAndResetModal(productId);
                modal.removeEventListener('click', closeOnBackdrop);
            }
        });
        modal.querySelectorAll('[data-modal-close]').forEach(button => {
            button.addEventListener('click', () => {
                closeAndResetModal(productId);
            });
        });
        document.addEventListener('keydown', function closeOnEscape(e) {
            if (e.key === 'Escape') {
                closeAndResetModal(productId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        });
    }

    function applyPaymentOption(productId, purchasePrice, installment12Price, installment24Price, installment48Price) {
        const selectedOption = document.querySelector(`input[name="paymentOption-${productId}"]:checked`)?.value || 'installment12';
        const labelElement = document.getElementById(`label-${productId}`);
        const priceElement = document.getElementById(`price-${productId}`);
        const checkbox = document.getElementById(`equipment-${productId}`);
        const element = document.querySelector(`.equipment__item[data-id="${productId}"]`);

        let paymentType = 'installment12';
        let price = parseInt(installment12Price);
        let labelText = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.)';

        if (!installment12Price || isNaN(parseInt(installment12Price))) {
            if (installment24Price && !isNaN(parseInt(installment24Price)) && selectedOption === 'installment24') {
                paymentType = 'installment24';
                price = parseInt(installment24Price);
                labelText = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)';
            } else if (installment48Price && !isNaN(parseInt(installment48Price)) && selectedOption === 'installment48') {
                paymentType = 'installment48';
                price = parseInt(installment48Price);
                labelText = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)';
            } else {
                paymentType = 'purchase';
                price = parseInt(purchasePrice);
                labelText = '–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å';
            }
        } else if (selectedOption === 'installment24' && installment24Price && !isNaN(parseInt(installment24Price))) {
            paymentType = 'installment24';
            price = parseInt(installment24Price);
            labelText = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)';
        } else if (selectedOption === 'installment48' && installment48Price && !isNaN(parseInt(installment48Price))) {
            paymentType = 'installment48';
            price = parseInt(installment48Price);
            labelText = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)';
        } else if (selectedOption === 'purchase') {
            paymentType = 'purchase';
            price = parseInt(purchasePrice);
            labelText = '–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å';
        }

        if (isNaN(price)) {
            console.error(`–û—à–∏–±–∫–∞: price –¥–ª—è productId ${productId} –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: ${price}`);
            return;
        }

        const name = element.querySelector('.equipment__name').textContent.trim();
        console.debug(`–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è productId ${productId}: paymentType=${paymentType}, price=${price}, name=${name}`);

        pendingPaymentOptions[productId] = { paymentType, price, name };
        selectedEquipment[productId] = { name, price, paymentType };
        labelElement.innerHTML = `${labelText}`;
        priceElement.textContent = `${price.toLocaleString('ru-RU')} ${paymentType === 'purchase' ? '‚ÇΩ' : '‚ÇΩ/–º–µ—Å.'}`;

        updateEquipmentSummary();
        calculateTotal();
        closeEquipmentModal(document.getElementById(`installmentModal-${productId}`));

        if (checkbox) {
            checkbox.focus();
        }
    }

    function closeEquipmentModal(modal) {
        if (!modal) return;
        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.removeEventListener('click', () => {});
        document.removeEventListener('keydown', () => {});
    }

    function closeAndResetModal(productId) {
        const modal = document.getElementById(`installmentModal-${productId}`);
        const checkbox = document.getElementById(`equipment-${productId}`);
        const element = document.querySelector(`.equipment__item[data-id="${productId}"]`);
        if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none';
        }
        if (!pendingPaymentOptions[productId]) {
            if (checkbox) {
                checkbox.checked = false;
            }
            if (element) {
                element.classList.remove('selected');
            }
            delete selectedEquipment[productId];
        }
        delete pendingPaymentOptions[productId];
        updateEquipmentSummary();
        calculateTotal();
    }

    function syncFormFields() {
        const equipmentIds = Object.keys(selectedEquipment).filter(id => {
            const checkbox = document.getElementById(`equipment-${id}`);
            return checkbox && checkbox.checked;
        });
        const paymentOptions = Object.fromEntries(
            equipmentIds.map(id => [id, selectedEquipment[id].paymentType || 'purchase'])
        );
        document.getElementById('selected_equipment_ids').value = JSON.stringify(equipmentIds);
        document.getElementById('equipment_payment_options').value = JSON.stringify(paymentOptions);
        document.getElementById('selected_service_slugs').value = JSON.stringify(Object.keys(selectedServices));
        document.getElementById('selected_tv_package_ids').value = JSON.stringify(Object.keys(selectedTVPackages));
        const tariffIds = [internetTariffId];
        if (selectedTVTariff && !isTvTariff) {
            tariffIds.push(selectedTVTariff.id);
        }
        document.getElementById('selected_tariff_ids').value = JSON.stringify(tariffIds);
    }

    // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é updateEquipmentList –∑–¥–µ—Å—å, –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π
    async function updateEquipmentList(tvTariffId = null) {
        const equipmentSection = document.querySelector('.equipment__list');
        const equipmentTitle = document.querySelector('.equipment__title');
        const equipmentDescription = document.querySelector('.equipment__description');
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'loading-spinner';
        loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        equipmentSection.innerHTML = '';
        equipmentSection.appendChild(loadingSpinner);
        equipmentTitle.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...';
        equipmentDescription.style.display = 'none';

        try {
            // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ç–∞—Ä–∏—Ñ–∞
            let equipmentList = [];
            const internetTariffId = {{ tariff.id }};
            if (!equipmentCache[internetTariffId]) {
                const internetUrl = `/{{ locality.slug|escapejs }}/tariff/${internetTariffId}/equipment/`;
                const internetResponse = await fetch(internetUrl, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!internetResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞: ${internetResponse.status}`);
                }
                const internetData = await internetResponse.json();
                if (!internetData.success || !Array.isArray(internetData.equipment)) {
                    throw new Error(internetData.error || '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞');
                }
                equipmentCache[internetTariffId] = internetData.equipment;
            }
            equipmentList = [...equipmentCache[internetTariffId]];

            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –¢–í-—Ç–∞—Ä–∏—Ñ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            if (tvTariffId) {
                if (!equipmentCache[tvTariffId]) {
                    const tvUrl = `/{{ locality.slug|escapejs }}/tariff/${tvTariffId}/equipment/`;
                    const tvResponse = await fetch(tvUrl, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    if (!tvResponse.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –¢–í: ${tvResponse.status}`);
                    }
                    const tvData = await tvResponse.json();
                    if (!tvData.success || !Array.isArray(tvData.equipment)) {
                        throw new Error(tvData.error || '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¢–í');
                    }
                    equipmentCache[tvTariffId] = tvData.equipment;
                }
                equipmentList = [...equipmentList, ...equipmentCache[tvTariffId]];
            }

            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID (–∏—Å–ø–æ–ª—å–∑—É–µ–º Map)
            const uniqueEquipmentMap = new Map();
            equipmentList.forEach(item => {
                if (!uniqueEquipmentMap.has(item.id)) {
                    uniqueEquipmentMap.set(item.id, item);
                }
            });
            equipmentList = Array.from(uniqueEquipmentMap.values());

            // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            selectedEquipment = {};
            updateEquipmentSummary();
            calculateTotal();

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
            let newEquipmentHTML = '';
            equipmentList.forEach(item => {
                const hasImage = item.has_image;
                const imageUrl = item.image_url || '';
                const installmentAvailable = item.installment_available;
                const installment12 = item.installment_prices.installment12 || null;
                const installment24 = item.installment_prices.installment24 || null;
                const installment48 = item.installment_prices.installment48 || null;
                const escapedName = escapeHtml(item.name);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–∏–ø –æ–ø–ª–∞—Ç—ã –∏ —Ü–µ–Ω—É
                let defaultPaymentType = 'installment12';
                let defaultPrice = installment12;
                let defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.)';

                if (!installment12 || isNaN(parseInt(installment12))) {
                    if (installment24 && !isNaN(parseInt(installment24))) {
                        defaultPaymentType = 'installment24';
                        defaultPrice = installment24;
                        defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.)';
                    } else if (installment48 && !isNaN(parseInt(installment48))) {
                        defaultPaymentType = 'installment48';
                        defaultPrice = installment48;
                        defaultLabel = '–†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.)';
                    } else {
                        defaultPaymentType = 'purchase';
                        defaultPrice = item.price;
                        defaultLabel = '–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å';
                    }
                }

                newEquipmentHTML += `
                    <article class="equipment__item" data-id="${item.id}" data-price="${defaultPrice}">
                        <div class="equipment__content">
                            <div class="equipment__header">
                                <div class="equipment__image-container">
                                    ${hasImage ? `<img src="${imageUrl}" alt="${escapedName}" class="equipment__image">` : `
                                        <div class="equipment__image-placeholder" aria-hidden="true">
                                            <svg class="equipment__image-icon" width="48" height="28" viewBox="0 0 48 28" fill="currentColor">
                                                <rect x="2" y="2" width="44" height="24" rx="4" fill="#e5e7eb"/>
                                                <path d="M8 10h8v8H8zm14 0h8v8h-8zm14 0h8v8h-8z" fill="#9ca3af"/>
                                            </svg>
                                        </div>
                                    `}
                                </div>
                                <div class="equipment__info-group">
                                    <h5 class="equipment__name">${escapedName}</h5>
                                </div>
                                <div class="equipment__footer">
                                    <div class="equipment__price-block" ${installmentAvailable ? 'data-installment-available="true"' : ''}>
                                        <div class="equipment__payment-label" id="label-${item.id}">${defaultLabel}</div>
                                        <div class="equipment__price-value" id="price-${item.id}">${parseInt(defaultPrice).toLocaleString('ru-RU')} ${defaultPaymentType === 'purchase' ? '‚ÇΩ' : '‚ÇΩ/–º–µ—Å.'}</div>
                                    </div>
                                    <div class="equipment__switch-container">
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="equipment-${item.id}"
                                                onchange="toggleEquipmentSelection(
                                                    '${item.id}', 
                                                    this.checked, 
                                                    ${item.price}, 
                                                    ${installment12}, 
                                                    ${installment24}, 
                                                    ${installment48}
                                                )">
                                            <label class="form-check-label" for="equipment-${item.id}"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>
                    ${installmentAvailable ? `
                    <div class="equipment-payment-modal fade" id="installmentModal-${item.id}" tabindex="-1" aria-labelledby="installmentModalLabel-${item.id}">
                        <div class="equipment-payment-modal__dialog">
                            <div class="equipment-payment-modal__content">
                                <div class="equipment-payment-modal__header">
                                    <h5 class="equipment-payment-modal__title" id="installmentModalLabel-${item.id}">${escapedName}</h5>
                                    <button type="button" class="equipment-payment-modal__close" data-modal-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 6L6 18M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="equipment-payment-modal__body">
                                    ${installment12 ? `
                                    <div class="equipment-payment-modal__option">
                                        <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-${item.id}" id="paymentOption-installment12-${item.id}" value="installment12" checked>
                                        <label class="equipment-payment-modal__option-label" for="paymentOption-installment12-${item.id}">
                                            –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 12 –º–µ—Å.) - ${parseInt(installment12).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.
                                        </label>
                                    </div>` : ''}
                                    ${installment24 ? `
                                    <div class="equipment-payment-modal__option">
                                        <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-${item.id}" id="paymentOption-installment24-${item.id}" value="installment24">
                                        <label class="equipment-payment-modal__option-label" for="paymentOption-installment24-${item.id}">
                                            –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 24 –º–µ—Å.) - ${parseInt(installment24).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.
                                        </label>
                                    </div>` : ''}
                                    ${installment48 ? `
                                    <div class="equipment-payment-modal__option">
                                        <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-${item.id}" id="paymentOption-installment48-${item.id}" value="installment48">
                                        <label class="equipment-payment-modal__option-label" for="paymentOption-installment48-${item.id}">
                                            –†–∞—Å—Å—Ä–æ—á–∫–∞ (–Ω–∞ 48 –º–µ—Å.) - ${parseInt(installment48).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å.
                                        </label>
                                    </div>` : ''}
                                    <div class="equipment-payment-modal__option">
                                        <input class="equipment-payment-modal__option-radio" type="radio" name="paymentOption-${item.id}" id="paymentOption-purchase-${item.id}" value="purchase">
                                        <label class="equipment-payment-modal__option-label" for="paymentOption-purchase-${item.id}">
                                            –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å - ${item.price.toLocaleString('ru-RU')} ‚ÇΩ
                                        </label>
                                    </div>
                                </div>
                                <div class="equipment-payment-modal__footer">
                                    <button type="button" class="equipment-payment-modal__button equipment-payment-modal__button--secondary" data-modal-close onclick="closeAndResetModal('${item.id}')">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="button" class="equipment-payment-modal__button equipment-payment-modal__button--primary" onclick="applyPaymentOption(
                                        '${item.id}', 
                                        ${item.price}, 
                                        ${installment12}, 
                                        ${installment24}, 
                                        ${installment48}
                                    )">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>` : ''}
                `;
            });

            equipmentSection.innerHTML = newEquipmentHTML;
            equipmentTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'; // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º
            equipmentDescription.style.display = 'block';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
            equipmentSection.innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>';
            equipmentTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
            equipmentDescription.style.display = 'block';
        }
    }

    const phoneInput = document.querySelector('#orderForm [name="phone"]');
    let phoneMask = null;
    if (phoneInput) {
        phoneMask = IMask(phoneInput, {
            mask: '+{7}(000)000-00-00',
            lazy: false,
            placeholderChar: '_'
        });
    }

    function validateOrderForm() {
        const fullNameValid = document.querySelector('#orderForm [name="full_name"]').value.trim().length >= 3;
        const phoneValid = phoneMask && preparePhoneNumber(phoneMask.unmaskedValue) !== null;
        document.querySelector('#orderForm .order-form__submit').disabled = !(fullNameValid && phoneValid);
    }

    document.querySelectorAll('#orderForm [name="full_name"], #orderForm [name="phone"]').forEach(input => {
        input.addEventListener('input', validateOrderForm);
    });

    function preparePhoneNumber(phoneValue) {
        const digits = phoneValue.replace(/\D/g, '');
        if (digits.length === 11 && (digits.startsWith('7') || digits.startsWith('8'))) {
            return '+7' + digits.substring(1);
        }
        return null;
    }

    // üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–î–ê–õ–Ø–ï–ú –°–¢–ê–†–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´
    // document.getElementById('orderForm').addEventListener('submit', async function(e) { ... });

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            modal.style.display = 'flex';
            modal.removeAttribute('aria-hidden');
            modal.querySelector('[data-modal-close]')?.addEventListener('click', () => {
                modal.classList.remove('show');
                modal.style.display = 'none';
            });
            modal.addEventListener('click', function closeOnBackdrop(e) {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    modal.removeEventListener('click', closeOnBackdrop);
                }
            });
            document.addEventListener('keydown', function closeOnEscape(e) {
                if (e.key === 'Escape') {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    document.removeEventListener('keydown', closeOnEscape);
                }
            });
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º innerHTML
        const equipmentListElement = document.querySelector('.equipment__list');
        if (equipmentListElement) {
            originalEquipmentHTML = equipmentListElement.innerHTML;
        } else {
            originalEquipmentHTML = '';
            console.warn('–≠–ª–µ–º–µ–Ω—Ç .equipment__list –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –í–æ–∑–º–æ–∂–Ω–æ, –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ –Ω–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
        }

        validateOrderForm();
        calculateTotal();

        if (isTvTariff) {
            selectedTVTariff = {
                id: {{ tariff.id }},
                actual_price: {{ tariff.get_actual_price }},
                name: '{{ tariff.name|escapejs }}',
                original_price: {{ tariff.price }},
                is_promo: {{ tariff.is_promo|yesno:"true,false" }},
                promo_months: {{ tariff.promo_months|default:0 }}
            };
            document.getElementById('selected_tariff_ids').value = JSON.stringify([{{ tariff.id }}]);
            filterTVPackages();
            calculateTotal();
            updateEquipmentList({{ tariff.id }});
        }
    });
</script>
{% endblock %}