{% extends 'base.html' %}
{% load static %}
{% block title %}{{ current_item }} — {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Хлебные крошки -->
    {% include 'partials/page_header.html' with title=title %}

    <div class="product-detail-layout block product-detail">
        <!-- Левая часть: изображение и характеристики -->
        <main class="product-main">
            <div class="product-images-and-info">
                <!-- Галерея -->
                <div class="product__gallery gallery">
                    <!-- Основное изображение -->
                    <div class="gallery__imgs swiper product-gallery-main">
                        <div class="swiper-wrapper">
                            {% if current_item.images.exists %}
                                {% for image in current_item.images.all %}
                                    <div class="swiper-slide gallery__item">
                                        <img src="{{ image.image.url }}" alt="{{ current_item }}" class="gallery__item-img lazyloaded">
                                    </div>
                               {% endfor %}
                            {% else %}
                                    <div class="swiper-slide gallery__item" data-color="all">
                                    <img src="{% static 'images/no-image.png' %}" alt="Нет изображения" class="product-card__img img-fluid rounded">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if current_item.images.exists %}
                        <div class="gallery__bottom slider-navs">
                            <div class="gallery__thumbs swiper product-gallery-thumbs">
                                <div class="swiper-wrapper">
                                    {% for image in current_item.images.all %}
                                        <div class="swiper-slide gallery__thumbs-item" style="margin-right: 20px;" data-color="{{ image.color|default:'all' }}">
                                            <img src="{{ image.image.url }}" alt="Миниатюра {{ forloop.counter }}" class="gallery__thumbs-img">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Информация о товаре -->
                <div class="product-info">
                    {% if current_item.color %}
                        <div class="product-color">
                            <strong>Цвет:</strong> {{ current_item.color.name|lower }}
                        </div>
                    {% endif %}

                    <!-- Цветовые круги -->
                    {% if items.count > 1 %}
                        <div class="color-circles">
                            {% for variant in items %}
                                {% if variant.color %}
                                    <a href="{% url 'equipments:product_detail' locality_slug=locality_slug slug=variant.slug %}"
                                       class="color-circle {% if variant == current_item %}active{% endif %} {% if variant.in_stock <= 0 %}disabled{% endif %}"
                                       title="{{ variant.color.name }}"
                                       {% if variant == current_item %}aria-current="page"{% endif %}>
                                        <span class="circle" style="background-color: {{ variant.color.hex_code|default:'#cccccc' }};"></span>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Краткие характеристики -->
                    {% if current_item.product.smart_speaker or current_item.product.camera or current_item.product.router or current_item.product.tvbox %}
                        <div class="product-specs-short">
                            {% if current_item.product.smart_speaker %}
                                {% with s=current_item.product.smart_speaker %}
                                    {% if s.voice_assistant %}
                                        <div class="spec-item">
                                            <strong>Помощник</strong>
                                            <span>{{ s.voice_assistant }}</span>
                                        </div>
                                    {% endif %}
                                    {% if s.power_source %}
                                        <div class="spec-item">
                                            <strong>Питание</strong>
                                            <span>{{ s.power_source }}</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        <button type="button" class="link-more-specs" onclick="activateSpecsTab(event)">
                            Все характеристики →
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Табы: Описание / Характеристики -->
            {% with product=current_item.product %}
                {% if product.has_description or product.smart_speaker or product.camera or product.router or product.tvbox %}
                    <div class="product-tabs mt-5">
                        <div class="product-tabs-wrapper mb-3">
                            <ul class="nav nav-pills" id="productTabs">
                                {% if product.has_description %}
                                    <li>
                                        <button class="nav-link {% if not product.smart_speaker and not product.camera and not product.router and not product.tvbox %}active{% endif %}"
                                                data-tab="description">Описание</button>
                                    </li>
                                {% endif %}
                                {% if product.smart_speaker or product.camera or product.router or product.tvbox %}
                                    <li>
                                        <button class="nav-link {% if not product.has_description %}active{% endif %}"
                                                data-tab="specs">Характеристики</button>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>

                        <div class="tab-content" id="productTabsContent">
                            {% if product.has_description %}
                                <div class="tab-pane {% if not product.smart_speaker and not product.camera and not product.router and not product.tvbox %}active{% endif %}"
                                    id="description">
                                    {{ product.description|safe }}
                                </div>
                            {% endif %}

                            {% if product.smart_speaker or product.camera or product.router or product.tvbox %}
                                <div class="tab-pane {% if not product.has_description %}active{% endif %}" id="specs">
                                    {% if product.smart_speaker %}
                                        {% include "equipments/product/characteristics/smart_speaker.html" with speaker=product.smart_speaker %}
                                    {% elif product.camera %}
                                        {% include "equipments/product/characteristics/camera.html" with camera=product.camera %}
                                    {% elif product.router %}
                                        {% include "equipments/product/characteristics/router.html" with router=product.router %}
                                    {% elif product.tvbox %}
                                        {% include "equipments/product/characteristics/tvbox.html" with tvbox=product.tvbox %}
                                    {% else %}
                                        <p class="text-muted">Характеристики недоступны.</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </main>

        <!-- Правая панель: цена и кнопка -->
        <aside class="product-sidebar" id="product-sidebar">
            <div class="sidebar-content">
                <!-- Блок выбора способа оплаты -->
                <div class="payment-methods mt-3 border-top pt-3">
                    <h6 class="mb-2">Выберите вариант оплаты</h6>
                    <div class="payment-options">
                        <!-- Полная оплата -->
                        <label class="payment-option active">
                            <input type="radio" name="payment_method" value="purchase" checked data-price="{{ current_item.get_final_price }}">
                            <span class="payment-title">Полная стоимость</span>
                            <span class="payment-price">{{ current_item.get_price_display }}</span>
                        </label>

                        <!-- Рассрочка 12 месяцев -->
                        {% if current_item.installment_12_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment12" data-price="{{ current_item.installment_12_months }}">
                                <span class="payment-title">Рассрочка на 12 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_12_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        <!-- Рассрочка 24 месяца -->
                        {% if current_item.installment_24_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment24" data-price="{{ current_item.installment_24_months }}">
                                <span class="payment-title">Рассрочка на 24 месяца</span>
                                <span class="payment-price">{{ current_item.installment_24_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        <!-- Рассрочка 48 месяцев -->
                        {% if current_item.installment_48_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment48" data-price="{{ current_item.installment_48_months }}">
                                <span class="payment-title">Рассрочка на 48 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_48_months }} ₽/мес</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <div class="price-block">
                    <!-- Динамическая цена -->
                    <div class="current-price" id="current-price-display">
                        {{ current_item.get_price_display }}
                    </div>
                    {% if current_item.old_price %}
                        <div class="old-price">{{ current_item.old_price }} ₽</div>
                    {% endif %}
                </div>

                <a href="{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}?payment_type=purchase"
                   class="btn-order" id="order-button">
                    Заказать
                </a>
                {% if current_item.product.instruction %}
                    <a href="{% url 'equipments:download_instruction' locality_slug=locality_slug slug=current_item.product.slug %}"
                       class="link-download">
                        <i class="icon-download"></i> Скачать инструкцию
                    </a>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- Недавно просмотренные -->
    {% if recently_viewed %}
    <section class="products-slider-block block" data-block-slug="products-slider-block" data-block-appearance="">
        <div class="products-slider-block__header">
            <h2 class="products-slider-block__title block__title">Вы недавно смотрели</h2>
        </div>
        <div class="products-slider-block__wrapper">
            <div class="swiper swiper-initialized swiper-horizontal">
                <div class="swiper-wrapper">
                    {% for item in recently_viewed %}
                    <li class="product-card products-slider-block__item swiper-slide swiper-slide-active" data-product="{{ item.id }}" data-product-title="{{ item.name }}" data-product-price="{{ item.price }}" data-product-incatalog="1">
                        <a href="{% url 'equipments:product_detail' locality_slug=locality.slug slug=item.slug %}" class="product-card__wrapper">
                            <div class="product-card__img-wrap{% if not item.get_main_image %} no-image{% endif %}">
                                {% with main_image=item.get_main_image %}
                                    {% if main_image %}
                                        <img data-lazy-src="{{ main_image.image.url }}"  
                                            alt="{{ item.name|default:'Товар' }}" 
                                            class="product-card__img" 
                                            src="{{ main_image.image.url }}">
                                    {% else %}
                                    <div class="product-card__placeholder">
                                        <span class="product-card__no-image-label">Изображение отсутствует</span>
                                    </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <h6 class="product-card__title h6">{{ item }}</h6>
                        </a>
                        <div class="product-card__footer">
                            <div class="product-card__price h5">{{ item.get_price_display }}</div>
                            <div class="product-card__btn btn" data-add-product-cart="">В корзину</div>
                        </div>
                    </li>
                    {% endfor %}
                </div>
                <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
            </div>
            <div class="products-slider-block__navs slider-navs">
                <div class="slider-navs__prev swiper-button-disabled" tabindex="-1" role="button" aria-label="Previous slide" aria-disabled="true"></div>
                <div class="slider-navs__pag swiper-pagination-clickable swiper-pagination-bullets swiper-pagination-horizontal"><span class="swiper-pagination-bullet swiper-pagination-bullet-active" tabindex="0" role="button" aria-label="Go to slide 1" aria-current="true"></span><span class="swiper-pagination-bullet" tabindex="0" role="button" aria-label="Go to slide 2"></span></div>
                <div class="slider-navs__next" tabindex="0" role="button" aria-label="Next slide" aria-disabled="false"></div>
            </div>
        </div>
    </section>
    {% endif %}

</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // === Инициализация слайдера "Недавно просмотренные" ===
    const recentlyViewedSwiper = new Swiper('.products-slider-block .swiper', {
        slidesPerView: 1,
        spaceBetween: 16,
        navigation: {
            nextEl: '.products-slider-block .slider-navs__next',
            prevEl: '.products-slider-block .slider-navs__prev',
        },
        pagination: {
            el: '.products-slider-block .slider-navs__pag',
            clickable: true,
        },
        breakpoints: {
            576: { slidesPerView: 2, spaceBetween: 16 },
            768: { slidesPerView: 3, spaceBetween: 20 },
            992: { slidesPerView: 4, spaceBetween: 24 },
        },
    });

    // === Переключение табов (Описание / Характеристики) ===
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanes = document.querySelectorAll('.tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', function () {
            tabButtons.forEach(b => b.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    // Функция для перехода на вкладку "Характеристики"
    window.activateSpecsTab = function(e) {
        e.preventDefault();
        const specsButton = document.querySelector('[data-tab="specs"]');
        if (specsButton) {
            specsButton.click();
            document.getElementById('specs').scrollIntoView({ behavior: 'smooth' });
        }
    };

    // === Обработка выбора способа оплаты (покупка / рассрочка) ===
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const orderButton = document.getElementById('order-button');
    const priceDisplay = document.getElementById('current-price-display');

    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            const price = parseFloat(this.dataset.price);
            const isMonthly = this.value !== 'purchase';

            // Форматируем цену: 1 299 ₽
            const formattedPrice = new Intl.NumberFormat('ru-RU').format(price) + ' ₽' + (isMonthly ? '/мес.' : '');

            // Обновляем отображение цены
            priceDisplay.textContent = formattedPrice;

            // Обновляем ссылку кнопки "Заказать"
            const baseUrl = "{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}";
            orderButton.href = `${baseUrl}?payment_type=${this.value}`;

            // Обновляем визуальное выделение
            paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
            this.parentElement.classList.add('active');
        });
    });

    // === Инициализация: установка активного радио и отображения цены ===
    const initialRadio = document.querySelector('input[name="payment_method"]:checked');
    if (initialRadio) {
        const initialPrice = parseFloat(initialRadio.dataset.price);
        const isMonthly = initialRadio.value !== 'purchase';
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(initialPrice) + ' ₽' + (isMonthly ? '/мес.' : '');
        priceDisplay.textContent = formattedPrice;
    }
});
</script>
{% endblock %}