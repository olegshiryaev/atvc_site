{% extends 'base.html' %}
{% load static %}
{% block title %}{{ current_item }} — {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Хлебные крошки -->
    {% include 'partials/page_header.html' with title=title %}

    <div class="product-detail-layout block product-detail">
        <!-- Левая часть: изображение и характеристики -->
        <main class="product-main">
            <div class="product-images-and-info">
                <!-- Галерея -->
                <div class="product-gallery">
                    <!-- Основное изображение -->
                    <div class="product-gallery-main swiper">
                        <div class="swiper-wrapper">
                            {% for image in current_item.images.all %}
                                <div class="swiper-slide">
                                    <img src="{{ image.image.url }}" alt="{{ current_item }}" class="gallery-image">
                                </div>
                            {% empty %}
                                <div class="swiper-slide">
                                    <img src="{% static 'images/no-image.png' %}" alt="Нет изображения" class="gallery-image">
                                </div>
                            {% endfor %}
                        </div>
                        <!-- Кнопки навигации -->
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                        <!-- Пагинация -->
                        <div class="swiper-pagination"></div>
                    </div>

                    <!-- Миниатюры (под основным изображением) -->
                    <div class="product-gallery-thumbs swiper">
                        <div class="swiper-wrapper">
                            {% for image in current_item.images.all %}
                                <div class="swiper-slide thumb">
                                    <img src="{{ image.image.url }}" alt="Миниатюра" class="thumb-image">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Информация о товаре -->
                <div class="product-info">
                    {% if current_item.color %}
                        <div class="product-color">
                            <strong>Цвет:</strong> {{ current_item.color.name|lower }}
                        </div>
                    {% endif %}

                    <!-- Цветовые круги -->
                    {% if items.count > 1 %}
                        <div class="color-circles">
                            {% for variant in items %}
                                {% if variant.color %}
                                    <a href="{% url 'equipments:product_detail' locality_slug=locality_slug slug=variant.slug %}"
                                       class="color-circle {% if variant == current_item %}active{% endif %} {% if variant.in_stock <= 0 %}disabled{% endif %}"
                                       title="{{ variant.color.name }}"
                                       {% if variant == current_item %}aria-current="page"{% endif %}>
                                        <span class="circle" style="background-color: {{ variant.color.hex_code|default:'#cccccc' }};"></span>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Краткие характеристики -->
                    {% if current_item.product.smart_speaker or current_item.product.camera or current_item.product.router or current_item.product.tvbox %}
                        <div class="product-specs-short">
                            {% if current_item.product.smart_speaker %}
                                {% with s=current_item.product.smart_speaker %}
                                    {% if s.voice_assistant %}
                                        <div class="spec-item">
                                            <strong>Помощник</strong>
                                            <span>{{ s.voice_assistant }}</span>
                                        </div>
                                    {% endif %}
                                    {% if s.power_source %}
                                        <div class="spec-item">
                                            <strong>Питание</strong>
                                            <span>{{ s.power_source }}</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        <button type="button" class="link-more-specs" onclick="activateSpecsTab(event)">
                            Все характеристики →
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Табы: Описание / Характеристики -->
            {% if product.has_description or product.camera or product.router or product.smart_speaker or product.tvbox %}
            <div class="product-tabs mt-5">
                <div class="product-tabs-wrapper mb-3">
                    <ul class="nav nav-pills" id="productTabs">
                        {% if product.has_description %}
                        <li>
                            <button class="nav-link active" data-tab="description">Описание</button>
                        </li>
                        {% endif %}
                        {% if product.camera or product.router or product.smart_speaker or product.tvbox %}
                        <li>
                            <button class="nav-link" data-tab="specs">Характеристики</button>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <div class="tab-content" id="productTabsContent">
                    {% if product.has_description %}
                    <!-- Описание -->
                    <div class="tab-pane active" id="description">
                        {{ current_item.product.description|safe }}
                    </div>
                    {% endif %}

                    <!-- Характеристики -->
                    <div class="tab-pane" id="specs">
                        {% if current_item.product.smart_speaker %}
                            {% include "equipments/product/characteristics/smart_speaker.html" with speaker=current_item.product.smart_speaker %}
                        {% elif current_item.product.camera %}
                            {% include "equipments/product/characteristics/camera.html" with camera=current_item.product.camera %}
                        {% elif current_item.product.router %}
                            {% include "equipments/product/characteristics/router.html" with router=current_item.product.router %}
                        {% elif current_item.product.tvbox %}
                            {% include "equipments/product/characteristics/tvbox.html" with tvbox=current_item.product.tvbox %}
                        {% else %}
                            <p class="text-muted">Характеристики недоступны.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>

        <!-- Правая панель: цена и кнопка -->
        <aside class="product-sidebar" id="product-sidebar">
            <div class="sidebar-content">
                <!-- Блок выбора способа оплаты -->
                <div class="payment-methods mt-3 border-top pt-3">
                    <h6 class="mb-2">Выберите вариант оплаты</h6>
                    <div class="payment-options">
                        <!-- Полная оплата -->
                        <label class="payment-option active">
                            <input type="radio" name="payment_method" value="purchase" checked data-price="{{ current_item.get_final_price }}">
                            <span class="payment-title">Полная стоимость</span>
                            <span class="payment-price">{{ current_item.get_price_display }}</span>
                        </label>

                        <!-- Рассрочка 12 месяцев -->
                        {% if current_item.installment_12_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment12" data-price="{{ current_item.installment_12_months }}">
                                <span class="payment-title">Рассрочка на 12 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_12_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        <!-- Рассрочка 24 месяца -->
                        {% if current_item.installment_24_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment24" data-price="{{ current_item.installment_24_months }}">
                                <span class="payment-title">Рассрочка на 24 месяца</span>
                                <span class="payment-price">{{ current_item.installment_24_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        <!-- Рассрочка 48 месяцев -->
                        {% if current_item.installment_48_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment48" data-price="{{ current_item.installment_48_months }}">
                                <span class="payment-title">Рассрочка на 48 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_48_months }} ₽/мес</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <div class="price-block">
                    <!-- Динамическая цена -->
                    <div class="current-price" id="current-price-display">
                        {{ current_item.get_price_display }}
                    </div>
                    {% if current_item.old_price %}
                        <div class="old-price">{{ current_item.old_price }} ₽</div>
                    {% endif %}
                </div>

                <a href="{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}?payment_type=purchase"
                   class="btn-order" id="order-button">
                    Заказать
                </a>
                {% if current_item.product.instruction %}
                    <a href="{% url 'equipments:download_instruction' locality_slug=locality_slug slug=current_item.product.slug %}"
                       class="link-download">
                        <i class="icon-download"></i> Скачать инструкцию
                    </a>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- Недавно просмотренные -->
    {% if recently_viewed %}
        <section class="recently-viewed">
            <h2>Вы недавно смотрели</h2>
            <div class="swiper">
                <div class="swiper-wrapper">
                    {% for item in recently_viewed %}
                        <div class="swiper-slide">
                            <a href="{% url 'equipments:product_detail' locality_slug=locality_slug slug=item.slug %}">
                                <img src="{{ item.get_main_image.image.url }}" alt="{{ item }}">
                                <h6>{{ item }}</h6>
                                <div class="price">{{ item.get_price_display }}</div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanes = document.querySelectorAll('.tab-pane');
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const orderButton = document.getElementById('order-button');
    const priceDisplay = document.getElementById('current-price-display');

    // Обработка переключения табов
    tabButtons.forEach(button => {
        button.addEventListener('click', function () {
            tabButtons.forEach(b => b.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    window.activateSpecsTab = function(e) {
        e.preventDefault();
        const specsButton = document.querySelector('[data-tab="specs"]');
        specsButton.click();
        document.getElementById('specs').scrollIntoView({ behavior: 'smooth' });
    };

    // Обработка выбора способа оплаты
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            // Обновляем отображаемую цену
            const price = this.dataset.price;
            const isMonthly = this.value !== 'purchase';
            priceDisplay.textContent = new Intl.NumberFormat('ru-RU').format(price) + ' ₽' + (isMonthly ? '/мес.' : '');
            
            // Обновляем URL кнопки "Заказать"
            const baseUrl = "{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}";
            orderButton.href = `${baseUrl}?payment_type=${this.value}`;
            
            // Удаляем active класс у всех и добавляем к выбранному
            paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
            this.parentElement.classList.add('active');
        });
    });
});
</script>
{% endblock %}