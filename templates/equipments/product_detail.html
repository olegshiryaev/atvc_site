{% extends 'base.html' %}
{% load static %}
{% block title %}{{ current_item }} — {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Хлебные крошки -->
    {% include 'partials/page_header.html' with title=title %}

    <div class="product-detail-layout block product-detail">
        <!-- Левая часть: изображение и характеристики -->
        <main class="product-main">
            <div class="product-images-and-info">
                <!-- Галерея -->
                <div class="product__gallery gallery">
                    {% if current_item.has_images and current_item.images.all|length > 1 %}
                        <!-- СЛУЧАЙ: 2+ ИЗОБРАЖЕНИЯ → Swiper с миниатюрами -->
                        <div class="gallery__imgs swiper product-gallery-main">
                            <div class="swiper-wrapper">
                                {% for image in current_item.images.all %}
                                    <div class="swiper-slide gallery__item" role="group" aria-label="Изображение {{ forloop.counter }} из {{ current_item.images.count }}">
                                        <img src="{{ image.image.url }}" alt="{{ current_item }} - изображение {{ forloop.counter }}" class="gallery__item-img" loading="lazy">
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-button-next"></div>
                            <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
                        </div>

                        <div class="gallery__bottom slider-navs">
                            <div class="gallery__thumbs swiper product-gallery-thumbs">
                                <div class="swiper-wrapper">
                                    {% for image in current_item.images.all %}
                                        <div class="swiper-slide gallery__thumbs-item" data-color="{{ image.color|default:'all' }}" role="button" aria-label="Выбрать изображение {{ forloop.counter }}">
                                            <img src="{{ image.image.url }}" alt="Миниатюра {{ forloop.counter }}" class="gallery__thumbs-img" loading="eager">
                                        </div>
                                    {% endfor %}
                                </div>
                                <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
                            </div>
                        </div>
                    {% else %}
                        <!-- СЛУЧАЙ: 0 или 1 ИЗОБРАЖЕНИЕ → Просто изображение без Swiper -->
                        <div class="gallery__single-img">
                            <img src="{% if current_item.has_images and current_item.images.first %}{{ current_item.images.first.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
                                 alt="{% if current_item.has_images %}{{ current_item }}{% else %}Нет изображения{% endif %}"
                                 class="gallery__item-img"
                                 loading="lazy">
                        </div>
                    {% endif %}
                </div>

                <!-- Информация о товаре -->
                <div class="product-info">
                    {% if current_item.color %}
                        <div class="product-color">
                            <strong>Цвет:</strong> {{ current_item.color.name|lower }}
                        </div>
                    {% endif %}

                    <!-- Цветовые круги -->
                    {% if items.count > 1 %}
                        <div class="color-circles">
                            {% for variant in items %}
                                {% if variant.color %}
                                    <a href="{% url 'equipments:product_detail' locality_slug=locality_slug slug=variant.slug %}"
                                    class="color-circle {% if variant == current_item %}active{% endif %} {% if variant.in_stock <= 0 %}disabled{% endif %}"
                                    title="{{ variant.color.name }}"
                                    {% if variant == current_item %}aria-current="page"{% endif %}>
                                        <span class="circle" style="background-color: {{ variant.color.hex_code|default:'#cccccc' }};"></span>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Краткие характеристики -->
                    {% if current_item.product.smart_speaker or current_item.product.camera or current_item.product.router or current_item.product.tvbox %}
                        <h6 class="product-specs-title">Характеристики:</h6>
                        <!-- Краткие характеристики -->
                        <div class="product-specs-short">
                            {% if current_item.product.smart_speaker %}
                                {% with s=current_item.product.smart_speaker %}
                                    {% if s.voice_assistant %}
                                        <div class="spec-item">
                                            <strong>Голосовой помощник</strong>
                                            <span class="spec-dots"></span>
                                            <span>{{ s.voice_assistant }}</span>
                                        </div>
                                    {% endif %}
                                    {% if s.power_source %}
                                        <div class="spec-item">
                                            <strong>Питание</strong>
                                            <span class="spec-dots"></span>
                                            <span>{{ s.power_source }}</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        <button type="button" class="link-more-specs" onclick="activateSpecsTab(event)">
                            Все характеристики →
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Табы: Описание / Характеристики -->
            {% with product=current_item.product %}
                {% if product.has_description or product.smart_speaker or product.camera or product.router or product.tvbox %}
                    <div class="product-tabs mt-5">
                        <div class="product-tabs-wrapper mb-3">
                            <ul class="nav nav-pills" id="productTabs">
                                {% if product.has_description %}
                                    <li>
                                        <button class="nav-link active" data-tab="description">Описание</button>
                                    </li>
                                {% endif %}
                                {% if product.smart_speaker or product.camera or product.router or product.tvbox %}
                                    <li>
                                        <button class="nav-link {% if not product.has_description %}active{% endif %}"
                                                data-tab="specs">Характеристики</button>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>

                        <div class="tab-content" id="productTabsContent">
                            {% if product.has_description %}
                                <div class="tab-pane active" id="description">
                                    {{ product.description|safe }}
                                </div>
                            {% endif %}

                            {% if product.smart_speaker or product.camera or product.router or product.tvbox %}
                                <div class="tab-pane {% if not product.has_description %}active{% endif %}" id="specs">
                                    {% if product.smart_speaker %}
                                        {% include "equipments/product/characteristics/smart_speaker.html" with speaker=product.smart_speaker %}
                                    {% elif product.camera %}
                                        {% include "equipments/product/characteristics/camera.html" with camera=product.camera %}
                                    {% elif product.router %}
                                        {% include "equipments/product/characteristics/router.html" with router=product.router %}
                                    {% elif product.tvbox %}
                                        {% include "equipments/product/characteristics/tvbox.html" with tvbox=product.tvbox %}
                                    {% else %}
                                        <p class="text-muted">Характеристики недоступны.</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </main>

        <!-- Правая панель: цена и кнопка -->
        <aside class="product-sidebar" id="product-sidebar">
            <div class="sidebar-content">
                <!-- Блок выбора способа оплаты -->
                <div class="payment-methods mt-3 border-top pt-3">
                    <h6 class="mb-2">Выберите вариант оплаты</h6>
                    <div class="payment-options">
                        <!-- Полная оплата -->
                        <label class="payment-option active">
                            <input type="radio" name="payment_method" value="purchase" checked data-price="{{ current_item.get_final_price }}">
                            <span class="payment-title">Полная стоимость</span>
                            <span class="payment-price">{{ current_item.get_price_display }}</span>
                        </label>

                        {% if current_item.installment_12_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment12" data-price="{{ current_item.installment_12_months }}">
                                <span class="payment-title">Рассрочка на 12 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_12_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        {% if current_item.installment_24_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment24" data-price="{{ current_item.installment_24_months }}">
                                <span class="payment-title">Рассрочка на 24 месяца</span>
                                <span class="payment-price">{{ current_item.installment_24_months }} ₽/мес</span>
                            </label>
                        {% endif %}

                        {% if current_item.installment_48_months %}
                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="installment48" data-price="{{ current_item.installment_48_months }}">
                                <span class="payment-title">Рассрочка на 48 месяцев</span>
                                <span class="payment-price">{{ current_item.installment_48_months }} ₽/мес</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <div class="price-block">
                    <div class="current-price" id="current-price-display">
                        {{ current_item.get_price_display }}
                    </div>
                    {% if current_item.old_price %}
                        <div class="old-price">{{ current_item.old_price }} ₽</div>
                    {% endif %}
                </div>

                <a href="{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}?payment_type=purchase"
                   class="btn-order btn" id="order-button">
                    Заказать
                </a>
                {% if current_item.product.instruction %}
                    <a href="{% url 'equipments:download_instruction' locality_slug=locality_slug slug=current_item.product.slug %}"
                       class="link-download">
                        <i class="icon-download"></i> Скачать инструкцию
                    </a>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- Недавно просмотренные -->
    {% if recently_viewed %}
    <section class="products-slider-block block">
        <div class="products-slider-block__header">
            <h2 class="products-slider-block__title block__title">Вы недавно смотрели</h2>
        </div>
        <div class="products-slider-block__wrapper">
            <div class="swiper">
                <div class="swiper-wrapper">
                    {% for item in recently_viewed %}
                        <div class="product-card products-slider-block__item swiper-slide">
                            <a href="{% url 'equipments:product_detail' locality_slug=locality.slug slug=item.slug %}" class="product-card__wrapper">
                                <div class="product-card__img-wrap{% if not item.get_main_image %} no-image{% endif %}">
                                    {% if item.get_main_image %}
                                        <img src="{{ item.get_main_image.image.url }}" alt="{{ item.name }}" class="product-card__img" loading="lazy">
                                    {% else %}
                                        <div class="product-card__placeholder">
                                            <span class="product-card__no-image-label">Изображение отсутствует</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <h6 class="product-card__title h6">{{ item }}</h6>
                            </a>
                            <div class="product-card__footer">
                                <div class="product-card__price h5">{{ item.get_price_display }}</div>
                                <button class="product-card__btn btn" onclick="window.location.href='{% url 'orders:equipment_order' locality_slug=locality.slug product_item_id=item.id %}'">
                                    Заказать
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="products-slider-block__navs slider-navs">
                    <div class="slider-navs__prev"></div>
                    <div class="slider-navs__pag"></div>
                    <div class="slider-navs__next"></div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
(function () {
    const initProductPage = () => {
        // === Инициализация галереи (только если 2+ изображения) ===
        const galleryMain = document.querySelector('.product-gallery-main');
        const galleryThumbs = document.querySelector('.product-gallery-thumbs');
        const images = document.querySelectorAll('.gallery__item-img, .gallery__thumbs-img');

        if (galleryMain && galleryThumbs) {
            let loadedImages = 0;

            const initSwipers = () => {
                // Удаляем дублирующиеся элементы swiper-notification
                const notifications = document.querySelectorAll('.swiper-notification');
                notifications.forEach((n, i) => i > 0 && n.remove());

                // Инициализация миниатюр
                const thumbsSwiper = new Swiper(galleryThumbs, {
                    spaceBetween: 8,
                    slidesPerView: 'auto',
                    freeMode: true,
                    watchSlidesProgress: true,
                    centerInsufficientSlides: true,
                    breakpoints: {
                        768: { slidesPerView: 'auto', spaceBetween: 8 },
                        600: { slidesPerView: 'auto', spaceBetween: 6 },
                        400: { slidesPerView: 'auto', spaceBetween: 6 },
                        320: { slidesPerView: 'auto', spaceBetween: 4 }
                    },
                    on: {
                        init: swiper => {
                            console.log('Thumbs Swiper initialized');
                            swiper.update();
                        },
                        resize: swiper => {
                            console.log('Thumbs Swiper resized');
                            swiper.update();
                        }
                    }
                });

                // Инициализация главного слайдера
                const mainSwiper = new Swiper(galleryMain, {
                    spaceBetween: 10,
                    slidesPerView: 1,
                    autoHeight: true,
                    thumbs: { swiper: thumbsSwiper },
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    },
                    on: {
                        init: swiper => {
                            console.log('Main Swiper initialized');
                            swiper.update();
                        },
                        imagesReady: () => console.log('Main Swiper: images loaded'),
                        resize: swiper => {
                            console.log('Main Swiper resized');
                            swiper.update();
                        }
                    }
                });
            };

            // Если нет изображений — инициализируем сразу
            if (images.length === 0) {
                initSwipers();
                return;
            }

            // Подсчёт загруженных изображений
            images.forEach(img => {
                if (img.complete) {
                    loadedImages++;
                } else {
                    img.addEventListener('load', () => {
                        loadedImages++;
                        if (loadedImages >= images.length) {
                            initSwipers();
                        }
                    });
                    img.addEventListener('error', () => {
                        loadedImages++;
                        if (loadedImages >= images.length) {
                            initSwipers();
                        }
                    });
                }
            });

            // Проверяем сразу, если все изображения уже загружены
            if (loadedImages >= images.length) {
                initSwipers();
            }
        }

        // === Слайдер "Недавно просмотренные" ===
        const recentSwiperEl = document.querySelector('.products-slider-block .swiper');
        if (recentSwiperEl) {
            new Swiper(recentSwiperEl, {
                slidesPerView: 1,
                spaceBetween: 16,
                navigation: {
                    nextEl: '.products-slider-block .slider-navs__next',
                    prevEl: '.products-slider-block .slider-navs__prev',
                },
                pagination: {
                    el: '.products-slider-block .slider-navs__pag',
                    clickable: true,
                },
                breakpoints: {
                    576: { slidesPerView: 2, spaceBetween: 16 },
                    768: { slidesPerView: 3, spaceBetween: 20 },
                    992: { slidesPerView: 4, spaceBetween: 24 },
                },
            });
        }

        // === Переключение табов ===
        document.querySelectorAll('[data-tab]').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                button.classList.add('active');
                const targetTab = document.getElementById(button.dataset.tab);
                if (targetTab) targetTab.classList.add('active');
            });
        });

        // Автоматическая активация первого таба при загрузке
        const firstTabBtn = document.querySelector('#productTabs .nav-link');
        if (firstTabBtn && !document.querySelector('#productTabs .nav-link.active')) {
            firstTabBtn.classList.add('active');
            const firstTab = document.getElementById(firstTabBtn.dataset.tab);
            if (firstTab) firstTab.classList.add('active');
        }

        // === Выбор способа оплаты ===
        const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
        const orderButton = document.getElementById('order-button');
        const priceDisplay = document.getElementById('current-price-display');

        if (orderButton && priceDisplay && paymentRadios.length > 0) {
            const baseUrl = orderButton.dataset.baseUrl ||
                "{% url 'orders:equipment_order' locality_slug=locality_slug product_item_id=current_item.id %}";

            const updatePriceAndButton = (radio) => {
                const price = parseFloat(radio.dataset.price);
                const isMonthly = radio.value !== 'purchase';
                const formattedPrice = new Intl.NumberFormat('ru-RU').format(price) + ' ₽' + (isMonthly ? '/мес.' : '');

                priceDisplay.style.opacity = '0';
                setTimeout(() => {
                    priceDisplay.textContent = formattedPrice;
                    priceDisplay.style.opacity = '1';
                }, 300);

                orderButton.href = `${baseUrl}?payment_type=${radio.value}`;
                paymentRadios.forEach(r => r.parentElement.classList.remove('active'));
                radio.parentElement.classList.add('active');
            };

            // Инициализация активного радио
            const activeRadio = document.querySelector('input[name="payment_method"]:checked');
            if (activeRadio) {
                updatePriceAndButton(activeRadio);
            }

            // Обработчики на изменение
            paymentRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    updatePriceAndButton(radio);
                });
            });
        }

        // === Функция для кнопки "Все характеристики" ===
        window.activateSpecsTab = function(event) {
            const specsTabBtn = document.querySelector('[data-tab="specs"]');
            const specsTabPane = document.getElementById('specs');

            if (specsTabBtn && specsTabPane) {
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                specsTabBtn.classList.add('active');
                specsTabPane.classList.add('active');
                specsTabPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };
    };

    // Запуск при полной загрузке DOM
    document.addEventListener('DOMContentLoaded', initProductPage);
})();
</script>
{% endblock %}