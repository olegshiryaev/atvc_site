{% extends 'base.html' %}

{% block content %}
<section class="news-section">
    <div class="container">
        {% include 'partials/page_header.html' with title=title %}

        <!-- Сетка новостей -->
        <div class="news-grid" id="news-container">
            {% for news in page_obj %}
            <div class="news-grid__item">
                {% include 'news/partials/news_card.html' with news=news is_preview=False %}
            </div>
            {% endfor %}
        </div>

        <!-- Кнопка "Читать ещё" -->
        {% if has_more_news %}
        <div class="text-center">
            <button id="load-more-btn" 
                    class="load-more-btn"
                    data-next-page="2"
                    data-city-slug="{{ locality.slug }}"
                    aria-label="Загрузить больше новостей">
                Читать ещё
            </button>
        </div>
        {% endif %}
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loadMoreBtn = document.getElementById('load-more-btn');
        const newsContainer = document.getElementById('news-container');
    
        if (!loadMoreBtn) {
            console.log('Кнопка "Читать ещё" не найдена');
            return;
        }
    
        loadMoreBtn.addEventListener('click', async () => {
            const nextPage = loadMoreBtn.getAttribute('data-next-page');
            const citySlug = loadMoreBtn.getAttribute('data-city-slug');
            const url = `/${citySlug}/news/load-more/?page=${nextPage}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
    
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
    
                if (data.html) {
                    const temp = document.createElement('div');
                    temp.innerHTML = data.html;

                    const newCards = Array.from(temp.children);

                    // Добавляем анимационный класс ПЕРЕД вставкой в DOM
                    newCards.forEach(card => {
                        card.classList.add('animate-in');
                    });

                    // Вставляем карточки
                    newCards.forEach(card => {
                        newsContainer.appendChild(card);
                    });

                    // Запускаем анимацию через 10мс
                    setTimeout(() => {
                        newCards.forEach(card => {
                            card.classList.remove('animate-in');
                        });
                    }, 10);
                }
    
                loadMoreBtn.setAttribute('data-next-page', parseInt(nextPage) + 1);
    
                if (!data.has_more_news) {
                    loadMoreBtn.remove();
                }
    
            } catch (error) {
                console.error('Ошибка при загрузке новостей:', error);
                alert('Произошла ошибка при загрузке новостей. Попробуйте позже.');
            }
        });
    });
</script>
{% endblock %}