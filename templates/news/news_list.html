{% extends 'base.html' %}

{% block content %}
<section class="news-section">
    <div class="bg-white w-100">
        <div class="container">
            {% include 'partials/page_header.html' with title=title %}

            <!-- Сетка новостей -->
            <div class="row g-4" id="news-container">
                {% for news in news_list %}
                <div class="col-12 col-sm-6 col-lg-4">
                    {% include 'news/partials/news_card.html' with news=news is_preview=False %}
                </div>
                {% endfor %}
            </div>

            <!-- Кнопка "Читать ещё" -->
            {% if has_more_news %}
            <div class="text-center mt-5 mb-5">
                <button id="load-more-btn" 
                        class="btn btn-primary fw-semibold px-4 py-2 transition-colors duration-300"
                        data-next-page="2"
                        data-city-slug="{{ locality.slug }}"
                        aria-label="Загрузить больше новостей">
                    Читать ещё
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loadMoreBtn = document.getElementById('load-more-btn');
        const newsContainer = document.getElementById('news-container');
    
        if (!loadMoreBtn) return;
    
        loadMoreBtn.addEventListener('click', async () => {
            const nextPage = loadMoreBtn.getAttribute('data-next-page');
            const citySlug = loadMoreBtn.getAttribute('data-city-slug');
            const url = `{% url 'news:load_more_news' locality.slug %}?page=${nextPage}`;
    
            try {
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
    
                const data = await response.json();
    
                // Если есть HTML — добавляем его
                if (data.html) {
                    const temp = document.createElement('div');
                    temp.innerHTML = data.html;
    
                    // Добавляем каждую колонку с новостью
                    Array.from(temp.children).forEach(card => {
                        newsContainer.appendChild(card);
                    });
                }
    
                // Обновляем номер страницы
                loadMoreBtn.setAttribute('data-next-page', parseInt(nextPage) + 1);
    
                // Убираем кнопку, если больше нет новостей
                if (!data.has_more_news) {
                    loadMoreBtn.remove();
                }
    
            } catch (error) {
                console.error('Ошибка при загрузке новостей:', error);
            }
        });
    });
</script>
{% endblock %}